<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Key Controller | PAPI Central</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Space+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        
        .key-slot {
            background: rgba(0, 242, 234, 0.05);
            border: 2px dashed rgba(0, 242, 234, 0.3);
            transition: all 0.3s;
        }
        
        .key-slot.filled {
            background: rgba(0, 242, 234, 0.1);
            border: 2px solid rgba(0, 242, 234, 0.5);
        }
        
        .key-slot.active {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(0, 242, 234, 0.4); }
            50% { box-shadow: 0 0 20px 5px rgba(0, 242, 234, 0.2); }
        }
        
        .app-tag {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(217, 70, 239, 0.2);
            border: 1px solid rgba(217, 70, 239, 0.4);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            color: #d946ef;
        }
        
        .mono { font-family: 'Space Mono', monospace; }
    </style>
</head>
<body class="p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="glass-card p-6 mb-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-white flex items-center gap-3">
                        <i class="fas fa-key text-cyan-400"></i>
                        Key Controller
                    </h1>
                    <p class="text-gray-400 mt-2">Central API key management for all PAPI apps</p>
                </div>
                <div class="text-right">
                    <div class="text-sm text-gray-400">Status</div>
                    <div class="text-xl font-bold text-emerald-400 flex items-center gap-2">
                        <div class="w-3 h-3 bg-emerald-400 rounded-full animate-pulse"></div>
                        ACTIVE
                    </div>
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="glass-card p-6 mb-6 border-l-4 border-cyan-400">
            <h3 class="text-lg font-bold text-white mb-3 flex items-center gap-2">
                <i class="fas fa-lightbulb text-yellow-400"></i>
                How It Works
            </h3>
            <ol class="space-y-2 text-gray-300 text-sm">
                <li><strong class="text-cyan-400">1.</strong> Add your API keys below (OpenAI, Claude, Gemini)</li>
                <li><strong class="text-cyan-400">2.</strong> Type the exact filename of an app (e.g., "ai-assistant-pro.html")</li>
                <li><strong class="text-cyan-400">3.</strong> Assign which key that app should use</li>
                <li><strong class="text-cyan-400">4.</strong> The app automatically loads the key when opened!</li>
            </ol>
            <div class="mt-4 p-3 bg-purple-900/20 border border-purple-500/30 rounded-lg">
                <p class="text-purple-300 text-sm">
                    <i class="fas fa-shield-check mr-2"></i>
                    <strong>Secure:</strong> Keys stored in your browser only. No server uploads.
                </p>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-6">
            <!-- OpenAI Keys -->
            <div class="glass-card p-6">
                <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                    <i class="fab fa-openai text-green-400"></i>
                    OpenAI Keys
                </h2>
                <div class="space-y-3">
                    <div id="openai-keys"></div>
                    <button onclick="addOpenAIKeySlot()" class="w-full py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-plus mr-2"></i>Add Key Slot
                    </button>
                </div>
            </div>

            <!-- Claude & Gemini -->
            <div class="space-y-6">
                <!-- Claude -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-brain text-purple-400"></i>
                        Claude Key
                    </h2>
                    <input type="password" id="claude-key" placeholder="sk-ant-..." 
                           class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-purple-400 focus:outline-none mono text-sm">
                    <button onclick="saveClaudeKey()" class="w-full mt-3 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-medium transition-colors">
                        Save Claude Key
                    </button>
                </div>

                <!-- Gemini -->
                <div class="glass-card p-6">
                    <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-gem text-blue-400"></i>
                        Gemini Key
                    </h2>
                    <input type="password" id="gemini-key" placeholder="AIza..." 
                           class="w-full px-4 py-3 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-blue-400 focus:outline-none mono text-sm">
                    <button onclick="saveGeminiKey()" class="w-full mt-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium transition-colors">
                        Save Gemini Key
                    </button>
                </div>
            </div>
        </div>

        <!-- App Assignments -->
        <div class="glass-card p-6 mt-6">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-link text-cyan-400"></i>
                App Key Assignments
            </h2>
            <div class="mb-4 p-4 bg-cyan-900/20 border border-cyan-500/30 rounded-lg">
                <p class="text-cyan-300 text-sm mb-2"><strong>Register an app:</strong></p>
                <div class="flex gap-2">
                    <input type="text" id="app-name" placeholder="app-filename.html" 
                           class="flex-1 px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-cyan-400 focus:outline-none text-sm">
                    <select id="key-assignment" class="px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white focus:border-cyan-400 focus:outline-none">
                        <option value="auto">Auto-Rotate</option>
                        <option value="key1">OpenAI Key 1</option>
                        <option value="key2">OpenAI Key 2</option>
                        <option value="key3">OpenAI Key 3</option>
                        <option value="key4">OpenAI Key 4</option>
                        <option value="claude">Claude</option>
                        <option value="gemini">Gemini</option>
                    </select>
                    <button onclick="assignKey()" class="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-medium transition-colors">
                        <i class="fas fa-save mr-2"></i>Assign
                    </button>
                </div>
            </div>
            <div id="app-assignments" class="space-y-2"></div>
        </div>

        <!-- Test Section -->
        <div class="glass-card p-6 mt-6 border-l-4 border-emerald-400">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i class="fas fa-vial text-emerald-400"></i>
                Test Keys
            </h2>
            <div class="flex gap-2">
                <input type="text" id="test-message" placeholder="Type a test message..." 
                       class="flex-1 px-4 py-2 bg-white/5 border border-white/10 rounded-lg text-white placeholder-gray-500 focus:border-emerald-400 focus:outline-none">
                <button onclick="testOpenAI()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-medium transition-colors">
                    <i class="fas fa-flask mr-2"></i>Test OpenAI
                </button>
            </div>
            <div id="test-result" class="mt-4 p-4 bg-white/5 rounded-lg hidden">
                <div class="text-sm text-gray-400 mb-2">Response:</div>
                <div id="test-response" class="text-white text-sm mono"></div>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid md:grid-cols-3 gap-4 mt-6">
            <div class="glass-card p-4 text-center">
                <div class="text-3xl font-bold text-cyan-400" id="total-keys">0</div>
                <div class="text-gray-400 text-sm mt-1">Total Keys</div>
            </div>
            <div class="glass-card p-4 text-center">
                <div class="text-3xl font-bold text-purple-400" id="total-apps">0</div>
                <div class="text-gray-400 text-sm mt-1">Apps Registered</div>
            </div>
            <div class="glass-card p-4 text-center">
                <div class="text-3xl font-bold text-emerald-400" id="total-calls">0</div>
                <div class="text-gray-400 text-sm mt-1">API Calls</div>
            </div>
        </div>
    </div>

    <script>
        // Initialize
        let openaiKeyCount = 0;
        
        function init() {
            loadOpenAIKeys();
            loadClaudeKey();
            loadGeminiKey();
            loadAppAssignments();
            updateStats();
        }
        
        function loadOpenAIKeys() {
            const container = document.getElementById('openai-keys');
            container.innerHTML = '';
            
            for (let i = 1; i <= 4; i++) {
                const key = localStorage.getItem(`openai_api_key${i}`);
                if (key || i <= 2) { // Always show at least 2 slots
                    addKeySlotHTML(i, key);
                }
            }
        }
        
        function addKeySlotHTML(num, existingKey = '') {
            const container = document.getElementById('openai-keys');
            const div = document.createElement('div');
            div.className = `key-slot ${existingKey ? 'filled' : ''} p-3 rounded-lg`;
            div.innerHTML = `
                <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs font-bold text-cyan-400">KEY ${num}</span>
                    <span class="text-xs text-gray-500 mono">openai_api_key${num}</span>
                </div>
                <div class="flex gap-2">
                    <input type="password" id="openai-key${num}" value="${existingKey}" 
                           placeholder="sk-..." 
                           class="flex-1 px-3 py-2 bg-white/5 border border-white/10 rounded text-white placeholder-gray-500 focus:border-cyan-400 focus:outline-none mono text-xs">
                    <button onclick="saveOpenAIKey(${num})" class="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-xs font-medium transition-colors">
                        Save
                    </button>
                </div>
                <div class="mt-2 text-xs text-gray-500">
                    Usage: <span id="key${num}-usage">${localStorage.getItem(`key${num}_usage`) || 0}</span> calls
                </div>
            `;
            container.appendChild(div);
        }
        
        function addOpenAIKeySlot() {
            const count = document.querySelectorAll('#openai-keys .key-slot').length;
            if (count >= 4) {
                alert('Maximum 4 OpenAI keys allowed');
                return;
            }
            addKeySlotHTML(count + 1);
        }
        
        function saveOpenAIKey(num) {
            const input = document.getElementById(`openai-key${num}`);
            const key = input.value.trim();
            
            if (!key) {
                localStorage.removeItem(`openai_api_key${num}`);
                showNotification('Key removed', 'warning');
            } else if (!key.startsWith('sk-')) {
                showNotification('Invalid OpenAI key format (must start with sk-)', 'error');
                return;
            } else {
                localStorage.setItem(`openai_api_key${num}`, key);
                showNotification(`OpenAI Key ${num} saved!`, 'success');
            }
            
            loadOpenAIKeys();
            updateStats();
        }
        
        function loadClaudeKey() {
            const key = localStorage.getItem('claude_api_key');
            if (key) document.getElementById('claude-key').value = key;
        }
        
        function saveClaudeKey() {
            const key = document.getElementById('claude-key').value.trim();
            if (!key) {
                localStorage.removeItem('claude_api_key');
                showNotification('Claude key removed', 'warning');
            } else if (!key.startsWith('sk-ant-')) {
                showNotification('Invalid Claude key format (must start with sk-ant-)', 'error');
                return;
            } else {
                localStorage.setItem('claude_api_key', key);
                showNotification('Claude key saved!', 'success');
            }
            updateStats();
        }
        
        function loadGeminiKey() {
            const key = localStorage.getItem('gemini_api_key');
            if (key) document.getElementById('gemini-key').value = key;
        }
        
        function saveGeminiKey() {
            const key = document.getElementById('gemini-key').value.trim();
            if (!key) {
                localStorage.removeItem('gemini_api_key');
                showNotification('Gemini key removed', 'warning');
            } else {
                localStorage.setItem('gemini_api_key', key);
                showNotification('Gemini key saved!', 'success');
            }
            updateStats();
        }
        
        function assignKey() {
            const appName = document.getElementById('app-name').value.trim();
            const keyAssignment = document.getElementById('key-assignment').value;
            
            if (!appName) {
                showNotification('Please enter an app filename', 'error');
                return;
            }
            
            // Store assignment
            localStorage.setItem(`assign-${appName}`, keyAssignment);
            showNotification(`${appName} assigned to ${keyAssignment}`, 'success');
            
            // Clear input
            document.getElementById('app-name').value = '';
            
            loadAppAssignments();
            updateStats();
        }
        
        function loadAppAssignments() {
            const container = document.getElementById('app-assignments');
            container.innerHTML = '';
            
            const assignments = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('assign-')) {
                    const appName = key.replace('assign-', '');
                    const assignment = localStorage.getItem(key);
                    assignments.push({ appName, assignment });
                }
            }
            
            if (assignments.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm text-center py-4">No apps registered yet</div>';
                return;
            }
            
            assignments.forEach(({ appName, assignment }) => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between p-3 bg-white/5 rounded-lg hover:bg-white/10 transition-colors';
                div.innerHTML = `
                    <div class="flex-1">
                        <span class="text-white font-medium">${appName}</span>
                        <span class="app-tag ml-3">${assignment}</span>
                    </div>
                    <button onclick="removeAssignment('${appName}')" class="text-red-400 hover:text-red-300 transition-colors">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                container.appendChild(div);
            });
        }
        
        function removeAssignment(appName) {
            localStorage.removeItem(`assign-${appName}`);
            showNotification(`${appName} unassigned`, 'warning');
            loadAppAssignments();
            updateStats();
        }
        
        function updateStats() {
            // Count keys
            let totalKeys = 0;
            for (let i = 1; i <= 4; i++) {
                if (localStorage.getItem(`openai_api_key${i}`)) totalKeys++;
            }
            if (localStorage.getItem('claude_api_key')) totalKeys++;
            if (localStorage.getItem('gemini_api_key')) totalKeys++;
            document.getElementById('total-keys').textContent = totalKeys;
            
            // Count apps
            let totalApps = 0;
            for (let i = 0; i < localStorage.length; i++) {
                if (localStorage.key(i).startsWith('assign-')) totalApps++;
            }
            document.getElementById('total-apps').textContent = totalApps;
            
            // Total API calls
            const totalCalls = localStorage.getItem('total_api_calls') || 0;
            document.getElementById('total-calls').textContent = totalCalls;
        }
        
        async function testOpenAI() {
            const message = document.getElementById('test-message').value.trim();
            if (!message) {
                showNotification('Enter a test message', 'error');
                return;
            }
            
            const key = localStorage.getItem('openai_api_key1');
            if (!key) {
                showNotification('No OpenAI key found', 'error');
                return;
            }
            
            const resultDiv = document.getElementById('test-result');
            const responseDiv = document.getElementById('test-response');
            resultDiv.classList.remove('hidden');
            responseDiv.textContent = 'Testing...';
            
            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${key}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-3.5-turbo',
                        messages: [{role: 'user', content: message}],
                        max_tokens: 100
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    responseDiv.textContent = `Error: ${data.error.message}`;
                    showNotification('API test failed', 'error');
                } else {
                    responseDiv.textContent = data.choices[0].message.content;
                    showNotification('API test successful!', 'success');
                    
                    // Update call count
                    const totalCalls = parseInt(localStorage.getItem('total_api_calls') || '0');
                    localStorage.setItem('total_api_calls', (totalCalls + 1).toString());
                    updateStats();
                }
            } catch (error) {
                responseDiv.textContent = `Error: ${error.message}`;
                showNotification('API test failed', 'error');
            }
        }
        
        function showNotification(message, type = 'success') {
            const colors = {
                success: 'bg-emerald-600',
                error: 'bg-red-600',
                warning: 'bg-yellow-600'
            };
            
            const div = document.createElement('div');
            div.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-pulse`;
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => div.remove(), 3000);
        }
        
        // Initialize on load
        init();
    </script>
</body>
</html>

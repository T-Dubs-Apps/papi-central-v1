<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PAPI 5.0 | OS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- PAPI Key Loader - Universal API Key Management -->
    <script src="papi-key-loader.js"></script>
    <script src="trial-system.js"></script>
    <script>
                // Spaceship size slider logic
                document.addEventListener('DOMContentLoaded', function() {
                    const ship = document.getElementById('the-ship');
                    const sizeSlider = document.getElementById('spaceshipSizeSlider');
                    const sizeValue = document.getElementById('spaceshipSizeValue');
                    function setSpaceshipScale(scale) {
                        // Clamp scale between 0.4 and 1.2
                        scale = Math.max(0.4, Math.min(1.2, parseFloat(scale)));
                        document.querySelectorAll('.spaceship-container').forEach(el => {
                            el.style.setProperty('--spaceship-scale', scale);
                        });
                        sizeValue.textContent = scale + 'x';
                        localStorage.setItem('ship_scale', scale);
                    }
                    sizeSlider.addEventListener('input', function() {
                        setSpaceshipScale(this.value);
                    });
                    // Mouse wheel resize support
                    ship.addEventListener('wheel', function(e) {
                        e.preventDefault();
                        let current = parseFloat(localStorage.getItem('ship_scale')) || 0.504;
                        let delta = e.deltaY < 0 ? 0.04 : -0.04; // up: increase, down: decrease
                        let next = Math.round((current + delta) * 1000) / 1000;
                        setSpaceshipScale(next);
                        sizeSlider.value = next;
                    }, { passive: false });
                    // Load saved scale
                    const saved = localStorage.getItem('ship_scale');
                    if (saved) {
                        sizeSlider.value = saved;
                        setSpaceshipScale(saved);
                    } else {
                        // Default to 0.504 (30% smaller)
                        sizeSlider.value = 0.504;
                        setSpaceshipScale(0.504);
                    }
                });
        // Force full access for owner/admin
        localStorage.setItem('master_admin', 'TROY_WALKER_2026');
        localStorage.setItem('papi_license', 'active');
        localStorage.setItem('beta_license', 'active');
        // Remove demo mode if present
        localStorage.removeItem('demo_mode');
        // Optionally, activate all app licenses
        Object.keys(localStorage).forEach(k => {
            if (k.endsWith('_license')) localStorage.setItem(k, 'active');
        });
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&family=Space+Mono:wght@400;700&display=swap');

        :root {
            --fresh-mint: #00f2ea;
            --fresh-blue: #0080ff;
            --fresh-purple: #d946ef; /* Learning Color */
            --bg-deep: #050a14;
            --glass: rgba(13, 17, 23, 0.6); 
            --border: rgba(255, 255, 255, 0.1);
            --alien-skin: #a8d5ba;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-deep);
            color: #eef2f6;
            overflow: hidden;
            background-image: url('https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=2000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(5, 10, 20, 0.65);
            pointer-events: none;
            z-index: -1;
        }

        .mono { font-family: 'Space Mono', monospace; }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .glass-panel:hover {
            border-color: rgba(0, 242, 234, 0.4);
            transform: translateY(-2px);
            background: rgba(13, 17, 23, 0.8);
        }

        .nav-btn {
            position: relative;
            color: #94a3b8;
            transition: all 0.3s;
        }
        .nav-btn.active {
            color: var(--fresh-mint);
            background: rgba(0, 242, 234, 0.1);
            text-shadow: 0 0 10px rgba(0, 242, 234, 0.5);
        }
        .nav-btn.active::after {
            content: '';
            position: absolute;
            right: -1px;
            top: 15%;
            height: 70%;
            width: 3px;
            background: var(--fresh-mint);
            border-radius: 4px 0 0 4px;
            box-shadow: 0 0 15px var(--fresh-mint);
        }

        .fade-enter { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--fresh-mint); }

        .text-glow { text-shadow: 0 0 15px rgba(0, 242, 234, 0.3); }

        .unlock-ai-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #00f2ea 0%, #0080ff 100%);
            color: #000;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 10px 30px rgba(0, 242, 234, 0.4);
            transition: all 0.3s;
            z-index: 9999;
            animation: pulse 2s infinite;
        }
        .unlock-ai-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(0, 242, 234, 0.6);
        }
        .unlock-ai-btn.hidden { display: none; }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 10px 30px rgba(0, 242, 234, 0.4); }
            50% { box-shadow: 0 10px 40px rgba(0, 242, 234, 0.7), 0 0 20px rgba(0, 242, 234, 0.5); }
        }

        .bubble-ai { 
            background: rgba(0, 128, 255, 0.2); 
            border: 1px solid rgba(0, 128, 255, 0.3); 
            border-radius: 16px 16px 16px 4px; 
            backdrop-filter: blur(4px);
            max-width: 90%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }
        .bubble-user { 
            background: rgba(0, 242, 234, 0.2); 
            border: 1px solid rgba(0, 242, 234, 0.3); 
            border-radius: 16px 16px 4px 16px; 
            backdrop-filter: blur(4px);
            max-width: 90%;
            word-wrap: break-word;
            overflow-wrap: break-word;
            white-space: pre-wrap;
        }

        .mic-active { color: #ff4757; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { text-shadow: 0 0 0 rgba(255, 71, 87, 0.4); } 50% { text-shadow: 0 0 20px rgba(255, 71, 87, 0.8); } 100% { text-shadow: 0 0 0 rgba(255, 71, 87, 0.4); } }
        
        .reveal-hover { filter: blur(4px); transition: filter 0.3s; }
        .group:hover .reveal-hover { filter: blur(0); }

        /* --- Sidebar Auto-Hide Logic (Alien Mode) --- */
        aside { transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.5s ease; z-index: 50; }
        body.alien-mode aside { position: absolute; left: 0; top: 0; bottom: 0; transform: translateX(calc(-100% + 15px)); opacity: 0.4; border-right: 2px solid var(--fresh-mint); box-shadow: 5px 0 20px rgba(0, 242, 234, 0.3); background: rgba(5, 10, 20, 0.95); }
        body.alien-mode aside:hover { transform: translateX(0); opacity: 1; box-shadow: 10px 0 50px rgba(0, 0, 0, 0.8); }
        body.alien-mode main { width: 100vw; }

        /* --- 3D Spaceship & Carousel CSS --- */
        .scene {
            perspective: 1500px;
            width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            padding-bottom: 80px; 
            position: relative; 
        }

        #lightning-canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 40; 
        }

        .spaceship-container {
            width: 900px; height: 400px;
            position: relative;
            transform-style: preserve-3d;
            animation: hoverShip 8s ease-in-out infinite;
            transform: scale(var(--spaceship-scale, 0.72));
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }

        /* Responsive spaceship scaling for mobile */
        @media (max-width: 600px) {
            .spaceship-container {
                width: 98vw !important;
                height: auto !important;
                min-height: 180px;
                max-width: 100vw;
            }
            .scene {
                padding-bottom: 30px;
            }
        }
        
        .spaceship-container.front {
            z-index: 9999;
            /* Default to 30% smaller */
            --spaceship-scale: 0.504 !important;
        }
        
        .size-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 8px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .spaceship-container:hover ~ .size-controls,
        .size-controls:hover {
            opacity: 1;
        }
        
        .size-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 242, 234, 0.2);
            border: 2px solid var(--fresh-mint);
            color: var(--fresh-mint);
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .size-btn:hover {
            background: var(--fresh-mint);
            color: var(--bg-deep);
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--fresh-mint);
        }
        
        .size-btn:active {
            transform: scale(0.95);
        }
        
        /* ===== CUSTOMIZABLE LAYOUT SYSTEM ===== */
        .layout-movable {
            position: fixed !important;
            border: 2px solid transparent;
            transition: border-color 0.3s ease;
        }
        
        .layout-movable:hover {
            border-color: var(--fresh-mint);
        }
        
        .layout-movable.locked {
            border-color: transparent !important;
            cursor: default !important;
        }
        
        .layout-drag-handle {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(180deg, rgba(0, 242, 234, 0.2), transparent);
            cursor: move;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 10;
        }
        
        .layout-movable:hover .layout-drag-handle,
        .layout-drag-handle:hover {
            opacity: 1;
        }
        
        .layout-movable.locked .layout-drag-handle {
            display: none;
        }
        
        .layout-drag-handle::before {
            content: '⋮⋮⋮';
            color: var(--fresh-mint);
            font-size: 16px;
            letter-spacing: 2px;
        }
        
        .layout-resize-handle {
            position: absolute;
            background: var(--fresh-mint);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .layout-movable:hover .layout-resize-handle {
            opacity: 0.6;
        }
        
        .layout-resize-handle:hover {
            opacity: 1 !important;
        }
        
        .layout-movable.locked .layout-resize-handle {
            display: none;
        }
        
        .resize-corner-tl { top: 0; left: 0; width: 12px; height: 12px; cursor: nw-resize; border-radius: 3px 0 0 0; }
        .resize-corner-tr { top: 0; right: 0; width: 12px; height: 12px; cursor: ne-resize; border-radius: 0 3px 0 0; }
        .resize-corner-bl { bottom: 0; left: 0; width: 12px; height: 12px; cursor: sw-resize; border-radius: 0 0 0 3px; }
        .resize-corner-br { bottom: 0; right: 0; width: 12px; height: 12px; cursor: se-resize; border-radius: 0 0 3px 0; }
        
        .resize-edge-t { top: 0; left: 12px; right: 12px; height: 4px; cursor: n-resize; }
        .resize-edge-b { bottom: 0; left: 12px; right: 12px; height: 4px; cursor: s-resize; }
        .resize-edge-l { left: 0; top: 12px; bottom: 12px; width: 4px; cursor: w-resize; }
        .resize-edge-r { right: 0; top: 12px; bottom: 12px; width: 4px; cursor: e-resize; }
        
        .layout-lock-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 32px;
            height: 32px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid var(--fresh-mint);
            border-radius: 8px;
            color: var(--fresh-mint);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 11;
            font-size: 14px;
        }
        
        .layout-movable:hover .layout-lock-btn {
            opacity: 1;
        }
        
        .layout-lock-btn:hover {
            background: var(--fresh-mint);
            color: var(--bg-deep);
            transform: scale(1.1);
        }
        
        .layout-movable.locked .layout-lock-btn {
            opacity: 0.5;
            background: rgba(255, 59, 59, 0.3);
            border-color: #ff3b3b;
            color: #ff3b3b;
        }
        
        .layout-movable.locked .layout-lock-btn:hover {
            opacity: 1;
        }
        
        /* Master Control Panel */
        #layout-master-panel {
            position: fixed;
            bottom: 120px;
            right: 20px;
            width: 280px;
            background: rgba(5, 10, 20, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--fresh-mint);
            border-radius: 16px;
            padding: 16px;
            z-index: 10001;
            box-shadow: 0 10px 40px rgba(0, 242, 234, 0.3);
            display: none;
        }
        
        #layout-master-panel.active {
            display: block;
            animation: slideInRight 0.3s ease;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .layout-panel-btn {
            width: 100%;
            padding: 10px;
            margin: 6px 0;
            background: rgba(0, 242, 234, 0.1);
            border: 1px solid var(--fresh-mint);
            border-radius: 8px;
            color: var(--fresh-mint);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .layout-panel-btn:hover {
            background: var(--fresh-mint);
            color: var(--bg-deep);
            transform: scale(1.02);
        }
        
        .layout-toggle-btn {
            position: fixed;
            bottom: 70px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: rgba(0, 242, 234, 0.2);
            border: 2px solid var(--fresh-mint);
            border-radius: 50%;
            color: var(--fresh-mint);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 10000;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .layout-toggle-btn:hover {
            background: var(--fresh-mint);
            color: var(--bg-deep);
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 0 30px var(--fresh-mint);
        }
        
        .layout-toggle-btn.active {
            background: var(--fresh-mint);
            color: var(--bg-deep);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px var(--fresh-mint); }
            50% { box-shadow: 0 0 40px var(--fresh-mint); }
        }
        /* ===== END LAYOUT SYSTEM ===== */
        
        /* Idle State - Ship shrinks after 89 seconds */
        .spaceship-container.idle {
            transform: scale(0.4);
            opacity: 0.6;
            animation: hoverShipIdle 12s ease-in-out infinite;
        }
        
        @keyframes hoverShipIdle {
            0%, 100% { transform: scale(0.4) translateY(-10px) rotateZ(0.1deg); }
            50% { transform: scale(0.4) translateY(-20px) rotateZ(-0.1deg); }
        }
        
        /* Active State - Ship zooms back */
        .spaceship-container.active {
            transform: scale(1);
            opacity: 1;
            animation: hoverShip 8s ease-in-out infinite;
        }
        
        /* Dragging State */
        .spaceship-container.dragging {
            /* removed dragging cursor and animation */
        }
        
        /* Takeoff Animation */
        .spaceship-container.takeoff {
            animation: takeoffSequence 3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards !important;
            transform-origin: center center;
        }
        
        @keyframes takeoffSequence {
            0% { transform: scale(1) translateY(0) rotateZ(0deg); }
            20% { transform: scale(1.1) translateY(-50px) rotateZ(-5deg); }
            40% { transform: scale(1.2) translateY(-100px) rotateZ(5deg); }
            100% { transform: scale(0.2) translateY(-2000px) rotateZ(720deg); opacity: 0; }
        }
        
        /* Purple Trail for Takeoff */
        .purple-trail {
            position: absolute;
            bottom: 50%;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 0;
            background: linear-gradient(to bottom, transparent, var(--fresh-purple), transparent);
            box-shadow: 0 0 60px var(--fresh-purple);
            opacity: 0;
            z-index: 3;
            transition: height 0.5s, opacity 0.5s;
        }
        
        .takeoff .purple-trail {
            height: 800px;
            opacity: 1;
        }

        @keyframes hoverShip {
            0%, 100% { transform: translateY(-20px) rotateZ(0.2deg); }
            50% { transform: translateY(-50px) rotateZ(-0.2deg); }
        }

        .shake-ship { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite !important; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px, 0, 0) rotateZ(-1deg); }
            20%, 80% { transform: translate3d(4px, 0, 0) rotateZ(2deg); }
            30%, 50%, 70% { transform: translate3d(-8px, 0, 0) rotateZ(-2deg); }
            40%, 60% { transform: translate3d(8px, 0, 0) rotateZ(2deg); }
        }

        /* Ship Parts */
        .saucer-core {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) rotateX(80deg);
            width: 800px; height: 800px; 
            border-radius: 50%;
            background: conic-gradient(from 0deg, #1e293b, #334155, #64748b, #334155, #1e293b);
            border: 4px solid rgba(0, 242, 234, 0.4);
            box-shadow: 0 0 50px rgba(0, 242, 234, 0.2);
            z-index: 5;
            transition: border-color 0.5s, box-shadow 0.5s;
        }

        /* Learning Mode (Purple) */
        .learning .saucer-core {
            border-color: var(--fresh-purple);
            box-shadow: 0 0 80px rgba(217, 70, 239, 0.4);
        }

        .saucer-dome-top {
            position: absolute; bottom: 50%; left: 50%;
            transform: translateX(-50%);
            width: 500px; height: 140px; 
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(0, 242, 234, 0.05) 50%, transparent 100%);
            border-radius: 50% 50% 0 0 / 100% 100% 0 0; 
            border-top: 1px solid rgba(255,255,255,0.4);
            border-left: 1px solid rgba(255,255,255,0.2);
            backdrop-filter: blur(1px);
            z-index: 20; /* High index to contain alien */
            box-shadow: inset 0 20px 40px rgba(255,255,255,0.1);
            overflow: visible;
        }
        
        /* Glass Reflection Overlay for "Inside" feel */
        .saucer-dome-top::after {
            content: '';
            position: absolute;
            top: 10px; right: 20px;
            width: 60px; height: 30px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: rotate(-20deg);
            filter: blur(5px);
            z-index: 25; /* On top of alien */
            pointer-events: none;
        }

        .saucer-dome-bottom {
            position: absolute; top: 50%; left: 50%;
            transform: translateX(-50%);
            width: 500px; height: 140px; 
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.8) 0%, #1e293b 100%);
            border-radius: 0 0 50% 50% / 0 0 100% 100%; 
            border-bottom: 2px solid rgba(0, 242, 234, 0.3);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            z-index: 4;
        }

        .saucer-engine {
            position: absolute; top: 50%; left: 50%;
            width: 100px; height: 20px;
            background: #00f2ea;
            border-radius: 50%;
            transform: translate(-50%, -50%) rotateX(80deg);
            box-shadow: 0 0 50px #00f2ea;
            z-index: 6;
            animation: pulseEngine 2s infinite;
        }
        @keyframes pulseEngine { 0%, 100% { opacity: 0.5; } 50% { opacity: 1; } }
        
        /* Rapid Pulse for Learning */
        .learning .saucer-engine {
            animation: pulseEngine 0.2s infinite;
            background: var(--fresh-purple);
            box-shadow: 0 0 80px var(--fresh-purple);
        }

        /* Carousel */
        /* Carousel CSS Removed - Apps now in dropdown menu */

        @keyframes rotateCarousel { from { transform: rotateY(0deg); } to { transform: rotateY(360deg); } }

        /* --- Alien Styling --- */
        .alien-pilot {
            position: absolute;
            top: -75px; /* Most of body hidden below dome */
            left: 50%;
            transform: translateX(-50%) translateZ(50px);
            width: 40px; height: 180px; /* Much taller */
            z-index: 18;
            transition: all 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            align-items: center;
            opacity: 0; /* Hidden by default */
        }
        
        .alien-pilot.visible { 
            opacity: 1; 
            animation: alienLookAround 8s ease-in-out infinite;
        }
        
        /* Alien looks around when visible */
        @keyframes alienLookAround {
            0%, 100% { transform: translateX(-50%) translateZ(50px) rotateY(0deg); }
            25% { transform: translateX(-50%) translateZ(50px) rotateY(-15deg); }
            50% { transform: translateX(-50%) translateZ(50px) rotateY(0deg); }
            75% { transform: translateX(-50%) translateZ(50px) rotateY(15deg); }
        }

        .alien-head {
            width: 40px;
            height: 60px;
            background: 
                radial-gradient(ellipse at 20% 30%, color-mix(in srgb, var(--alien-skin) 50%, white) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 35%, color-mix(in srgb, var(--alien-skin) 40%, black) 0%, transparent 45%),
                linear-gradient(135deg, 
                    color-mix(in srgb, var(--alien-skin) 80%, white) 0%, 
                    color-mix(in srgb, var(--alien-skin) 70%, black) 30%, 
                    color-mix(in srgb, var(--alien-skin) 60%, black) 60%, 
                    color-mix(in srgb, var(--alien-skin) 50%, black) 100%);
            border-radius: 50% 50% 48% 48% / 65% 65% 35% 35%;
            position: relative;
            z-index: 2;
            box-shadow: 
                inset -5px -8px 20px rgba(0,0,0,0.4),
                inset 3px 3px 12px rgba(180,200,190,0.2),
                inset -2px 0 8px rgba(60,80,70,0.3);
        }
        
        /* Realistic alien head details - veins and texture */
        .alien-head::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                linear-gradient(120deg, transparent 45%, rgba(100,120,110,0.4) 47%, transparent 49%),
                linear-gradient(60deg, transparent 60%, rgba(90,110,100,0.3) 61%, transparent 63%),
                radial-gradient(ellipse at 30% 40%, rgba(70,90,80,0.2) 0%, transparent 60%);
            border-radius: inherit;
            opacity: 0.6;
        }
        
        /* Skin texture overlay */
        .alien-head::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
            border-radius: inherit;
            pointer-events: none;
        }

        .alien-eye {
            position: absolute;
            top: 18px;
            width: 20px; height: 26px;
            background: 
                radial-gradient(ellipse at 50% 45%, #0a0a0a 35%, #1a1a1a 60%, #000000 100%);
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            transition: all 0.5s ease-out;
            box-shadow: 
                inset 0 2px 6px rgba(0,0,0,0.9),
                inset 0 -3px 8px rgba(0,255,200,0.15),
                0 0 8px rgba(0,0,0,0.8),
                0 1px 3px rgba(255,255,255,0.1);
            animation: blinkEyes 5s infinite;
            overflow: hidden;
        }
        .alien-eye.left { left: 2px; transform: rotate(8deg); }
        .alien-eye.right { right: 2px; transform: rotate(-8deg); }
        
        /* Eye iris/pupil with depth */
        .alien-eye::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 7px;
            width: 6px;
            height: 8px;
            background: 
                radial-gradient(circle at 35% 30%, rgba(0,255,200,0.9) 0%, rgba(0,200,160,0.7) 40%, rgba(0,150,120,0.5) 70%, transparent 100%);
            border-radius: 50%;
            box-shadow: 
                0 0 6px rgba(0,255,200,0.8),
                inset 0 -1px 2px rgba(0,0,0,0.5);
        }
        
        /* Eye reflection/highlight */
        .alien-eye::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            width: 3px;
            height: 4px;
            background: rgba(255,255,255,0.4);
            border-radius: 50%;
            box-shadow: 1px 1px 2px rgba(255,255,255,0.2);
        }

        /* Learning Eyes (Purple Glow) */
        .learning .alien-eye {
            background: radial-gradient(circle at 40% 35%, var(--fresh-purple), #6b21a8);
            box-shadow: 0 0 15px var(--fresh-purple), inset 0 0 8px rgba(168, 85, 247, 0.5);
        }

        @keyframes blinkEyes {
            0%, 92% { height: 26px; opacity: 1; }
            94% { height: 4px; opacity: 0.3; }
            96% { height: 26px; opacity: 1; }
            98% { height: 4px; opacity: 0.3; }
            100% { height: 26px; opacity: 1; }
        }

        /* Expanded Eyes on Delivery - wider, more alert */
        .delivering .alien-eye {
            height: 32px;
            width: 24px;
            top: 15px;
            animation: none;
            box-shadow: 0 0 12px rgba(0, 255, 200, 0.6), inset 0 0 8px rgba(0,255,200,0.3);
        }

        .alien-neck {
            width: 8px; height: 22px;
            background: 
                linear-gradient(90deg, transparent 40%, rgba(90,110,100,0.3) 50%, transparent 60%),
                linear-gradient(to bottom, 
                    color-mix(in srgb, var(--alien-skin) 80%, white) 0%, 
                    var(--alien-skin) 50%, 
                    color-mix(in srgb, var(--alien-skin) 80%, black) 100%);
            margin-top: -5px;
            z-index: 1;
            box-shadow: 
                inset -2px 0 4px rgba(0,0,0,0.4),
                inset 2px 0 3px rgba(180,200,190,0.2),
                inset 0 2px 6px rgba(0,0,0,0.3);
            position: relative;
        }
        
        /* Neck texture lines */
        .alien-neck::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.1) 3px, rgba(0,0,0,0.1) 4px);
        }

        .alien-torso {
            width: 20px; height: 70px;
            background: 
                linear-gradient(135deg, #4a5568 0%, #3a4555 30%, #2d3748 60%, #1f2937 100%);
            border-radius: 6px 6px 0 0;
            z-index: 1;
            position: relative;
            box-shadow: 
                inset -3px 0 8px rgba(0,0,0,0.5),
                inset 3px 0 6px rgba(100,120,140,0.15),
                inset 0 -20px 30px rgba(0,0,0,0.3),
                0 2px 4px rgba(0,0,0,0.5);
        }
        
        /* Suit panel lines and details */
        .alien-torso::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                linear-gradient(0deg, transparent 48%, rgba(100,120,140,0.3) 49%, rgba(60,80,100,0.3) 51%, transparent 52%),
                linear-gradient(0deg, transparent 23%, rgba(80,100,120,0.2) 24%, transparent 26%);
            border-radius: inherit;
        }
        
        /* Suit center seam */
        .alien-torso::after {
            content: '';
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 1px;
            height: 60px;
            background: linear-gradient(to bottom, 
                transparent 0%, 
                rgba(80,100,120,0.4) 10%, 
                rgba(60,80,100,0.6) 50%, 
                rgba(80,100,120,0.4) 90%, 
                transparent 100%);
            box-shadow: 0 0 2px rgba(100,120,140,0.3);
        }

        .alien-arm {
            position: absolute;
            top: 6px;
            width: 4px; height: 50px;
            background: 
                linear-gradient(to bottom, 
                    color-mix(in srgb, var(--alien-skin) 80%, white) 0%, 
                    var(--alien-skin) 30%, 
                    color-mix(in srgb, var(--alien-skin) 80%, black) 70%, 
                    color-mix(in srgb, var(--alien-skin) 70%, black) 100%);
            border-radius: 2px;
            box-shadow: 
                inset -1px 0 3px rgba(0,0,0,0.5),
                inset 1px 0 2px rgba(180,200,190,0.2),
                1px 1px 2px rgba(0,0,0,0.3);
            position: relative;
        }
        .alien-arm.right { right: -2px; transform: rotate(-15deg); }
        .alien-arm.left { left: -2px; transform: rotate(15deg); }
        
        /* Arm joint/elbow detail */
        .alien-arm::before {
            content: '';
            position: absolute;
            top: 50%;
            left: -1px;
            right: -1px;
            height: 3px;
            background: rgba(0,0,0,0.2);
            border-radius: 50%;
        }

        /* Control stick removed - was visually inappropriate */
        
        /* Chat Feed Minimized State */
        .chat-minimized #chat-feed {
            max-height: 0 !important;
            min-height: 0 !important;
            opacity: 0;
            overflow: hidden;
            margin-bottom: 0;
        }
        
        .chat-minimized {
            margin-bottom: 0 !important;
        }
        
        /* Terms of Service Modal */
        #tosModal {
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease-out;
        }
        
        #tosContent {
            animation: slideUp 0.4s ease-out;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Delivery Animation Class */
        .delivering .saucer-dome-top {
            clip-path: none; /* Allow alien to pop out */
            overflow: visible;
        }
        .delivering .alien-pilot {
            top: 250px; /* Slide down */
            transform: translateX(-50%) translateZ(600px) scale(6); /* Come to face */
            z-index: 100; /* Pop through dome */
        }

        /* Laser Ladder */
        .laser-ladder {
            position: absolute;
            top: 50%; left: 50%;
            transform: translateX(-50%);
            width: 40px; height: 0;
            background: repeating-linear-gradient(
                to bottom,
                rgba(0, 242, 234, 0.1),
                rgba(0, 242, 234, 0.1) 10px,
                rgba(0, 242, 234, 0.8) 10px,
                rgba(0, 242, 234, 0.8) 12px
            );
            box-shadow: 0 0 20px #00f2ea;
            transition: height 0.5s ease-out;
            z-index: 15;
        }
        .delivering .laser-ladder {
            height: 350px;
        }

        /* Speech Bubble */
        .alien-speech {
            position: absolute;
            top: -60px; left: 100%;
            background: white; color: black;
            padding: 10px; border-radius: 10px;
            font-family: monospace; font-weight: bold;
            font-size: 4px; 
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .alien-speech::after {
            content: ''; position: absolute; top: 100%; left: 0;
            border: 5px solid transparent; border-top-color: white;
        }
        .delivering .alien-speech {
            opacity: 1;
            font-size: 12px; 
        }

        #readme-panel {
            position: absolute;
            top: 20px; right: 20px;
            width: 240px; 
            background: rgba(5, 10, 20, 0.9);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 3px solid var(--fresh-mint);
            border-radius: 8px; padding: 15px;
            backdrop-filter: blur(12px);
            opacity: 0; pointer-events: none;
            transition: opacity 0.3s ease;
            z-index: 50;
        }
        #readme-panel.active { opacity: 1; pointer-events: auto; }
        
    </style>
</head>
<body class="flex h-screen w-full">

    <!-- Terms of Service Modal -->
    <div id="tosModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[9999] flex items-center justify-center p-4" style="display: none;">
        <div id="tosContent" class="glass-panel bg-gray-900/95 border-2 border-cyan-500/50 rounded-2xl max-w-3xl w-full p-8">
            <div class="text-center mb-6">
                <i class="fas fa-shield-check text-6xl text-cyan-400 mb-4"></i>
                <h2 class="text-3xl font-bold text-white mb-2">Terms of Service & User Agreement</h2>
                <p class="text-gray-400">Please read carefully before using PAPI Central</p>
            </div>
            
            <div class="bg-black/40 rounded-xl p-6 mb-6 max-h-96 overflow-y-auto border border-cyan-500/20">
                <div class="text-gray-300 space-y-4 text-sm leading-relaxed">
                    <p class="text-yellow-400 font-semibold"><i class="fas fa-exclamation-triangle mr-2"></i>IMPORTANT: READ CAREFULLY BEFORE USE</p>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">1. OWNERSHIP & LICENSE</h3>
                        <p>All software, applications, and tools ("Software") available through PAPI Central are owned by Troy Walker. By accessing any application within this marketplace, you are purchasing or receiving a LICENSE to use the Software, not ownership of the Software itself.</p>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">2. SCOPE OF AGREEMENT</h3>
                        <p>This agreement applies to <strong>ANY AND ALL</strong> applications, tools, and software created by Troy Walker and distributed through PAPI Central, including but not limited to current and future applications within this marketplace.</p>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">3. PERMITTED USE</h3>
                        <p>The Software is provided for legitimate, lawful purposes only, including personal development, business applications, educational purposes, and authorized professional use.</p>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">4. PROHIBITED USE</h3>
                        <p>You shall NOT use any Software within PAPI Central for:</p>
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                            <li>Unauthorized access to systems, networks, or data</li>
                            <li>Malicious, harmful, or destructive activities</li>
                            <li>Violation of any third-party terms of service</li>
                            <li>Any illegal activities under applicable law</li>
                            <li>Harassment, fraud, abuse, or causing harm to others</li>
                            <li>Any activity that violates ethical or moral standards</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">5. LIMITATION OF LIABILITY</h3>
                        <p class="text-yellow-300 font-semibold">TO THE MAXIMUM EXTENT PERMITTED BY LAW:</p>
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                            <li>Troy Walker and all parties involved SHALL NOT be held responsible or liable for any damages, losses, harm, or consequences resulting from your use or misuse of the Software</li>
                            <li>You assume FULL RESPONSIBILITY for your actions</li>
                            <li>The creator is NOT LIABLE for intentional or unintentional misuse</li>
                            <li>Any consequences of your actions are YOUR SOLE RESPONSIBILITY</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">6. USER RESPONSIBILITY</h3>
                        <p>By using any Software in PAPI Central, you acknowledge and agree that:</p>
                        <ul class="list-disc list-inside ml-4 mt-2 space-y-1">
                            <li>You are solely responsible for all actions taken using the Software</li>
                            <li>You will comply with all applicable laws and regulations</li>
                            <li>You will use the Software ethically and morally</li>
                            <li>You release the creator from any liability related to your use</li>
                            <li>You will not hold Troy Walker or any associated parties liable for your actions</li>
                        </ul>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">7. NO WARRANTY</h3>
                        <p>All Software is provided "AS IS" without warranty of any kind, express or implied. The creator makes no guarantees about functionality, reliability, security, availability, or fitness for any particular purpose.</p>
                    </div>
                    
                    <div>
                        <h3 class="text-cyan-400 font-bold mb-2">8. ACCEPTANCE</h3>
                        <p>By checking the box below and proceeding to use ANY application within PAPI Central, you acknowledge that you have read, understood, and agree to be bound by these Terms of Service. This agreement is binding and applies to all current and future use of any Software within this marketplace.</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-4 mb-6">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="tosCheckbox" class="mt-1 w-5 h-5 text-cyan-600 rounded focus:ring-cyan-500">
                    <span class="text-white">
                        I have read and agree to the Terms of Service. I understand that this agreement applies to <strong>all current and future applications</strong> within PAPI Central, and I accept full responsibility for my actions.
                    </span>
                </label>
            </div>
            
            <div class="flex gap-4">
                <button onclick="declineTOS()" class="flex-1 py-3 bg-red-600 hover:bg-red-500 text-white font-semibold rounded-lg transition">
                    <i class="fas fa-times mr-2"></i>Decline & Exit
                </button>
                <button onclick="acceptTOS()" id="acceptButton" disabled class="flex-1 py-3 bg-cyan-600 hover:bg-cyan-500 text-white font-semibold rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-check mr-2"></i>Accept & Continue
                </button>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <aside class="w-20 md:w-64 flex-shrink-0 border-r border-white/10 flex flex-col justify-between bg-black/60 backdrop-blur-xl z-20">
        <div>
            <!-- Brand -->
            <div class="h-20 flex items-center justify-center md:justify-start md:px-6 gap-3 border-b border-white/10">
                <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-cyan-400 to-blue-600 flex items-center justify-center shadow-lg shadow-cyan-500/20">
                    <span class="font-bold text-white text-lg">P</span>
                </div>
                <div class="hidden md:block">
                    <h1 class="font-bold text-lg tracking-wide text-white">PAPI <span class="text-cyan-400 font-light">5.0</span></h1>
                </div>
            </div>

            <!-- Nav -->
            <nav class="mt-8 space-y-2 px-2">
                <button onclick="nav('home')" id="btn-home" class="nav-btn active w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                    <span class="hidden md:block font-medium">Overview</span>
                </button>
                <button onclick="nav('security')" id="btn-security" class="nav-btn w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4">
                    <i class="fa-solid fa-fingerprint text-lg"></i>
                    <span class="hidden md:block font-medium">Security</span>
                </button>
                <button onclick="nav('rf')" id="btn-rf" class="nav-btn w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4">
                    <i class="fa-solid fa-wifi text-lg"></i>
                    <span class="hidden md:block font-medium">RF Power</span>
                </button>
                <button onclick="nav('dev')" id="btn-dev" class="nav-btn w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4">
                    <i class="fa-solid fa-terminal text-lg"></i>
                    <span class="hidden md:block font-medium">Dev Console</span>
                </button>
                <!-- Alien AI Button -->
                <button onclick="nav('alien')" id="btn-alien" class="nav-btn w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4">
                    <i class="fa-solid fa-meteor text-lg"></i>
                    <span class="hidden md:block font-medium">Alien AI</span>
                </button>
                <!-- Customize Button -->
                <button onclick="openAppearancePanel()" class="nav-btn w-full p-3 rounded-xl flex items-center justify-center md:justify-start gap-4 border border-purple-500/30 bg-purple-900/10 hover:bg-purple-900/30">
                    <i class="fa-solid fa-palette text-lg text-purple-400"></i>
                    <span class="hidden md:block font-medium text-purple-300">Customize</span>
                </button>
            </nav>
        </div>

        <!-- System Status -->
        <div class="p-4 border-t border-white/10">
            <div class="glass-panel p-3 flex flex-col items-center md:items-start gap-2 bg-black/40">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_10px_#34d399]"></div>
                    <span class="hidden md:block text-xs font-mono text-emerald-400">ONLINE</span>
                </div>
                <button id="voice-toggle" onclick="toggleVoice()" class="text-xs text-slate-400 hover:text-white transition-colors w-full text-left flex items-center gap-2">
                    <i class="fa-solid fa-volume-xmark" id="voice-icon"></i>
                    <span class="hidden md:block" id="voice-text">Voice Off</span>
                </button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col relative overflow-hidden">
        
        <!-- Header -->
        <header class="h-20 flex items-center justify-between px-8 border-b border-white/10 z-10 bg-black/20 backdrop-blur-sm">
            <div class="flex items-center gap-6">
                <div>
                    <h2 id="page-title" class="text-2xl font-bold text-white drop-shadow-md">Alien AI Assistant</h2>
                    <p id="page-subtitle" class="text-xs text-slate-300 mono">System Status: Optimal</p>
                </div>
                <!-- APPS DROPDOWN -->
                <div class="relative">
                    <button onclick="actions.toggleAppsMenu()" class="flex items-center gap-2 px-4 py-2 rounded-lg bg-cyan-600/20 border border-cyan-500/30 hover:bg-cyan-600/30 transition-all">
                        <i class="fa-solid fa-th text-cyan-400"></i>
                        <span class="text-sm font-bold text-cyan-400">Apps</span>
                        <i class="fa-solid fa-chevron-down text-cyan-400 text-xs"></i>
                    </button>
                    <div id="appsMenu" class="hidden absolute top-full left-0 mt-2 w-72 bg-gray-900/95 backdrop-blur-xl border border-cyan-500/30 rounded-xl shadow-2xl z-50">
                        <div class="p-3 border-b border-gray-700">
                            <div class="text-xs font-bold text-cyan-400 uppercase tracking-wider">Available Apps</div>
                        </div>
                        <div class="max-h-96 overflow-y-auto">
                            <!-- Cortex App Studio (NEW!) -->
                            <a href="LAUNCH-Cortex-App-Studio.html" onclick="window.open('LAUNCH-Cortex-App-Studio.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-purple-600/10 transition-all border-b border-gray-800 cursor-pointer bg-purple-900/20">
                                <i class="fa-solid fa-magic text-2xl text-purple-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Cortex App Studio <span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded">NEW!</span></div>
                                    <div class="text-xs text-gray-400">Build → Preview → Deploy</div>
                                </div>
                                <div class="text-xs font-bold text-purple-400">$29.99/mo</div>
                            </a>
                            <!-- AI Assistant Pro -->
                            <a href="ai-assistant-pro.html" onclick="window.open('ai-assistant-pro.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-blue-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-brain text-2xl text-blue-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">AI Assistant Pro</div>
                                    <div class="text-xs text-gray-400">Advanced AI Development</div>
                                </div>
                                <div class="text-xs font-bold text-blue-400">$49.99/mo</div>
                            </a>
                            <!-- Aegis Guard -->
                            <a href="aegis-guard.html" onclick="window.open('aegis-guard.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-shield-halved text-2xl text-emerald-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Aegis Guard</div>
                                    <div class="text-xs text-gray-400">Security Scanner</div>
                                </div>
                                <div class="text-xs font-bold text-emerald-400">$9.99</div>
                            </a>
                            <!-- Aegis Government -->
                            <a href="aegis-government.html" onclick="window.open('aegis-government.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-shield text-2xl text-green-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Aegis Government</div>
                                    <div class="text-xs text-gray-400">🔒 CLASSIFIED</div>
                                </div>
                                <div class="text-xs font-bold text-green-400">$99.99</div>
                            </a>
                            <!-- Code Cargo -->
                            <a href="code-cargo.html" onclick="window.open('code-cargo.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-box-archive text-2xl text-purple-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Code Cargo</div>
                                    <div class="text-xs text-gray-400">File Manager</div>
                                </div>
                                <div class="text-xs font-bold text-purple-400">FREE</div>
                            </a>
                            <!-- Automation Hub -->
                            <a href="automation-hub.html" onclick="window.open('automation-hub.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-gears text-2xl text-orange-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Automation Hub</div>
                                    <div class="text-xs text-gray-400">Deploy System</div>
                                </div>
                                <div class="text-xs font-bold text-orange-400">$29.99</div>
                            </a>
                            <!-- No Knowledge Kit -->
                            <a href="no-knowledge-kit.html" onclick="window.open('no-knowledge-kit.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-user-tie text-2xl text-amber-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">No Knowledge Kit</div>
                                    <div class="text-xs text-gray-400">App Builder</div>
                                </div>
                                <div class="text-xs font-bold text-amber-400">$50</div>
                            </a>
                            <!-- Call Sentry -->
                            <a href="call-sentry.html" onclick="window.open('call-sentry.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-phone-slash text-2xl text-red-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Call Sentry</div>
                                    <div class="text-xs text-gray-400">Call Blocker</div>
                                </div>
                                <div class="text-xs font-bold text-red-400">$14.99</div>
                            </a>
                            <!-- Key Generator Pro -->
                            <a href="key-generator-pro.html" onclick="window.open('key-generator-pro.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-key text-2xl text-amber-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Key Generator Pro</div>
                                    <div class="text-xs text-gray-400">Advanced API Manager</div>
                                </div>
                                <div class="text-xs font-bold text-amber-400">$99.99</div>
                            </a>
                            <!-- Key Controller -->
                            <a href="key-controller.html" onclick="window.open('key-controller.html', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all border-b border-gray-800 cursor-pointer">
                                <i class="fa-solid fa-key text-2xl text-cyan-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">Key Controller</div>
                                    <div class="text-xs text-gray-400">Manage API Keys</div>
                                </div>
                                <div class="text-xs font-bold text-cyan-400">NEW</div>
                            </a>
                            <!-- PAPI Central -->
                            <a href="PAPI Central.htm" onclick="window.open('PAPI Central.htm', '_blank'); return false;" class="flex items-center gap-3 p-3 hover:bg-cyan-600/10 transition-all cursor-pointer">
                                <i class="fa-solid fa-credit-card text-2xl text-blue-400"></i>
                                <div class="flex-1">
                                    <div class="text-sm font-bold text-white">PAPI Central</div>
                                    <div class="text-xs text-gray-400">Get License</div>
                                </div>
                                <div class="text-xs font-bold text-blue-400">STORE</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:block text-right">
                    <div id="clock" class="text-sm font-mono text-cyan-400 drop-shadow-sm">00:00:00</div>
                    <div class="text-[10px] text-slate-400">LOCAL TIME</div>
                </div>
                
                <button onclick="openSettings()" class="w-10 h-10 rounded-full bg-slate-800/80 border border-white/10 flex items-center justify-center text-slate-400 hover:text-cyan-400 hover:bg-slate-700 transition-all" title="API Settings">
                    <i class="fa-solid fa-gear"></i>
                </button>

                <button onclick="actions.detachWindow()" class="w-10 h-10 rounded-full bg-slate-800/80 border border-white/10 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700 transition-all" title="Detach Window">
                    <i class="fa-solid fa-up-right-from-square"></i>
                </button>

                <div class="w-10 h-10 rounded-full bg-slate-800/80 border border-white/10 flex items-center justify-center">
                    <i class="fa-solid fa-user-astronaut text-slate-400"></i>
                </div>
            </div>
        </header>

        <!-- SETTINGS MODAL -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div class="bg-gray-900 border-2 border-cyan-500 rounded-2xl max-w-2xl w-full shadow-2xl overflow-hidden max-h-[85vh] flex flex-col">
                <!-- Header -->
                <div class="bg-gradient-to-r from-cyan-600 to-blue-600 p-4 flex justify-between items-center flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <i class="fa-solid fa-gear text-2xl text-white"></i>
                        <div>
                            <h2 class="text-xl font-bold text-white">API Settings</h2>
                            <p class="text-cyan-100 text-xs">Configure Your AI Providers</p>
                        </div>
                    </div>
                    <button onclick="closeSettings()" class="text-white hover:text-cyan-200 text-xl">
                        <i class="fa-solid fa-times"></i>
                    </button>
                </div>

                <!-- Body (Scrollable) -->
                <div class="p-4 space-y-4 overflow-y-auto flex-grow">
                    <!-- Current Provider -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                        <label class="block text-xs font-bold text-cyan-400 mb-2">Active AI Provider</label>
                        <select id="aiProvider" onchange="updateProvider()" class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg text-sm">
                            <option value="demo">Demo Mode (No API Required)</option>
                            <option value="openai">OpenAI GPT-4</option>
                            <option value="claude">Claude 3.5 Sonnet</option>
                            <option value="gemini">Google Gemini</option>
                        </select>
                    </div>

                    <!-- OpenAI Multi-Key System -->
                    <div class="bg-gradient-to-r from-blue-900/30 to-blue-800/30 border-2 border-blue-500/50 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fa-solid fa-layer-group text-blue-400 text-sm"></i>
                                <label class="text-xs font-bold text-blue-400">OpenAI Multi-Key System</label>
                            </div>
                            <span id="openai-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">0/4 Keys</span>
                        </div>
                        
                        <div class="space-y-2">
                            <!-- Key 1 -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" id="openaiKey1" placeholder="sk-proj-..." 
                                        class="flex-1 bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs"
                                        oninput="maskAPIKey(this)" data-full-key="">
                                    <span id="key1-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-500">—</span>
                                </div>
                                <input type="text" id="key1-label" placeholder="Label: Code Automation" 
                                    class="w-full bg-gray-900/50 border border-gray-700 text-gray-300 p-1 rounded text-xs">
                            </div>
                            
                            <!-- Key 2 -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" id="openaiKey2" placeholder="sk-proj-..." 
                                        class="flex-1 bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs"
                                        oninput="maskAPIKey(this)" data-full-key="">
                                    <span id="key2-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-500">—</span>
                                </div>
                                <input type="text" id="key2-label" placeholder="Label: Chat/Conversation" 
                                    class="w-full bg-gray-900/50 border border-gray-700 text-gray-300 p-1 rounded text-xs">
                            </div>
                            
                            <!-- Key 3 -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" id="openaiKey3" placeholder="sk-proj-..." 
                                        class="flex-1 bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs"
                                        oninput="maskAPIKey(this)" data-full-key="">
                                    <span id="key3-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-500">—</span>
                                </div>
                                <input type="text" id="key3-label" placeholder="Label: Security Analysis" 
                                    class="w-full bg-gray-900/50 border border-gray-700 text-gray-300 p-1 rounded text-xs">
                            </div>
                            
                            <!-- Key 4 -->
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <input type="text" id="openaiKey4" placeholder="sk-proj-..." 
                                        class="flex-1 bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs"
                                        oninput="maskAPIKey(this)" data-full-key="">
                                    <span id="key4-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-500">—</span>
                                </div>
                                <input type="text" id="key4-label" placeholder="Label: General Tasks" 
                                    class="w-full bg-gray-900/50 border border-gray-700 text-gray-300 p-1 rounded text-xs">
                            </div>
                        </div>
                        
                        <p class="text-[10px] text-gray-400 mt-2">Keys display as: sk-proj-...last8chars • <a href="https://platform.openai.com/api-keys" target="_blank" class="text-cyan-400 hover:underline">Get keys</a></p>
                        
                        <!-- App Assignments -->
                        <div class="mt-3 pt-3 border-t border-gray-700">
                            <div class="flex items-center gap-2 mb-2">
                                <i class="fa-solid fa-link text-cyan-400 text-xs"></i>
                                <label class="text-[10px] font-bold text-cyan-400">App Assignments</label>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div>
                                    <label class="text-gray-400 block mb-1">Alien AI</label>
                                    <select id="assign-alien" class="w-full bg-gray-900 border border-gray-600 text-white p-1 rounded text-xs">
                                        <option value="auto">Auto-Rotate</option>
                                        <option value="key1">Key 1</option>
                                        <option value="key2">Key 2</option>
                                        <option value="key3">Key 3</option>
                                        <option value="key4">Key 4</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-400 block mb-1">Code Cargo</label>
                                    <select id="assign-code" class="w-full bg-gray-900 border border-gray-600 text-white p-1 rounded text-xs">
                                        <option value="key1" selected>Key 1</option>
                                        <option value="key2">Key 2</option>
                                        <option value="key3">Key 3</option>
                                        <option value="key4">Key 4</option>
                                        <option value="auto">Auto-Rotate</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-400 block mb-1">Aegis Guard</label>
                                    <select id="assign-aegis" class="w-full bg-gray-900 border border-gray-600 text-white p-1 rounded text-xs">
                                        <option value="key3" selected>Key 3</option>
                                        <option value="key1">Key 1</option>
                                        <option value="key2">Key 2</option>
                                        <option value="key4">Key 4</option>
                                        <option value="auto">Auto-Rotate</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-gray-400 block mb-1">Automation</label>
                                    <select id="assign-automation" class="w-full bg-gray-900 border border-gray-600 text-white p-1 rounded text-xs">
                                        <option value="key1" selected>Key 1</option>
                                        <option value="key2">Key 2</option>
                                        <option value="key3">Key 3</option>
                                        <option value="key4">Key 4</option>
                                        <option value="auto">Auto-Rotate</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Usage Stats -->
                        <div class="mt-2 p-2 bg-gray-900/50 rounded text-[10px]">
                            <div class="flex items-center justify-between text-gray-400">
                                <span>🔄 <span id="rotation-mode" class="text-cyan-400">Round-Robin</span></span>
                                <span>📊 Calls: <span id="total-calls" class="text-cyan-400">0</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Claude -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-xs font-bold text-purple-400">Claude 3.5 Sonnet</label>
                            <span id="claude-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">Not Configured</span>
                        </div>
                        <input type="password" id="claudeKey" placeholder="sk-ant-..." 
                            class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs">
                    </div>

                    <!-- Gemini -->
                    <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                        <div class="flex items-center justify-between mb-2">
                            <label class="text-xs font-bold text-green-400">Google Gemini</label>
                            <span id="gemini-status" class="text-xs px-2 py-1 rounded bg-gray-700 text-gray-400">Not Configured</span>
                        </div>
                        <input type="password" id="geminiKey" placeholder="AIzaSy..." 
                            class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg font-mono text-xs">
                    </div>

                    <!-- Security Notice -->
                    <div class="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-3 flex gap-2">
                        <i class="fa-solid fa-shield-halved text-cyan-400 text-sm"></i>
                        <div class="text-[10px] text-gray-300">
                            <strong class="text-cyan-400">Secure:</strong> Keys stored locally only, never sent to any server except official AI APIs.
                        </div>
                    </div>
                </div>

                <!-- Footer (Always Visible) -->
                <div class="bg-gray-800 p-4 flex gap-3 border-t border-gray-700 flex-shrink-0">
                    <button onclick="testAllKeys()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 rounded-lg transition text-sm">
                        <i class="fa-solid fa-vial text-green-400 mr-2"></i> Test Keys
                    </button>
                    <button onclick="saveSettings()" class="flex-1 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold py-2 rounded-lg transition text-sm">
                        <i class="fa-solid fa-save mr-2"></i> Save Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Viewport -->
        <div class="flex-grow p-6 md:p-8 overflow-y-auto pb-32 relative">
            
            <!-- VIEW: HOME -->
            <div id="view-home" class="fade-enter grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Welcome Card -->
                <div class="col-span-1 md:col-span-2 lg:col-span-3 glass-panel p-8 bg-gradient-to-r from-blue-900/40 to-cyan-900/40 border-cyan-500/30">
                    <h1 class="text-3xl font-bold text-white mb-2 drop-shadow-lg">Welcome to PAPI <span class="text-cyan-400">5.0</span></h1>
                    <p class="text-slate-200 max-w-2xl drop-shadow-md">Your Personal Automated Protection Interface. I am ready to generate keys, analyze frequencies, and execute commands.</p>
                </div>

                <!-- ALIEN APPS WIDGET -->
                <div class="glass-panel p-6 flex flex-col justify-between h-48 group cursor-pointer hover:bg-purple-900/20 border-purple-500/20" onclick="nav('alien')">
                    <div class="flex justify-between items-start">
                        <div class="p-3 rounded-xl bg-purple-500/20 text-purple-400"><i class="fa-solid fa-rocket"></i></div>
                        <span class="text-xs font-mono text-slate-400">MARKETPLACE</span>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Alien Apps</div>
                        <div class="font-bold text-white text-lg group-hover:text-purple-300 transition-colors">Browse Store &nbsp;<i class="fa-solid fa-arrow-right text-xs"></i></div>
                        <div class="text-[10px] text-slate-500 mt-1">3 New Arrivals</div>
                    </div>
                </div>

                <!-- Live Key Widget -->
                <div class="glass-panel p-6 flex flex-col justify-between h-48 group cursor-pointer hover:bg-black/60" onclick="nav('security')">
                    <div class="flex justify-between items-start">
                        <div class="p-3 rounded-xl bg-emerald-500/20 text-emerald-400"><i class="fa-solid fa-key"></i></div>
                        <span class="text-xs font-mono text-slate-400">AUTO-ROTATING</span>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-1">
                             <div class="text-xs text-slate-400 uppercase tracking-wider">Current Session Key</div>
                             <div class="text-[10px] text-emerald-400 font-mono"><i class="fa-solid fa-lock"></i> MASKED</div>
                        </div>
                        <div id="widget-key" class="font-mono text-xl text-white truncate group-hover:text-cyan-400 transition-colors drop-shadow-md">••••-••••-••••-••••</div>
                    </div>
                </div>

                <!-- RF Power Widget -->
                <div class="glass-panel p-6 flex flex-col justify-between h-48 group cursor-pointer hover:bg-black/60" onclick="nav('rf')">
                    <div class="flex justify-between items-start">
                        <div class="p-3 rounded-xl bg-blue-500/20 text-blue-400"><i class="fa-solid fa-bolt"></i></div>
                        <span class="text-xs font-mono text-slate-400">ATMOSPHERIC</span>
                    </div>
                    <div>
                        <div class="text-xs text-slate-400 uppercase tracking-wider mb-1">Energy Potential</div>
                        <div class="flex items-end gap-2">
                            <span id="widget-rf" class="text-3xl font-bold text-white drop-shadow-md">0.0</span>
                            <span class="text-sm text-slate-400 mb-1">µW</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: SECURITY -->
            <div id="view-security" class="hidden fade-enter h-full flex flex-col justify-center items-center max-w-4xl mx-auto">
                <div class="glass-panel p-10 w-full text-center relative overflow-hidden bg-black/60">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-emerald-500 via-cyan-500 to-blue-500"></div>
                    <div class="w-20 h-20 mx-auto bg-slate-800/80 rounded-full flex items-center justify-center mb-6 border border-white/10 shadow-[0_0_30px_rgba(0,242,234,0.3)]">
                        <i class="fa-solid fa-shield-halved text-3xl text-cyan-400"></i>
                    </div>
                    <h3 class="text-slate-400 text-sm uppercase tracking-widest mb-2">Secure Session Token</h3>
                    <div id="sec-key-display" class="font-mono text-4xl md:text-5xl font-bold text-white mb-8 select-all cursor-pointer hover:text-cyan-300 transition-colors drop-shadow-lg" onclick="actions.copyKey()">---</div>
                    <div class="flex justify-center gap-4">
                        <button onclick="actions.genKey()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-xl font-medium transition-all shadow-lg shadow-cyan-900/40 flex items-center gap-2"><i class="fa-solid fa-rotate"></i> Generate</button>
                        <button onclick="actions.copyKey()" class="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-medium transition-all flex items-center gap-2"><i class="fa-regular fa-copy"></i> Copy</button>
                    </div>
                </div>
            </div>

            <!-- VIEW: RF LAB -->
            <div id="view-rf" class="hidden fade-enter grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="glass-panel p-6 bg-black/50">
                    <h3 class="text-lg font-bold text-white mb-6 border-b border-white/10 pb-2">Source Parameters</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs text-slate-400">Transmitter Power (Watts)</label>
                            <input type="range" id="rf-tx" min="0.1" max="100" step="0.1" value="0.1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-2 accent-cyan-400" oninput="actions.calcRF()">
                            <div class="text-right text-xs text-cyan-400 font-mono mt-1"><span id="val-tx">0.1</span> W</div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Distance (Meters)</label>
                            <input type="range" id="rf-dist" min="1" max="500" step="1" value="5" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-2 accent-cyan-400" oninput="actions.calcRF()">
                            <div class="text-right text-xs text-cyan-400 font-mono mt-1"><span id="val-dist">5</span> m</div>
                        </div>
                        <div>
                            <label class="text-xs text-slate-400">Frequency (GHz)</label>
                            <input type="range" id="rf-freq" min="0.1" max="5" step="0.1" value="2.4" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer mt-2 accent-cyan-400" oninput="actions.calcRF()">
                            <div class="text-right text-xs text-cyan-400 font-mono mt-1"><span id="val-freq">2.4</span> GHz</div>
                        </div>
                    </div>
                </div>
                <div class="glass-panel p-6 flex flex-col items-center justify-center text-center relative bg-black/50">
                    <div class="absolute inset-0 bg-cyan-500/5 rounded-2xl"></div>
                    <div class="relative z-10">
                        <div class="text-sm text-slate-400 uppercase tracking-widest mb-2">Harvested Power</div>
                        <div id="rf-main-res" class="text-6xl font-bold text-white font-mono text-glow mb-2 drop-shadow-xl">0.00</div>
                        <div class="text-xl text-cyan-400 font-mono mb-6">microwatts (µW)</div>
                        <div id="rf-dbm-res" class="text-xs text-slate-500 font-mono p-2 bg-slate-900/80 rounded border border-white/10 inline-block">Signal Strength: -00 dBm</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: DEV -->
            <div id="view-dev" class="hidden fade-enter h-full flex flex-col">
                <div class="glass-panel p-1 flex-grow flex flex-col overflow-hidden bg-black/40">
                    <div class="bg-slate-900/60 p-2 flex justify-between items-center border-b border-white/10 px-4">
                        <span class="text-xs text-slate-400"><i class="fa-solid fa-code mr-2"></i>Code Editor</span>
                        <button onclick="actions.repairCode()" class="text-xs bg-orange-500/20 text-orange-400 px-3 py-1 rounded hover:bg-orange-500/30 transition-colors">Auto-Fix & Format</button>
                    </div>
                    <textarea id="code-editor" class="flex-grow bg-transparent text-slate-300 font-mono text-sm p-4 resize-none outline-none" placeholder="// Paste code here to repair..."></textarea>
                </div>
            </div>

            <!-- VIEW: ALIEN AI (SPACESHIP MODE) -->
            <div id="view-alien" class="hidden fade-enter h-full flex flex-col items-center justify-center relative">
                
                <!-- Hover/Click README Panel (Stable, Top Right) -->
                <div id="readme-panel">
                    <h3 id="read-title" class="text-sm font-bold text-cyan-400 mb-1">Select App</h3>
                    <div id="read-desc" class="text-[10px] text-slate-300 mb-2 leading-tight">Hover over an app module.</div>
                    <div class="text-[9px] font-bold text-slate-500 uppercase tracking-wider mb-1">Protocol:</div>
                    <div id="read-use" class="text-[9px] font-mono text-emerald-400 bg-black/30 p-1 rounded border border-emerald-500/20">
                        Waiting...
                    </div>
                    <!-- Buy Button -->
                    <!-- Universal purchase button: always routes to store for Stripe checkout -->
                    <a href="PAPI Central.htm" class="mt-3 w-full bg-cyan-600 hover:bg-cyan-500 text-white text-[10px] py-1 rounded font-bold transition-colors block text-center">ACQUIRE (via Store)</a>
                </div>

                <div class="scene">
                    <canvas id="lightning-canvas"></canvas>
                    <!-- Spaceship Size Slider -->
                    <div style="position:absolute;top:10px;right:10px;z-index:9999;background:rgba(20,20,20,0.85);padding:8px 16px 8px 10px;border-radius:14px;box-shadow:0 2px 12px #0006;display:flex;align-items:center;gap:10px;">
                        <label for="spaceshipSizeSlider" style="font-size:13px;">Spaceship Size</label>
                        <input type="range" id="spaceshipSizeSlider" min="0.4" max="1.2" step="0.01" value="0.72" style="width:120px;">
                        <span id="spaceshipSizeValue" style="font-size:13px;">0.72x</span>
                    </div>
                    <div id="the-ship" class="spaceship-container front">
                        <!-- Purple Trail for Takeoff -->
                        <div class="purple-trail"></div>
                        
                        <!-- Top Slim Dome (1/3rd Round) -->
                        <div class="saucer-dome-top">
                            <!-- ALIEN PILOT (Starts Hidden) -->
                            <div class="alien-pilot">
                                <div class="alien-head">
                                    <div class="alien-eye left"></div>
                                    <div class="alien-eye right"></div>
                                </div>
                                <div class="alien-neck"></div>
                                <div class="alien-torso">
                                    <div class="alien-arm left"></div>
                                    <div class="alien-arm right"></div>
                                </div>
                                <div class="alien-speech">Thank you earthling</div>
                            </div>
                        </div>

                        <!-- Pure Spaceship Visual (No Carousel) -->

                        <!-- Equator Core -->
                        <div class="saucer-core"></div>
                        <div id="ship-engine" class="saucer-engine"></div>
                        <!-- Laser Ladder -->
                        <div class="laser-ladder"></div>

                        <!-- Bottom Slim Dome (Mirrored) -->
                        <div class="saucer-dome-bottom"></div>
                    </div>
                </div>

            </div>

        </div>

        <!-- Alien Positioning Control Panel -->
        <div id="alien-position-controls" class="hidden fixed top-4 right-4 z-[60] bg-slate-900/95 backdrop-blur-lg border border-cyan-500/30 rounded-lg p-4 shadow-2xl shadow-cyan-900/40" style="width: 320px;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-cyan-400 font-bold text-sm">Position Alien Pilot</h3>
                <button onclick="actions.positionAlien()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4 text-xs">
                <!-- Top Position (Y axis) -->
                <div>
                    <label class="text-gray-300 mb-1 block">Top Position: <span id="alien-top-val" class="text-cyan-400 font-mono">-75px</span></label>
                    <input type="range" id="alien-top" min="-150" max="50" value="-75" 
                           class="w-full" oninput="updateAlienPosition()">
                    <div class="flex justify-between text-gray-500 text-[10px] mt-1">
                        <span>Higher</span>
                        <span>Lower</span>
                    </div>
                </div>
                
                <!-- Scale -->
                <div>
                    <label class="text-gray-300 mb-1 block">Scale: <span id="alien-scale-val" class="text-cyan-400 font-mono">1.0</span></label>
                    <input type="range" id="alien-scale" min="0.5" max="2" step="0.1" value="1.0" 
                           class="w-full" oninput="updateAlienPosition()">
                    <div class="flex justify-between text-gray-500 text-[10px] mt-1">
                        <span>Smaller</span>
                        <span>Larger</span>
                    </div>
                </div>
                
                <!-- Rotation -->
                <div>
                    <label class="text-gray-300 mb-1 block">Rotation: <span id="alien-rotate-val" class="text-cyan-400 font-mono">0°</span></label>
                    <input type="range" id="alien-rotate" min="-45" max="45" value="0" 
                           class="w-full" oninput="updateAlienPosition()">
                    <div class="flex justify-between text-gray-500 text-[10px] mt-1">
                        <span>Left</span>
                        <span>Right</span>
                    </div>
                </div>
                
                <!-- Left Position (X offset) -->
                <div>
                    <label class="text-gray-300 mb-1 block">Horizontal: <span id="alien-left-val" class="text-cyan-400 font-mono">50%</span></label>
                    <input type="range" id="alien-left" min="30" max="70" value="50" 
                           class="w-full" oninput="updateAlienPosition()">
                    <div class="flex justify-between text-gray-500 text-[10px] mt-1">
                        <span>Left</span>
                        <span>Right</span>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-2 pt-2 border-t border-gray-700">
                    <button onclick="resetAlienPosition()" 
                            class="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs transition-all">
                        Reset
                    </button>
                    <button onclick="lockAlienPosition()" 
                            class="flex-1 px-3 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-xs transition-all">
                        Lock Position
                    </button>
                </div>
                
                <!-- Show Alien Button -->
                <button onclick="SpaceshipController.showAlien()" 
                        class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded text-xs transition-all">
                    <i class="fa-solid fa-eye mr-1"></i> Show Alien
                </button>
            </div>
        </div>
        
        <!-- Appearance Customization Panel -->
        <div id="appearance-controls" class="hidden fixed top-4 left-4 z-[60] bg-slate-900/95 backdrop-blur-lg border border-purple-500/30 rounded-lg shadow-2xl shadow-purple-900/40" style="width: 380px; max-height: 90vh; overflow-y: auto;">
            <div class="sticky top-0 bg-slate-900/95 backdrop-blur-lg p-4 border-b border-gray-700 flex items-center justify-between">
                <div>
                    <h3 class="text-purple-400 font-bold text-sm flex items-center gap-2">
                        <i class="fa-solid fa-palette"></i> Appearance & Effects
                    </h3>
                    <p class="text-gray-400 text-[10px] mt-1">Customize your PAPI experience</p>
                </div>
                <button onclick="closeAppearancePanel()" class="text-gray-400 hover:text-white">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="p-4 space-y-4 text-xs">
                <!-- Welcome Message for New Users -->
                <div class="bg-purple-900/20 border border-purple-500/30 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-wand-magic-sparkles text-purple-400 text-sm mt-0.5"></i>
                        <div class="text-[11px]">
                            <strong class="text-purple-300 block mb-1">🎨 Welcome to Visual Customization!</strong>
                            <p class="text-gray-300 leading-relaxed">
                                Explore CSS properties, learn about gradients, animations, and 3D transforms. 
                                Each control teaches you web graphics fundamentals while personalizing your experience.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Background Customization -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-image"></i> Background Theme
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">background-image</span>
                    </label>
                    <select id="bg-theme" onchange="changeBackground()" 
                            class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg text-xs mb-2">
                        <option value="space">🌌 Deep Space (Default)</option>
                        <option value="nebula">🌠 Purple Nebula</option>
                        <option value="stars">⭐ Star Field</option>
                        <option value="earth">🌍 Earth Orbit</option>
                        <option value="mars">🔴 Mars Surface</option>
                        <option value="abstract">🎨 Abstract Gradient</option>
                        <option value="matrix">💚 Matrix Code</option>
                        <option value="solid">⬛ Solid Dark</option>
                    </select>
                    <div class="text-[10px] text-gray-400 leading-relaxed">
                        <strong>Learn:</strong> Background-image property controls visual themes. Try different options to see CSS blend modes in action.
                    </div>
                </div>
                
                <!-- Background Overlay -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-layer-group"></i> Overlay Opacity
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">rgba() overlay</span>
                    </label>
                    <input type="range" id="overlay-opacity" min="0" max="100" value="65" 
                           oninput="updateOverlay()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Transparent: <span id="overlay-val" class="text-cyan-400">65%</span></span>
                        <span>Opaque</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2 leading-relaxed">
                        <strong>Learn:</strong> RGBA opacity creates depth. Lower = see more background, higher = darker overlay for better text contrast.
                    </div>
                </div>
                
                <!-- Shooting Stars -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-meteor"></i> Shooting Stars
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">@keyframes animation</span>
                    </label>
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-gray-300 text-xs">Enable</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="shooting-stars" onchange="toggleShootingStars()" checked class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                        </label>
                    </div>
                    <label class="text-gray-300 mb-1 block">Frequency: <span id="star-freq-val" class="text-cyan-400 font-mono">40s</span></label>
                    <input type="range" id="star-frequency" min="20" max="60" value="40" 
                           oninput="updateStarFrequency()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>More Often (20s)</span>
                        <span>Less Often (60s)</span>
                    </div>
                    <label class="text-gray-300 mb-1 block mt-2">Speed: <span id="star-speed-val" class="text-cyan-400 font-mono">1.0s</span></label>
                    <input type="range" id="star-speed" min="0.5" max="3" step="0.1" value="1.0" 
                           oninput="updateStarSpeed()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Faster (0.5s)</span>
                        <span>Slower (3s)</span>
                    </div>
                    <label class="text-gray-300 mb-1 block mt-2">Direction: <span id="star-dir-val" class="text-cyan-400 font-mono">Horizontal</span></label>
                    <select id="star-direction" onchange="updateStarDirection()" 
                            class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg text-xs mb-2">
                        <option value="horizontal">→ Horizontal</option>
                        <option value="diagonal-up">↗ Diagonal Up</option>
                        <option value="diagonal-down">↘ Diagonal Down</option>
                        <option value="steep-up">⬈ Steep Up</option>
                        <option value="steep-down">⬊ Steep Down</option>
                    </select>
                    <label class="text-gray-300 mb-1 block mt-2">Size: <span id="star-size-val" class="text-cyan-400 font-mono">14px</span></label>
                    <input type="range" id="star-size" min="12" max="32" value="14" 
                           oninput="updateStarSize()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Small</span>
                        <span>Large</span>
                    </div>
                    <label class="text-gray-300 mb-1 block mt-2">Trail Color</label>
                    <div class="flex gap-2 mb-2">
                        <button onclick="setTrailColor('#64C8FF')" class="flex-1 h-8 rounded" style="background: linear-gradient(90deg, #64C8FF, transparent); border: 2px solid #64C8FF;" title="Cyan"></button>
                        <button onclick="setTrailColor('#FF6464')" class="flex-1 h-8 rounded" style="background: linear-gradient(90deg, #FF6464, transparent); border: 2px solid #FF6464;" title="Red"></button>
                        <button onclick="setTrailColor('#64FF96')" class="flex-1 h-8 rounded" style="background: linear-gradient(90deg, #64FF96, transparent); border: 2px solid #64FF96;" title="Green"></button>
                        <button onclick="setTrailColor('#FFD700')" class="flex-1 h-8 rounded" style="background: linear-gradient(90deg, #FFD700, transparent); border: 2px solid #FFD700;" title="Gold"></button>
                        <button onclick="setTrailColor('#D946EF')" class="flex-1 h-8 rounded" style="background: linear-gradient(90deg, #D946EF, transparent); border: 2px solid #D946EF;" title="Purple"></button>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2 leading-relaxed">
                        <strong>Learn:</strong> Pure CSS trail effects using linear-gradients, ::after pseudo-elements, and box-shadow for realistic meteor streaks.
                    </div>
                </div>
                
                <!-- Spaceship Glow -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-sun"></i> Spaceship Glow
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">box-shadow property</span>
                    </label>
                    <input type="range" id="ship-glow" min="0" max="100" value="50" 
                           oninput="updateShipGlow()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Subtle: <span id="glow-val" class="text-cyan-400">50%</span></span>
                        <span>Intense</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2 leading-relaxed">
                        <strong>Learn:</strong> Box-shadow creates glowing effects. Multiple shadows with blur radius create realistic lighting.
                    </div>
                </div>
                
                <!-- Animation Speed -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-gauge-high"></i> Animation Speed
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">animation-duration</span>
                    </label>
                    <label class="text-gray-300 mb-1 block">Ship Hover: <span id="hover-speed-val" class="text-cyan-400 font-mono">8s</span></label>
                    <input type="range" id="hover-speed" min="2" max="20" value="8" 
                           oninput="updateHoverSpeed()" class="w-full mb-3">
                    <div class="text-[10px] text-gray-400 leading-relaxed">
                        <strong>Learn:</strong> Animation-duration controls timing. Slower = smoother, faster = more energetic. Try cubic-bezier for custom easing!
                    </div>
                </div>
                
                <!-- Alien Appearance Presets -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-user-astronaut"></i> Alien Style
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">Custom CSS variables</span>
                    </label>
                    <select id="alien-style" onchange="changeAlienStyle()" 
                            class="w-full bg-gray-900 border border-gray-600 text-white p-2 rounded-lg text-xs mb-2">
                        <option value="classic">👽 Classic Grey (Default)</option>
                        <option value="blue">🔵 Blue Arcturian</option>
                        <option value="green">💚 Reptilian</option>
                        <option value="purple">💜 Ethereal Being</option>
                        <option value="orange">🧡 Martian</option>
                    </select>
                    <div class="text-[10px] text-gray-400 leading-relaxed">
                        <strong>Learn:</strong> CSS variables (--alien-skin) allow theme switching. One variable change updates all alien colors instantly!
                    </div>
                </div>
                
                <!-- Glass Effect Intensity -->
                <div class="bg-gray-800 border border-gray-700 rounded-lg p-3">
                    <label class="text-purple-300 font-bold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-droplet"></i> Glass Effect
                        <span class="text-[10px] text-gray-400 font-normal ml-auto">backdrop-filter: blur()</span>
                    </label>
                    <input type="range" id="glass-blur" min="0" max="40" value="20" 
                           oninput="updateGlassBlur()" class="w-full mb-2">
                    <div class="flex justify-between text-[10px] text-gray-400">
                        <span>Clear: <span id="blur-val" class="text-cyan-400">20px</span></span>
                        <span>Frosted</span>
                    </div>
                    <div class="text-[10px] text-gray-400 mt-2 leading-relaxed">
                        <strong>Learn:</strong> Backdrop-filter blur creates glassmorphism. Modern CSS property for frosted glass UI effects.
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-2 pt-2 border-t border-gray-700">
                    <button onclick="resetAppearance()" 
                            class="flex-1 px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs transition-all">
                        <i class="fa-solid fa-rotate-left mr-1"></i> Reset All
                    </button>
                    <button onclick="saveAppearance()" 
                            class="flex-1 px-3 py-2 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 text-white rounded text-xs transition-all">
                        <i class="fa-solid fa-save mr-1"></i> Save Theme
                    </button>
                </div>
                
                <!-- CSS Learning Resources -->
                <div class="bg-cyan-900/20 border border-cyan-500/30 rounded-lg p-3">
                    <div class="flex items-start gap-2">
                        <i class="fa-solid fa-graduation-cap text-cyan-400 text-sm mt-0.5"></i>
                        <div class="text-[10px]">
                            <strong class="text-cyan-300 block mb-1">📚 Learning Resources</strong>
                            <ul class="text-gray-300 space-y-1 leading-relaxed">
                                <li>• <strong>Gradients:</strong> Create smooth color transitions</li>
                                <li>• <strong>Transforms:</strong> Rotate, scale, translate elements in 3D</li>
                                <li>• <strong>Animations:</strong> Bring interfaces to life with keyframes</li>
                                <li>• <strong>Filters:</strong> Apply visual effects (blur, brightness)</li>
                                <li>• <strong>Variables:</strong> Reusable values across your theme</li>
                            </ul>
                            <p class="mt-2 text-purple-300">
                                💡 <strong>Tip:</strong> Open browser DevTools (F12) to inspect CSS properties and experiment in real-time!
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Command Bar Overlay -->
        <div class="absolute bottom-0 left-0 right-0 z-50 p-4 md:p-6 bg-gradient-to-t from-[#050a14] via-[#050a14]/80 to-transparent pointer-events-none">
            <!-- Chat Feed Container with Collapse Button -->
            <div id="chat-container" class="w-full max-w-md ml-auto mb-4 pointer-events-auto transition-all duration-300">
                <div class="flex items-center justify-between mb-2 px-2">
                    <span class="text-xs text-gray-400 font-mono">AI Output</span>
                    <button onclick="toggleChatFeed()" id="chat-toggle-btn" class="text-gray-400 hover:text-cyan-400 transition-all text-sm" title="Minimize chat">
                        <i class="fa-solid fa-minus"></i>
                    </button>
                </div>
                <div id="chat-feed" class="overflow-y-auto flex flex-col justify-end space-y-2 px-2 overflow-x-hidden transition-all duration-300" style="max-height: calc(100vh - 200px); min-height: 150px;"></div>
            </div>
            <div class="w-full max-w-3xl mx-auto pointer-events-auto">
                <!-- Message Counter (for free users) -->
                <div id="message-counter" class="text-center mb-2 text-sm hidden">
                    <span class="text-cyan-400 font-mono"></span>
                </div>
                <div id="chat-bar" class="glass-panel p-2 flex items-center gap-2 bg-black/80 backdrop-blur-2xl border-cyan-500/30 shadow-lg shadow-cyan-900/40">
                    <button onclick="actions.toggleMic()" id="mic-btn" class="w-10 h-10 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 flex items-center justify-center transition-all">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <input type="text" id="cmd-input" class="flex-grow bg-transparent border-none text-white font-mono text-sm focus:ring-0 placeholder-slate-500" placeholder="Type command... (e.g. 'Generate Key', 'Scan RF')" autocomplete="off">
                    <button onclick="actions.sendCmd()" class="w-10 h-10 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white flex items-center justify-center transition-all">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>

    </main>

    <script>
        const state = { 
            currentKey: null, 
            voiceActive: false, 
            recognition: null, 
            audioCtx: null,
            memory: JSON.parse(localStorage.getItem('papi_memory') || '{}'),
            ship: {
                idleTimeout: null,
                isDragging: false,
                dragOffset: { x: 0, y: 0 },
                currentPos: { x: 0, y: 0 },
                lastActivity: Date.now()
            }
        };
        
        // --- Spaceship Controller ---
        const SpaceshipController = {
            init: function() {
                this.setupIdleTimer();
                this.loadSize();
                // Reset idle timer on any user interaction
                document.addEventListener('mousemove', () => this.resetIdleTimer());
                document.addEventListener('keypress', () => this.resetIdleTimer());
                document.addEventListener('click', () => this.resetIdleTimer());
            },
            
            setupIdleTimer: function() {
                this.resetIdleTimer();
            },
            
            resetIdleTimer: function() {
                state.ship.lastActivity = Date.now();
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                // Make ship active if it was idle
                if (ship.classList.contains('idle')) {
                    ship.classList.remove('idle');
                    ship.classList.add('active');
                }
                
                // Clear existing timeout
                if (state.ship.idleTimeout) {
                    clearTimeout(state.ship.idleTimeout);
                }
                
                // Set new timeout for 89 seconds
                state.ship.idleTimeout = setTimeout(() => {
                    if (Date.now() - state.ship.lastActivity >= 89000) {
                        ship.classList.add('idle');
                        ship.classList.remove('active');
                    }
                }, 89000);
            },
            
            // Dragging removed
            
            // Size controls replaced by slider
            
            increaseSize: function() {
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                // Get current scale
                let currentScale = parseFloat(localStorage.getItem('ship_scale')) || 0.9;
                
                // Increase by 0.1, max 2.0
                currentScale = Math.min(currentScale + 0.1, 2.0);
                
                // Apply scale
                this.setSize(currentScale);
                
                playSound('success', 0.3);
            },
            
            decreaseSize: function() {
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                // Get current scale
                let currentScale = parseFloat(localStorage.getItem('ship_scale')) || 0.9;
                
                // Decrease by 0.1, min 0.2
                currentScale = Math.max(currentScale - 0.1, 0.2);
                
                // Apply scale
                this.setSize(currentScale);
                
                playSound('error', 0.3);
            },
            
            setSize: function(scale) {
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                // Save to localStorage
                localStorage.setItem('ship_scale', scale.toString());
                
                // Remove idle/active classes temporarily
                const wasIdle = ship.classList.contains('idle');
                const wasActive = ship.classList.contains('active');
                
                ship.classList.remove('idle', 'active');
                
                // Apply scale
                ship.style.transform = `scale(${scale})`;
                
                // Restore state classes
                if (wasIdle) ship.classList.add('idle');
                if (wasActive) ship.classList.add('active');
            },
            
            loadSize: function() {
                const savedScale = parseFloat(localStorage.getItem('ship_scale'));
                if (savedScale) {
                    this.setSize(savedScale);
                }
            },
            
            checkBounds: function() {
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                const rect = ship.getBoundingClientRect();
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                
                // Collision detection with viewport edges
                if (rect.left < 0 || rect.right > viewportWidth || 
                    rect.top < 0 || rect.bottom > viewportHeight) {
                    ship.style.borderColor = 'rgba(255, 87, 87, 0.8)';
                    playSound('error', 0.3);
                } else {
                    ship.style.borderColor = '';
                }
            },
            
            showAlien: function() {
                const alien = document.querySelector('.alien-pilot');
                if (alien) {
                    alien.classList.add('visible');
                }
            },
            
            hideAlien: function() {
                const alien = document.querySelector('.alien-pilot');
                if (alien) {
                    alien.classList.remove('visible');
                }
            },
            
            triggerTakeoff: function() {
                const ship = document.getElementById('the-ship');
                if (!ship) return;
                
                ship.classList.add('takeoff');
                playSound('success', 1);
                
                // Reset after animation
                setTimeout(() => {
                    ship.classList.remove('takeoff');
                    ship.style.position = 'relative';
                    ship.style.left = '';
                    ship.style.top = '';
                }, 3000);
            }
        };

        // ===== LAYOUT CONTROLLER - Make Everything Movable & Resizable =====
        const LayoutController = {
            elements: [],
            activeElement: null,
            isDragging: false,
            isResizing: false,
            dragOffset: { x: 0, y: 0 },
            resizeData: {},
            editMode: false,
            
            init: function() {
                this.loadLayouts();
                this.createMasterPanel();
                this.registerElement('chat-container', 'Chat Feed', {
                    minWidth: 300,
                    minHeight: 200,
                    defaultPos: { top: 'auto', right: 20, bottom: 200, left: 'auto', width: 400, height: 400 }
                });
                
                // Removed spaceship from movable elements
                
                // Add command bar as movable element
                const chatBar = document.getElementById('chat-bar');
                if (chatBar) {
                    const wrapper = chatBar.closest('.w-full.max-w-3xl');
                    if (wrapper && !wrapper.id) {
                        wrapper.id = 'command-bar-wrapper';
                        this.registerElement('command-bar-wrapper', 'Command Bar', {
                            minWidth: 400,
                            minHeight: 60,
                            defaultPos: { bottom: 20, left: '50%', transform: 'translateX(-50%)', width: 700, height: 'auto' }
                        });
                    }
                }
                
                // Add apps menu as movable element
                const appsMenu = document.getElementById('appsMenu');
                if (appsMenu) {
                    this.registerElement('appsMenu', 'Apps Menu', {
                        minWidth: 250,
                        minHeight: 200,
                        defaultPos: { top: 80, left: 20, width: 288, height: 'auto' }
                    });
                }
                
                document.addEventListener('mousemove', (e) => this.handleDrag(e));
                document.addEventListener('mouseup', () => this.stopDrag());
            },
            
            registerElement: function(id, name, options = {}) {
                const element = document.getElementById(id);
                if (!element) return;
                
                this.elements.push({
                    id: id,
                    name: name,
                    element: element,
                    options: options,
                    locked: false,
                    originalClasses: element.className
                });
                
                element.classList.add('layout-movable');
                
                const dragHandle = document.createElement('div');
                dragHandle.className = 'layout-drag-handle';
                dragHandle.addEventListener('mousedown', (e) => this.startDrag(id, e));
                element.appendChild(dragHandle);
                
                const handles = ['tl', 'tr', 'bl', 'br', 't', 'b', 'l', 'r'];
                handles.forEach(pos => {
                    const handle = document.createElement('div');
                    handle.className = `layout-resize-handle resize-${pos.length > 1 ? 'corner' : 'edge'}-${pos}`;
                    handle.addEventListener('mousedown', (e) => this.startResize(id, pos, e));
                    element.appendChild(handle);
                });
                
                const lockBtn = document.createElement('div');
                lockBtn.className = 'layout-lock-btn';
                lockBtn.innerHTML = '<i class="fa-solid fa-lock-open"></i>';
                lockBtn.addEventListener('click', () => this.toggleLock(id));
                element.appendChild(lockBtn);
                
                if (getComputedStyle(element).position !== 'fixed') {
                    const rect = element.getBoundingClientRect();
                    element.style.position = 'fixed';
                    element.style.top = rect.top + 'px';
                    element.style.left = rect.left + 'px';
                    element.style.width = rect.width + 'px';
                    element.style.height = rect.height + 'px';
                }
            },
            
            startDrag: function(id, e) {
                const elemData = this.elements.find(el => el.id === id);
                if (!elemData || elemData.locked) return;
                
                this.isDragging = true;
                this.activeElement = elemData;
                
                const rect = elemData.element.getBoundingClientRect();
                this.dragOffset.x = e.clientX - rect.left;
                this.dragOffset.y = e.clientY - rect.top;
                elemData.element.style.cursor = 'grabbing';
                e.preventDefault();
            },
            
            handleDrag: function(e) {
                if (!this.isDragging || !this.activeElement) return;
                const newX = e.clientX - this.dragOffset.x;
                const newY = e.clientY - this.dragOffset.y;
                this.activeElement.element.style.left = newX + 'px';
                this.activeElement.element.style.top = newY + 'px';
                this.activeElement.element.style.right = 'auto';
                this.activeElement.element.style.bottom = 'auto';
            },
            
            stopDrag: function() {
                if (this.isDragging && this.activeElement) {
                    this.activeElement.element.style.cursor = '';
                    this.saveLayout(this.activeElement.id);
                }
                if (this.isResizing && this.activeElement) {
                    this.saveLayout(this.activeElement.id);
                }
                this.isDragging = false;
                this.isResizing = false;
                this.activeElement = null;
            },
            
            startResize: function(id, position, e) {
                const elemData = this.elements.find(el => el.id === id);
                if (!elemData || elemData.locked) return;
                
                this.isResizing = true;
                this.activeElement = elemData;
                
                const rect = elemData.element.getBoundingClientRect();
                this.resizeData = {
                    position: position,
                    startX: e.clientX,
                    startY: e.clientY,
                    startWidth: rect.width,
                    startHeight: rect.height,
                    startTop: rect.top,
                    startLeft: rect.left
                };
                
                document.addEventListener('mousemove', this.handleResize.bind(this));
                e.preventDefault();
                e.stopPropagation();
            },
            
            handleResize: function(e) {
                if (!this.isResizing || !this.activeElement) return;
                
                const deltaX = e.clientX - this.resizeData.startX;
                const deltaY = e.clientY - this.resizeData.startY;
                const pos = this.resizeData.position;
                const opts = this.activeElement.options;
                const elem = this.activeElement.element;
                
                let newWidth = this.resizeData.startWidth;
                let newHeight = this.resizeData.startHeight;
                let newTop = this.resizeData.startTop;
                let newLeft = this.resizeData.startLeft;
                
                if (pos.includes('r')) newWidth += deltaX;
                if (pos.includes('l')) { newWidth -= deltaX; newLeft += deltaX; }
                if (pos.includes('b')) newHeight += deltaY;
                if (pos.includes('t')) { newHeight -= deltaY; newTop += deltaY; }
                
                if (newWidth < (opts.minWidth || 200)) newWidth = opts.minWidth || 200;
                if (newHeight < (opts.minHeight || 150)) newHeight = opts.minHeight || 150;
                
                elem.style.width = newWidth + 'px';
                elem.style.height = newHeight + 'px';
                if (pos.includes('t') || pos.includes('l')) {
                    elem.style.top = newTop + 'px';
                    elem.style.left = newLeft + 'px';
                }
            },
            
            toggleLock: function(id) {
                const elemData = this.elements.find(el => el.id === id);
                if (!elemData) return;
                
                elemData.locked = !elemData.locked;
                const lockBtn = elemData.element.querySelector('.layout-lock-btn i');
                
                if (elemData.locked) {
                    elemData.element.classList.add('locked');
                    lockBtn.className = 'fa-solid fa-lock';
                } else {
                    elemData.element.classList.remove('locked');
                    lockBtn.className = 'fa-solid fa-lock-open';
                }
                this.saveLayout(id);
            },
            
            lockAll: function() {
                this.elements.forEach(el => {
                    if (!el.locked) this.toggleLock(el.id);
                });
            },
            
            unlockAll: function() {
                this.elements.forEach(el => {
                    if (el.locked) this.toggleLock(el.id);
                });
            },
            
            resetElement: function(id) {
                const elemData = this.elements.find(el => el.id === id);
                if (!elemData || !elemData.options.defaultPos) return;
                
                const elem = elemData.element;
                const defaults = elemData.options.defaultPos;
                
                Object.keys(defaults).forEach(key => {
                    elem.style[key] = typeof defaults[key] === 'number' ? defaults[key] + 'px' : defaults[key];
                });
                this.saveLayout(id);
            },
            
            resetAll: function() {
                this.elements.forEach(el => this.resetElement(el.id));
            },
            
            saveLayout: function(id) {
                const elemData = this.elements.find(el => el.id === id);
                if (!elemData) return;
                
                const elem = elemData.element;
                const layoutData = {
                    top: elem.style.top,
                    left: elem.style.left,
                    right: elem.style.right,
                    bottom: elem.style.bottom,
                    width: elem.style.width,
                    height: elem.style.height,
                    transform: elem.style.transform,
                    locked: elemData.locked
                };
                localStorage.setItem(`layout_${id}`, JSON.stringify(layoutData));
            },
            
            loadLayouts: function() {
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('layout_')) {
                        const id = key.replace('layout_', '');
                        const layoutData = JSON.parse(localStorage.getItem(key));
                        
                        setTimeout(() => {
                            const elem = document.getElementById(id);
                            if (elem) {
                                Object.keys(layoutData).forEach(prop => {
                                    if (prop === 'locked') return;
                                    elem.style[prop] = layoutData[prop];
                                });
                                if (layoutData.locked) this.toggleLock(id);
                            }
                        }, 100);
                    }
                });
            },
            
            toggleMasterPanel: function() {
                const panel = document.getElementById('layout-master-panel');
                const btn = document.querySelector('.layout-toggle-btn');
                
                if (panel.classList.contains('active')) {
                    panel.classList.remove('active');
                    btn.classList.remove('active');
                } else {
                    panel.classList.add('active');
                    btn.classList.add('active');
                }
            },
            
            createMasterPanel: function() {
                const panelHtml = `
                    <button class="layout-toggle-btn" onclick="LayoutController.toggleMasterPanel()">
                        <i class="fa-solid fa-sliders"></i>
                    </button>
                    <div id="layout-master-panel">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h3 style="color: var(--fresh-mint); font-weight: bold; font-size: 16px;">
                                <i class="fa-solid fa-grip-vertical" style="margin-right: 8px;"></i>Layout Control
                            </h3>
                            <button onclick="LayoutController.toggleMasterPanel()" style="background: none; border: none; color: #888; cursor: pointer; font-size: 18px;">
                                <i class="fa-solid fa-times"></i>
                            </button>
                        </div>
                        <div style="font-size: 11px; color: #888; margin-bottom: 12px; line-height: 1.4;">
                            Customize your workspace! Drag, resize, and lock any element.
                        </div>
                        <button class="layout-panel-btn" onclick="LayoutController.unlockAll()">
                            <i class="fa-solid fa-unlock"></i> Unlock All Elements
                        </button>
                        <button class="layout-panel-btn" onclick="LayoutController.lockAll()">
                            <i class="fa-solid fa-lock"></i> Lock All Elements
                        </button>
                        <button class="layout-panel-btn" onclick="LayoutController.resetAll()">
                            <i class="fa-solid fa-rotate-left"></i> Reset All Positions
                        </button>
                        <div style="margin-top: 12px; padding: 12px; background: rgba(0,242,234,0.05); border-radius: 8px; border: 1px solid rgba(0,242,234,0.2);">
                            <div style="font-size: 11px; color: var(--fresh-mint); font-weight: bold; margin-bottom: 6px;">
                                <i class="fa-solid fa-lightbulb" style="margin-right: 6px;"></i>Pro Tips
                            </div>
                            <ul style="font-size: 10px; color: #aaa; line-height: 1.6; padding-left: 16px; margin: 0;">
                                <li>Hover elements to see controls</li>
                                <li>Drag title bar to move</li>
                                <li>Drag corners/edges to resize</li>
                                <li>Click lock 🔒 to freeze in place</li>
                                <li>Layouts save automatically</li>
                            </ul>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', panelHtml);
            }
        };
        // ===== END LAYOUT CONTROLLER =====

        // --- Memory & Learning Module ---
        const MemoryModule = {
            save: (trigger, action) => {
                state.memory[trigger.toLowerCase()] = action;
                localStorage.setItem('papi_memory', JSON.stringify(state.memory));
            },
            recall: (trigger) => {
                return state.memory[trigger.toLowerCase()] || null;
            },
            
            // Visual learning effect
            indicateLearning: (isLearning) => {
                const ship = document.getElementById('the-ship');
                if(!ship) return;
                
                if(isLearning) {
                    ship.classList.add('learning');
                    // Reveal alien just for effect if hidden? Let's keep surprise unless bought
                } else {
                    setTimeout(() => ship.classList.remove('learning'), 2000);
                }
            }
        };

        // Audio System
        function initAudio() {
            if (!state.audioCtx) state.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playSound(type, intensity = 1) {
            initAudio();
            const ctx = state.audioCtx;
            if(ctx.state === 'suspended') ctx.resume();

            const t = ctx.currentTime;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            if (type === 'rumble') {
                // Low Rumble
                const bufferSize = ctx.sampleRate * 2; 
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 100;
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                gain.gain.setValueAtTime(0.5 * intensity, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 1.5);
                noise.start(t);
            } else if (type === 'crack') {
                // High Crack
                const bufferSize = ctx.sampleRate * 0.2; 
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = ctx.createBiquadFilter();
                filter.type = 'highpass';
                filter.frequency.value = 1000;
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                gain.gain.setValueAtTime(0.8, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 0.1);
                noise.start(t);
            } else if (type === 'thunder') {
                // Big Crash
                const bufferSize = ctx.sampleRate * 3; 
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                const noise = ctx.createBufferSource();
                noise.buffer = buffer;
                const filter = ctx.createBiquadFilter();
                filter.type = 'lowpass';
                filter.frequency.value = 200;
                noise.connect(filter);
                filter.connect(gain);
                gain.connect(ctx.destination);
                gain.gain.setValueAtTime(1.0 * intensity, t);
                gain.gain.exponentialRampToValueAtTime(0.01, t + 2.5);
                noise.start(t);
            } else if (type === 'alien_speech') {
                // Synthesized Alien chatter "BZZWEED..."
                osc.type = 'sawtooth';
                osc.frequency.setValueAtTime(200, t);
                osc.frequency.linearRampToValueAtTime(800, t + 0.1);
                osc.frequency.linearRampToValueAtTime(100, t + 0.2);
                osc.frequency.linearRampToValueAtTime(600, t + 0.3);
                osc.frequency.linearRampToValueAtTime(150, t + 0.5);
                
                // Modulation
                const lfo = ctx.createOscillator();
                lfo.type = 'square';
                lfo.frequency.value = 50;
                const lfoGain = ctx.createGain();
                lfoGain.gain.value = 500;
                lfo.connect(lfoGain);
                lfoGain.connect(osc.frequency);
                
                osc.connect(gain);
                gain.connect(ctx.destination);
                gain.gain.setValueAtTime(0.3, t);
                gain.gain.linearRampToValueAtTime(0, t + 1.0);
                
                osc.start(t);
                lfo.start(t);
                osc.stop(t + 1.0);
                lfo.stop(t + 1.0);
            }
        }

        // Visual FX
        // Sound effects for lightning
        const thunderSound = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBVSs6PGsbRkLXrTp7qljGApZsOf0r2oXBV65+//HeiwFP5n/8pBRDA==');
        const crackleSound = new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQAAAAA=');
        
        function playThunderSound() {
            try {
                const thunder = thunderSound.cloneNode();
                thunder.volume = 0.3;
                thunder.play().catch(() => {});
            } catch (e) {}
        }
        
        function playCrackleSound() {
            try {
                const crackle = crackleSound.cloneNode();
                crackle.volume = 0.2;
                crackle.play().catch(() => {});
            } catch (e) {}
        }

        function drawLightning(intensity) {
            const canvas = document.getElementById('lightning-canvas');
            const ctx = canvas.getContext('2d');
            const ship = document.getElementById('ship-engine').getBoundingClientRect();
            const chat = document.getElementById('chat-bar').getBoundingClientRect();
            const scene = document.querySelector('.scene').getBoundingClientRect();

            canvas.width = scene.width;
            canvas.height = scene.height;

            const startX = scene.width / 2; 
            const startY = (ship.bottom - scene.top) - 50; 
            const endX = scene.width / 2;
            const endY = (chat.top - scene.top);

            // Play sounds
            playThunderSound();
            playCrackleSound();

            // Draw main lightning bolt
            ctx.save();
            ctx.beginPath();
            ctx.moveTo(startX, startY);
            
            let currX = startX;
            let currY = startY;
            const segments = 25;
            const dy = (endY - startY) / segments;
            const spread = Math.min(120, intensity * 2.5);
            
            const mainPath = [{x: startX, y: startY}];

            for (let i = 0; i < segments; i++) {
                currY += dy;
                currX += (Math.random() - 0.5) * spread; 
                ctx.lineTo(currX, currY);
                mainPath.push({x: currX, y: currY});
            }
            ctx.lineTo(endX, endY);
            mainPath.push({x: endX, y: endY});

            // Main bolt styling
            ctx.strokeStyle = '#00f2ea';
            ctx.lineWidth = 3 + (intensity / 8);
            ctx.shadowBlur = 20;
            ctx.shadowColor = '#00f2ea';
            ctx.stroke();
            
            // Add glow layer
            ctx.strokeStyle = 'rgba(0, 242, 234, 0.5)';
            ctx.lineWidth = 8 + (intensity / 5);
            ctx.shadowBlur = 30;
            ctx.stroke();

            // Draw branching bolts
            ctx.restore();
            const branchCount = 8 + Math.floor(intensity / 10);
            for (let b = 0; b < branchCount; b++) {
                const branchStart = mainPath[Math.floor(Math.random() * (mainPath.length - 5)) + 3];
                const branchLength = 30 + Math.random() * 80;
                const branchSegments = 5 + Math.floor(Math.random() * 8);
                
                ctx.beginPath();
                ctx.moveTo(branchStart.x, branchStart.y);
                
                let bx = branchStart.x;
                let by = branchStart.y;
                const direction = Math.random() > 0.5 ? 1 : -1;
                
                for (let i = 0; i < branchSegments; i++) {
                    bx += (Math.random() - 0.3) * 40 * direction;
                    by += branchLength / branchSegments;
                    ctx.lineTo(bx, by);
                }
                
                ctx.strokeStyle = `rgba(0, 242, 234, ${0.6 - (b / branchCount) * 0.4})`;
                ctx.lineWidth = 1.5;
                ctx.shadowBlur = 10;
                ctx.shadowColor = '#00f2ea';
                ctx.stroke();
            }

            setTimeout(() => { ctx.clearRect(0,0, canvas.width, canvas.height); }, 180 + (intensity * 5));
        }

        const actions = {
            detachWindow: () => {
                const w = 1200, h = 800;
                const left = (screen.width/2)-(w/2);
                const top = (screen.height/2)-(h/2);
                const newWin = window.open('', '_blank', `width=${w},height=${h},top=${top},left=${left}`);
                if(newWin) {
                    newWin.document.write(document.documentElement.outerHTML);
                    newWin.document.close();
                } else {
                    alert("Pop-up blocked!");
                }
            },
            nav: (view) => {
                const body = document.body;
                if (viewId === 'alien') body.classList.add('alien-mode');
                else body.classList.remove('alien-mode');
                nav(view);
                addChat('ai', `Switched view to ${view.toUpperCase()}.`);
            },
            genKey: () => {
                const array = new Uint32Array(8);
                window.crypto.getRandomValues(array);
                let hex = '';
                array.forEach(val => hex += val.toString(16).padStart(8, '0'));
                state.currentKey = hex.toUpperCase().match(/.{1,4}/g).join('-');
                
                const secEl = document.getElementById('sec-key-display');
                if(secEl) secEl.innerText = state.currentKey;
                const widEl = document.getElementById('widget-key');
                if(widEl) {
                    const last4 = state.currentKey.slice(-4);
                    widEl.innerText = `••••-••••-••••-${last4}`;
                }
                return state.currentKey;
            },
            copyKey: () => { if(state.currentKey) navigator.clipboard.writeText(state.currentKey); },
            calcRF: () => {
                const pt = parseFloat(document.getElementById('rf-tx').value);
                const d = parseFloat(document.getElementById('rf-dist').value);
                const f = parseFloat(document.getElementById('rf-freq').value) * 1e9;
                
                document.getElementById('val-tx').innerText = pt;
                document.getElementById('val-dist').innerText = d;
                document.getElementById('val-freq').innerText = (f/1e9).toFixed(1);

                const c = 3e8;
                const lambda = c / f;
                const pr = pt * Math.pow(lambda / (4 * Math.PI * d), 2);
                const uW = pr * 1e6;
                const dBm = 10 * Math.log10(pr * 1000);

                document.getElementById('rf-main-res').innerText = uW.toFixed(2);
                document.getElementById('widget-rf').innerText = uW.toFixed(1);
                document.getElementById('rf-dbm-res').innerText = `Signal Strength: ${dBm.toFixed(1)} dBm`;
                return uW;
            },
            repairCode: () => {
                const area = document.getElementById('code-editor');
                if(!area.value) return false;
                area.value = area.value.replace(/^\s*[\r\n]/gm, '');
                return true;
            },
            toggleMic: () => {
                const btn = document.getElementById('mic-btn');
                if(!state.recognition) initSpeech();
                if(btn.classList.contains('mic-active')) {
                    state.recognition.stop();
                    btn.classList.remove('mic-active');
                    btn.style.color = "#94a3b8";
                } else {
                    try { state.recognition.start(); } catch(e){}
                    btn.classList.add('mic-active');
                }
            },
            sendCmd: (cmdText) => {
                const input = document.getElementById('cmd-input');
                const txt = cmdText || input.value.trim();
                if(!txt) return;
                
                // 1. Rock the ship based on input length
                const ship = document.getElementById('the-ship');
                if(ship) {
                    const tilt = Math.min(10, txt.length / 5);
                    ship.style.transform = `scale(0.9) rotateZ(${tilt}deg) translateY(10px)`;
                    setTimeout(() => { ship.style.transform = ''; }, 300);
                }

                addChat('user', txt);
                input.value = '';
                processCommand(txt);
            },
            positionAlien: () => {
                const controlPanel = document.getElementById('alien-position-controls');
                if (controlPanel.classList.contains('hidden')) {
                    controlPanel.classList.remove('hidden');
                    updateAlienPositionDisplay();
                } else {
                    controlPanel.classList.add('hidden');
                }
            },
            buyApp: () => {
                const ship = document.getElementById('the-ship');
                const alien = document.querySelector('.alien-pilot');
                
                // 1. Reveal Alien First
                alien.classList.add('visible');
                playSound('success', 0.5);
                
                // 2. Start Delivery Animation with ladder
                setTimeout(() => {
                    ship.classList.add('delivering');
                    playSound('alien_speech');
                    
                    // Add chat messages during delivery
                    addChat('alien', 'Delivering your app...');
                }, 500);
                
                // 3. Alien reaches you
                setTimeout(() => {
                    addChat('alien', "Thank you, earthling! 👽");
                    playSound('success', 0.7);
                }, 2000);
                
                // 4. Complete delivery, alien returns
                setTimeout(() => {
                    ship.classList.remove('delivering');
                    addChat('ai', '✅ App installed successfully!');
                }, 3500);
                
                // 5. Alien waves and prepares for takeoff
                setTimeout(() => {
                    addChat('alien', "Time to return home... 🚀");
                }, 4500);
                
                // 6. TAKEOFF SEQUENCE with purple trail
                setTimeout(() => {
                    SpaceshipController.triggerTakeoff();
                    addChat('alien', "See you next time, human! 💜");
                }, 5500);
                
                // 7. Reset everything after takeoff
                setTimeout(() => {
                    alien.classList.remove('visible');
                    addChat('ai', "System ready.");
                }, 8500);
            },
            toggleAppsMenu: () => {
                console.log('Apps button clicked!'); // Debug log
                const menu = document.getElementById('appsMenu');
                console.log('Menu element:', menu); // Debug log
                menu.classList.toggle('hidden');
                console.log('Menu hidden?', menu.classList.contains('hidden')); // Debug log
                
                // Show/hide alien when apps menu opens/closes
                if (!menu.classList.contains('hidden')) {
                    SpaceshipController.showAlien();
                } else {
                    SpaceshipController.hideAlien();
                }
            }
        };

        function nav(viewId) {
            const body = document.body;
            if (viewId === 'alien') body.classList.add('alien-mode');
            else body.classList.remove('alien-mode');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${viewId}`).classList.add('active');
            document.querySelectorAll('[id^="view-"]').forEach(v => v.classList.add('hidden'));
            document.getElementById(`view-${viewId}`).classList.remove('hidden');
            const titles = {
                'home': ['Overview', 'System Status: Optimal'],
                'security': ['Security Nexus', 'Encryption Level: AES-256'],
                'rf': ['RF Power Lab', 'Atmospheric Analysis'],
                'dev': ['Developer Console', 'Repair & Debug'],
                'alien': ['Alien AI Assistant', 'Extraterrestrial Marketplace']
            };
            document.getElementById('page-title').innerText = titles[viewId][0];
            document.getElementById('page-subtitle').innerText = titles[viewId][1];
        }

        function addChat(role, text, chips = []) {
            const feed = document.getElementById('chat-feed');
            const wrap = document.createElement('div');
            wrap.className = `flex w-full slide-up ${role === 'user' ? 'justify-end' : 'justify-end'}`;
            const bub = document.createElement('div');
            bub.className = `p-3 text-sm font-medium break-words ${role === 'user' ? 'bubble-user text-cyan-50' : 'bubble-ai text-blue-100'}`;
            bub.style.cssText = 'max-width: 90%; word-break: break-word; white-space: pre-wrap; line-height: 1.5;';
            bub.innerText = text;
            wrap.appendChild(bub);
            feed.appendChild(wrap);
            if(chips.length) {
                const chipWrap = document.createElement('div');
                chipWrap.className = "flex gap-2 mt-1 ml-2 slide-up flex-wrap";
                chips.forEach(c => {
                    const btn = document.createElement('button');
                    btn.className = "px-2 py-1 text-[10px] bg-white/5 border border-white/10 rounded hover:bg-white/10 text-cyan-400 transition-colors";
                    btn.innerText = c;
                    btn.onclick = () => { document.getElementById('cmd-input').value = c; actions.sendCmd(); };
                    chipWrap.appendChild(btn);
                });
                feed.appendChild(chipWrap);
            }
            
            // Keep only last 6 message groups (3 exchanges) for readability
            while (feed.children.length > 12) {
                feed.removeChild(feed.firstChild);
            }
            
            // Auto-expand chat if it was minimized
            const chatContainer = document.getElementById('chat-container');
            if (chatContainer && chatContainer.classList.contains('chat-minimized')) {
                toggleChatFeed();
            }
            
            feed.scrollTop = feed.scrollHeight;
            
            // Update message counter for free users
            updateMessageCounter();
            
            if(role === 'ai') {
                if(state.voiceActive) speak(text);
                const ship = document.getElementById('the-ship');
                if(ship && !document.getElementById('view-alien').classList.contains('hidden')) {
                    const intensity = Math.min(2, text.length / 20); 
                    ship.classList.add('shake-ship');
                    playSound('rumble', intensity); 
                    setTimeout(() => {
                        playSound('crack'); 
                        drawLightning(text.length); 
                        setTimeout(() => {
                            playSound('thunder', intensity); 
                            ship.classList.remove('shake-ship');
                        }, 150); 
                    }, 400); 
                }
            }
        }
        
        // Update message counter display
        function updateMessageCounter() {
            const counter = document.getElementById('message-counter');
            const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
            const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
            const hasPaidLicense = localStorage.getItem('papi_license') === 'active';
            
            if (isMasterAdmin || hasBetaLicense || hasPaidLicense) {
                counter.classList.add('hidden');
                return;
            }
            
            const messageCount = parseInt(localStorage.getItem('ai_message_count') || '0');
            const maxMessages = 10;
            const remaining = maxMessages - messageCount;
            
            if (remaining <= maxMessages && remaining > 0) {
                counter.classList.remove('hidden');
                const span = counter.querySelector('span');
                const color = remaining <= 3 ? 'text-amber-400' : 'text-cyan-400';
                span.className = `${color} font-mono`;
                span.innerText = `💬 ${remaining} free messages remaining • Upgrade to AI Pro for unlimited`;
            } else if (remaining <= 0) {
                counter.classList.remove('hidden');
                const span = counter.querySelector('span');
                span.className = 'text-red-400 font-mono animate-pulse';
                span.innerText = `🚀 Free messages used • Upgrade to AI Assistant Pro for unlimited intelligent conversations!`;
            }
        }

        // ============================================
        // SETTINGS PANEL FUNCTIONS
        // ============================================
        function maskAPIKey(input) {
            const value = input.value;
            const fullKey = input.getAttribute('data-full-key');
            
            // If user is typing and key is longer than what's displayed
            if (value.length > (fullKey ? fullKey.length : 0)) {
                // User is adding characters - store full key
                input.setAttribute('data-full-key', value);
                
                // Display masked version (show first 8 and last 8)
                if (value.length > 16 && value.startsWith('sk-')) {
                    const masked = value.substring(0, 8) + '...' + value.substring(value.length - 8);
                    input.value = masked;
                }
            } else if (value.length < (fullKey ? fullKey.length : 0)) {
                // User is deleting - clear stored key
                input.setAttribute('data-full-key', value);
            }
        }
        
        function openSettings() {
            document.getElementById('settingsModal').classList.remove('hidden');
            loadSettings();
        }

        function closeSettings() {
            document.getElementById('settingsModal').classList.add('hidden');
            // Clear conversation history when closing settings so user gets fresh start
            localStorage.removeItem('ai_history');
            if (typeof AlienAI !== 'undefined') {
                AlienAI.conversationHistory = [];
            }
        }

        function loadSettings() {
            // Migrate old single key to new multi-key system
            const oldKey = localStorage.getItem('openai_api_key');
            if (oldKey && !localStorage.getItem('openai_api_key1')) {
                localStorage.setItem('openai_api_key1', oldKey);
                localStorage.setItem('openai_key1_label', 'Primary Key');
                localStorage.removeItem('openai_api_key'); // Clean up old format
            }
            
            // Load current provider
            const provider = localStorage.getItem('ai_provider') || 'demo';
            document.getElementById('aiProvider').value = provider;

            // Load OpenAI keys (4 keys)
            for (let i = 1; i <= 4; i++) {
                const key = localStorage.getItem(`openai_api_key${i}`) || '';
                const label = localStorage.getItem(`openai_key${i}_label`) || '';
                const input = document.getElementById(`openaiKey${i}`);
                const labelInput = document.getElementById(`key${i}-label`);
                
                if (input) {
                    // Store full key in data attribute
                    input.setAttribute('data-full-key', key);
                    // Display masked version
                    if (key.length > 16 && key.startsWith('sk-')) {
                        input.value = key.substring(0, 8) + '...' + key.substring(key.length - 8);
                    } else {
                        input.value = key;
                    }
                }
                
                if (labelInput) {
                    labelInput.value = label;
                }
            }
            
            // Load other provider keys
            document.getElementById('claudeKey').value = localStorage.getItem('claude_api_key') || '';
            document.getElementById('geminiKey').value = localStorage.getItem('gemini_api_key') || '';
            
            // Load app assignments
            document.getElementById('assign-alien').value = localStorage.getItem('assign-alien') || 'auto';
            document.getElementById('assign-code').value = localStorage.getItem('assign-code') || 'key1';
            document.getElementById('assign-aegis').value = localStorage.getItem('assign-aegis') || 'key3';
            document.getElementById('assign-automation').value = localStorage.getItem('assign-automation') || 'key1';
            
            // Load usage stats
            const totalCalls = localStorage.getItem('total_api_calls') || '0';
            if (document.getElementById('total-calls')) {
                document.getElementById('total-calls').textContent = totalCalls;
            }

            // Update status indicators
            updateStatusIndicators();
        }

        function updateStatusIndicators() {
            // Count configured OpenAI keys
            let configuredKeys = 0;
            for (let i = 1; i <= 4; i++) {
                const key = localStorage.getItem(`openai_api_key${i}`);
                const statusEl = document.getElementById(`key${i}-status`);
                if (key && key.length > 10) {
                    configuredKeys++;
                    if (statusEl) {
                        statusEl.textContent = '✓';
                        statusEl.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-green-400';
                    }
                } else {
                    if (statusEl) {
                        statusEl.textContent = '—';
                        statusEl.className = 'text-xs px-2 py-1 rounded bg-gray-700 text-gray-500';
                    }
                }
            }
            
            // Update main OpenAI status
            const openaiStatus = document.getElementById('openai-status');
            if (openaiStatus) {
                openaiStatus.textContent = `${configuredKeys}/4 Keys`;
                if (configuredKeys > 0) {
                    openaiStatus.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-green-400 border border-green-500/30';
                } else {
                    openaiStatus.className = 'text-xs px-2 py-1 rounded bg-gray-700 text-gray-400';
                }
            }
            
            // Update other providers
            const claudeKey = localStorage.getItem('claude_api_key');
            const geminiKey = localStorage.getItem('gemini_api_key');
            updateStatus('claude', claudeKey);
            updateStatus('gemini', geminiKey);
        }

        function updateStatus(provider, key) {
            const statusEl = document.getElementById(`${provider}-status`);
            if (key && key.length > 10) {
                statusEl.textContent = '✓ Configured';
                statusEl.className = 'text-xs px-2 py-1 rounded bg-green-900/50 text-green-400 border border-green-500/30';
            } else {
                statusEl.textContent = 'Not Configured';
                statusEl.className = 'text-xs px-2 py-1 rounded bg-gray-700 text-gray-400';
            }
        }

        function updateProvider() {
            const provider = document.getElementById('aiProvider').value;
            addChat('ai', `Switched to ${provider === 'demo' ? 'Demo Mode' : provider.toUpperCase()} provider.`);
        }

        function saveSettings() {
            // Save provider
            const provider = document.getElementById('aiProvider').value;
            localStorage.setItem('ai_provider', provider);

            // Save OpenAI keys (4 keys) - with validation
            let keyCount = 0;
            for (let i = 1; i <= 4; i++) {
                const keyInput = document.getElementById(`openaiKey${i}`);
                const labelInput = document.getElementById(`key${i}-label`);
                
                if (keyInput) {
                    // Get full key from data attribute, or current value if just entered
                    let key = keyInput.getAttribute('data-full-key') || keyInput.value.trim();
                    
                    // Only save if it looks like a valid API key (starts with sk-)
                    if (key && key.startsWith('sk-') && !key.includes('...')) {
                        localStorage.setItem(`openai_api_key${i}`, key);
                        keyCount++;
                        console.log(`Saved key ${i}: ${key.substring(0, 10)}...${key.substring(key.length - 4)}`);
                    }
                }
                
                if (labelInput && labelInput.value) {
                    const label = labelInput.value.trim();
                    if (label) {
                        localStorage.setItem(`openai_key${i}_label`, label);
                    }
                }
            }
            
            // Save other provider keys
            const claudeInput = document.getElementById('claudeKey');
            const geminiInput = document.getElementById('geminiKey');
            
            if (claudeInput && claudeInput.value) {
                const claudeKey = claudeInput.value.trim();
                if (claudeKey && claudeKey.startsWith('sk-ant-')) {
                    localStorage.setItem('claude_api_key', claudeKey);
                }
            }
            
            if (geminiInput && geminiInput.value) {
                const geminiKey = geminiInput.value.trim();
                if (geminiKey) {
                    localStorage.setItem('gemini_api_key', geminiKey);
                }
            }
            
            // Save app assignments
            localStorage.setItem('assign-alien', document.getElementById('assign-alien').value);
            localStorage.setItem('assign-code', document.getElementById('assign-code').value);
            localStorage.setItem('assign-aegis', document.getElementById('assign-aegis').value);
            localStorage.setItem('assign-automation', document.getElementById('assign-automation').value);

            updateStatusIndicators();
            
            if (keyCount > 0) {
                addChat('ai', `✓ Settings saved! ${keyCount} OpenAI keys configured with smart rotation enabled.`);
            } else {
                addChat('ai', '⚠️ No valid OpenAI keys detected. Make sure they start with "sk-"');
            }
            
            closeSettings();

            // Reload AlienAI config
            if (typeof AlienAI !== 'undefined') {
                AlienAI.config.provider = provider;
            }
        }

        async function testAllKeys() {
            const results = [];
            
            const openaiKey = document.getElementById('openaiKey').value.trim();
            const claudeKey = document.getElementById('claudeKey').value.trim();
            const geminiKey = document.getElementById('geminiKey').value.trim();

            addChat('ai', '🧪 Testing API keys...');

            if (openaiKey) {
                const result = await testAPIKey('openai', openaiKey);
                results.push(`OpenAI: ${result ? '✓ Valid' : '✗ Failed'}`);
            }
            if (claudeKey) {
                const result = await testAPIKey('claude', claudeKey);
                results.push(`Claude: ${result ? '✓ Valid' : '✗ Failed'}`);
            }
            if (geminiKey) {
                const result = await testAPIKey('gemini', geminiKey);
                results.push(`Gemini: ${result ? '✓ Valid' : '✗ Failed'}`);
            }

            if (results.length === 0) {
                addChat('ai', 'No API keys to test. Please enter at least one key.');
            } else {
                addChat('ai', 'Test Results:\\n' + results.join('\\n'));
            }
        }

        async function testAPIKey(provider, key) {
            try {
                if (provider === 'openai') {
                    const response = await fetch('https://api.openai.com/v1/models', {
                        headers: { 'Authorization': `Bearer ${key}` }
                    });
                    return response.ok;
                } else if (provider === 'claude') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'x-api-key': key,
                            'anthropic-version': '2023-06-01',
                            'content-type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: 'claude-3-5-sonnet-20241022',
                            max_tokens: 1,
                            messages: [{ role: 'user', content: 'test' }]
                        })
                    });
                    return response.ok || response.status === 400; // 400 means auth worked
                } else if (provider === 'gemini') {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                    return response.ok;
                }
            } catch (error) {
                console.error(`${provider} test failed:`, error);
                return false;
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('settingsModal');
            if (e.target === modal) {
                closeSettings();
            }
        });

        // ============================================
        // ALIEN AI BRAIN - Real AI Integration Module
        // ============================================
        const AlienAI = {
            config: {
                // User can configure their API choice and key
                provider: localStorage.getItem('ai_provider') || 'demo', // 'openai', 'claude', 'gemini', or 'demo'
                apiKey: localStorage.getItem('ai_api_key') || '',
                model: 'gpt-4', // or 'claude-3-sonnet', 'gemini-pro'
                temperature: 0.7,
                maxTokens: 1000
            },
            
            conversationHistory: JSON.parse(localStorage.getItem('ai_history') || '[]'),
            userProfile: JSON.parse(localStorage.getItem('user_profile') || '{"projects": [], "preferences": {}, "expertise": "beginner"}'),
            messageCount: parseInt(localStorage.getItem('ai_message_count') || '0'),
            maxFreeMessages: 10, // Free users get 10 messages
            
            // Track message count
            incrementMessageCount() {
                AlienAI.messageCount++;
                localStorage.setItem('ai_message_count', AlienAI.messageCount.toString());
            },
            
            // Check if user has reached limit
            hasReachedLimit() {
                const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
                const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
                const hasPaidLicense = localStorage.getItem('papi_license') === 'active';
                
                // Unlimited for admins and paid users
                if (isMasterAdmin || hasBetaLicense || hasPaidLicense) return false;
                
                // Check limit for free users
                return AlienAI.messageCount >= AlienAI.maxFreeMessages;
            },
            
            // Check if user has valid API configuration
            isPremium: () => {
                // MASTER ADMIN BYPASS - Troy Walker gets full access always
                const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
                if (isMasterAdmin) return true;
                
                // Beta tester license gives full access
                const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
                if (hasBetaLicense) return true;
                
                // If they have any valid API key configured, consider them premium
                const hasOpenAI = localStorage.getItem('openai_api_key1') || localStorage.getItem('openai_api_key2') || 
                                  localStorage.getItem('openai_api_key3') || localStorage.getItem('openai_api_key4');
                const hasClaude = localStorage.getItem('claude_api_key');
                const hasGemini = localStorage.getItem('gemini_api_key');
                const hasLicense = localStorage.getItem('papi_license') === 'active';
                
                return hasOpenAI || hasClaude || hasGemini || hasLicense;
            },
            
            // Main AI call function
            async ask(userMessage, context = {}) {
                // Master Admin and Beta Testers: UNLIMITED ACCESS
                const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
                const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
                
                // Check message limit for free users
                if (AlienAI.hasReachedLimit()) {
                    return {
                        response: `🚀 **You've used all ${AlienAI.maxFreeMessages} free messages!**\n\nUpgrade to **AI Assistant Pro** ($49.99/mo) for:\n✨ Unlimited conversations\n🧠 Smarter responses with GPT-4\n💻 Advanced code generation\n🔄 Memory & context awareness\n\nReady to unlock your AI potential?`,
                        needsUpgrade: true
                    };
                }
                
                // Increment message count for non-premium users
                if (!isMasterAdmin && !hasBetaLicense && !AlienAI.isPremium()) {
                    AlienAI.incrementMessageCount();
                    const remaining = AlienAI.maxFreeMessages - AlienAI.messageCount;
                    if (remaining <= 3 && remaining > 0) {
                        // Warn when running low
                        console.log(`⚠️ ${remaining} free messages remaining`);
                    }
                }
                
                // Add to history
                AlienAI.conversationHistory.push({role: 'user', content: userMessage, timestamp: Date.now()});
                AlienAI.saveHistory();
                
                let response;
                
                // Master Admin and Beta Testers get enhanced demo mode (no limitations)
                if ((isMasterAdmin || hasBetaLicense) && AlienAI.config.provider === 'demo') {
                    // Enhanced demo with no restrictions for admin/beta
                    response = await AlienAI.enhancedDemoMode(userMessage, context);
                } else if (AlienAI.config.provider === 'demo') {
                    // Smart template-based responses
                    response = await AlienAI.demoMode(userMessage, context);
                } else {
                    // Real API call
                    response = await AlienAI.callAPI(userMessage, context);
                }
                
                AlienAI.conversationHistory.push({role: 'assistant', content: response, timestamp: Date.now()});
                AlienAI.saveHistory();
                
                // Learn from interaction
                AlienAI.learn(userMessage, response);
                
                return {response, needsUpgrade: false};
            },
            
            // Enhanced Demo Mode for Master Admin/Beta (SMART & VARIED)
            async enhancedDemoMode(message, context) {
                const msg = message.toLowerCase();
                const responses = AlienAI.conversationHistory.filter(h => h.role === 'assistant').length;
                
                // Varied greetings
                if (msg.includes('hello') || msg.includes('hi ') || msg === 'hi' || msg.includes('hey') || msg.includes('greet')) {
                    const greetings = [
                        "🛸 Greetings, Earth developer! I'm your alien AI companion from the Andromeda sector. Ready to code something extraordinary?",
                        "👽 Hello there! I've analyzed 47 galaxies worth of code patterns. What shall we build today?",
                        "✨ Hey! Your neural patterns suggest you're ready for something awesome. What's on your mind?",
                        "🌌 Greetings, human! I've been orbiting your workspace waiting for this moment. Let's create something amazing!"
                    ];
                    return greetings[responses % greetings.length];
                }
                
                // Code generation - DETAILED responses
                if (msg.includes('build') || msg.includes('create') || msg.includes('make') || msg.includes('generate')) {
                    if (msg.includes('todo') || msg.includes('task')) {
                        return `🚀 **Todo App Coming Right Up!**\n\nI'll create a modern React-style todo app with:\n✅ Add/Edit/Delete tasks\n✅ Local storage persistence\n✅ Beautiful animations\n✅ Filter by complete/incomplete\n\n${AlienAI.templates.todoApp()}\n\nWant me to add priority levels or due dates?`;
                    }
                    else if (msg.includes('calculator')) {
                        return `🔢 **Advanced Calculator Build**\n\nFeatures included:\n• Basic operations (+, -, ×, ÷)\n• Memory functions (M+, M-, MR, MC)\n• Scientific mode option\n• Keyboard support\n\n${AlienAI.templates.calculator()}\n\nNeed graphing capabilities or unit conversion?`;
                    }
                    else if (msg.includes('form') || msg.includes('contact')) {
                        return `📧 **Professional Contact Form**\n\nI'm building you:\n✉️ Email validation\n📝 Multi-field support\n✨ Smooth animations\n🔒 Basic spam protection\n\n${AlienAI.templates.contactForm()}\n\nWant to add reCAPTCHA or custom styling?`;
                    }
                    else if (msg.includes('dashboard')) {
                        return `📊 **Dashboard Template Ready!**\n\nComplete with:\n📈 Chart components\n🎨 Modern UI cards\n📱 Responsive layout\n⚡ Real-time updates\n\n${AlienAI.templates.dashboard()}\n\nNeed integration with a specific API or database?`;
                    }
                    else if (msg.includes('api') || msg.includes('server') || msg.includes('backend')) {
                        return `⚙️ **Backend/API Development**\n\nI can help you build:\n• REST APIs with Express.js\n• GraphQL endpoints\n• Authentication systems (JWT, OAuth)\n• Database integration (MongoDB, PostgreSQL)\n• WebSocket real-time features\n\nWhat type of backend are you building? Give me details about your project!`;
                    }
                    else if (msg.includes('website') || msg.includes('landing')) {
                        return `🌐 **Website Builder Mode**\n\nI can create:\n• Landing pages with hero sections\n• Multi-page websites\n• Portfolio sites\n• Business homepages\n• E-commerce layouts\n\nWhat's your website about? Tell me the purpose and I'll craft the perfect structure!`;
                    }
                    else {
                        return `🎨 **Custom Build Mode Activated**\n\nI can create anything you imagine!\n\nPopular projects:\n💻 Web apps (React, Vue, vanilla JS)\n🐍 Python scripts & automation\n📱 Mobile-responsive designs\n🎮 Interactive games\n🤖 Chatbots & AI tools\n\nDescribe your project in detail and I'll start coding!`;
                    }
                }
                
                // Debugging help
                if (msg.includes('debug') || msg.includes('error') || msg.includes('fix') || msg.includes('broken') || msg.includes('not working')) {
                    return `🔧 **Debug Mode Engaged**\n\nI'm here to help! To fix your issue, I need:\n\n1. 📋 **The error message** (if any)\n2. 💻 **Relevant code snippet**\n3. 🎯 **What you expected to happen**\n4. ❌ **What's actually happening**\n\nPaste your code or describe the problem, and I'll analyze it with my quantum debugging algorithms!`;
                }
                
                // Learning & explanation
                if (msg.includes('how') || msg.includes('what is') || msg.includes('explain') || msg.includes('teach') || msg.includes('learn')) {
                    if (msg.includes('react')) {
                        return `⚛️ **React Mastery Course**\n\nReact is a component-based UI library. Think of it like LEGO blocks for websites!\n\n**Core Concepts:**\n• Components: Reusable UI pieces\n• Props: Data passed to components\n• State: Data that changes\n• Hooks: Special functions (useState, useEffect)\n\n**Example:**\n\`\`\`jsx\nfunction Greeting({ name }) {\n  const [count, setCount] = useState(0);\n  return <h1>Hello {name}! Clicked {count} times</h1>;\n}\n\`\`\`\n\nWhat specifically about React would you like to dive deeper into?`;
                    }
                    else if (msg.includes('javascript') || msg.includes('js')) {
                        return `🔥 **JavaScript Deep Dive**\n\nJavaScript powers the web! Here's what makes it special:\n\n**Key Features:**\n• Async/Await for clean async code\n• Arrow functions: \`(x) => x * 2\`\n• Destructuring: \`const {name} = user\`\n• Template literals: \`Hello \${name}\`\n• Array methods: map, filter, reduce\n\n**Pro Tip:** Modern JS is all about functional programming and immutability!\n\nWhat JS topic do you want to master?`;
                    }
                    else {
                        return AlienAI.explainConcept(msg);
                    }
                }
                
                // Optimization & architecture
                if (msg.includes('optimize') || msg.includes('faster') || msg.includes('performance') || msg.includes('slow')) {
                    return `⚡ **Performance Optimization Scanner**\n\nLet's make your code blazing fast!\n\n**Common Bottlenecks:**\n🐌 Large bundle sizes → Code splitting\n🐌 Too many re-renders → React.memo, useMemo\n🐌 Slow API calls → Caching, lazy loading\n🐌 Heavy calculations → Web Workers\n🐌 Large images → WebP, lazy loading\n\n**Quick Wins:**\n• Minify & compress assets\n• Use CDNs\n• Implement virtual scrolling\n• Debounce expensive operations\n\nShare your code and I'll identify the bottlenecks!`;
                }
                
                if (msg.includes('architecture') || msg.includes('structure') || msg.includes('organize')) {
                    return `🏗️ **Software Architecture Blueprint**\n\n**Modern App Structure:**\n\`\`\`\nsrc/\n├── components/     # Reusable UI\n├── pages/         # Route components\n├── hooks/         # Custom hooks\n├── services/      # API calls\n├── utils/         # Helper functions\n├── store/         # State management\n└── styles/        # Global styles\n\`\`\`\n\n**Best Practices:**\n✅ Single Responsibility Principle\n✅ DRY (Don't Repeat Yourself)\n✅ SOLID principles\n✅ Composition over inheritance\n\nWhat type of project are you architecting?`;
                }
                
                // Project suggestions
                if (msg.includes('suggest') || msg.includes('recommend') || msg.includes('what should') || msg.includes('idea')) {
                    const suggestions = [
                        `💡 **Project Idea: Real-Time Chat App**\n\nBuild a Slack-like messenger with:\n• WebSocket connections\n• User authentication\n• File sharing\n• Emoji reactions\n\nGreat for learning real-time features!`,
                        `💡 **Project Idea: Personal Finance Tracker**\n\nCreate a budget manager with:\n• Income/expense tracking\n• Category-based analysis\n• Charts & visualizations\n• Export to CSV\n\nPerfect for full-stack practice!`,
                        `💡 **Project Idea: AI Image Generator**\n\nBuild an app that:\n• Integrates with DALL-E/Midjourney API\n• Saves generation history\n• Allows prompt refinement\n• Gallery view\n\nRide the AI wave!`,
                        `💡 **Project Idea: Code Snippet Manager**\n\nDeveloper tool with:\n• Syntax highlighting\n• Tags & search\n• Local storage\n• Export/import\n\nSolve your own problem!`
                    ];
                    return suggestions[responses % suggestions.length];
                }
                
                // Varied general responses based on context
                const generalResponses = [
                    `🌟 Interesting question! Let me think...\n\n"${message}"\n\nI can help with:\n• Writing any type of code\n• Explaining complex concepts\n• Debugging issues\n• Architecture decisions\n• Performance optimization\n\nCould you give me more context about what you're working on?`,
                    `🤔 Analyzing your request...\n\nYou asked: "${message}"\n\nAs an AI from the future (well, outer space), I specialize in:\n✨ Code generation (any language)\n✨ Problem-solving strategies\n✨ Best practices & patterns\n✨ Learning roadmaps\n\nTell me more about your goal, and I'll provide a detailed solution!`,
                    `🔍 Scanning knowledge database...\n\nRegarding: "${message}"\n\nI'm here to help! I can:\n• Build complete applications\n• Refactor messy code\n• Teach programming concepts\n• Review and optimize\n\nBe specific about what you need, and I'll deliver!`
                ];
                
                return generalResponses[responses % generalResponses.length];
            },
            
            // Demo/Template mode (works without API)
            async demoMode(message, context) {
                const msg = message.toLowerCase();
                
                // Code generation requests
                if (msg.includes('build') || msg.includes('create') || msg.includes('make')) {
                    if (msg.includes('todo') || msg.includes('task')) {
                        return AlienAI.templates.todoApp();
                    } else if (msg.includes('calculator')) {
                        return AlienAI.templates.calculator();
                    } else if (msg.includes('form') || msg.includes('contact')) {
                        return AlienAI.templates.contactForm();
                    } else if (msg.includes('dashboard')) {
                        return AlienAI.templates.dashboard();
                    } else {
                        return "I can help you build: Todo App, Calculator, Contact Form, or Dashboard. Which would you like? Or upgrade to AI Pro for unlimited custom code generation!";
                    }
                }
                
                // Learning/teaching
                if (msg.includes('how to') || msg.includes('teach') || msg.includes('explain')) {
                    return AlienAI.explainConcept(msg);
                }
                
                // Project recommendations based on history
                if (msg.includes('suggest') || msg.includes('recommend') || msg.includes('what should')) {
                    return AlienAI.recommendProject();
                }
                
                // General help/greeting responses
                if (msg.includes('hello') || msg.includes('hi ') || msg === 'hi' || msg.includes('hey')) {
                    const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
                    const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
                    
                    if (isMasterAdmin || hasBetaLicense) {
                        return "✨ **MASTER ACCESS ACTIVE** ✨\n\nGreetings, Master Troy! I'm your AI Assistant with full capabilities! Ask me anything - code generation, debugging, explanations, or to build complete applications. What shall we create?";
                    }
                    return "Hello! I'm in demo mode. I can help with code templates, explanations, and project suggestions. Ask me to build a todo app, calculator, or contact form!";
                }
                
                // Check if Master Admin or Beta Tester for advanced queries
                const isMasterAdmin = localStorage.getItem('master_admin') === 'TROY_WALKER_2026';
                const hasBetaLicense = localStorage.getItem('beta_license') === 'active';
                
                // For Master Admin/Beta: Try to give intelligent responses to any query
                if (isMasterAdmin || hasBetaLicense) {
                    // Smart responses based on keywords
                    if (msg.includes('javascript') || msg.includes('function') || msg.includes('code')) {
                        return "I can help you with JavaScript! What would you like to build? I can create functions, classes, APIs, or full applications. Just describe what you need.";
                    }
                    if (msg.includes('python')) {
                        return "I can help with Python code! What are you trying to build? Scripts, APIs, data processing, or something else?";
                    }
                    if (msg.includes('css') || msg.includes('style') || msg.includes('design')) {
                        return "I can help with CSS and styling! Need help with layouts, animations, responsive design, or Tailwind classes?";
                    }
                    if (msg.includes('api') || msg.includes('fetch') || msg.includes('request')) {
                        return "I can help with API integration! Need help with fetch requests, authentication, webhooks, or REST APIs?";
                    }
                    if (msg.includes('debug') || msg.includes('error') || msg.includes('fix')) {
                        return "I can help debug! Share your code or describe the error, and I'll help you fix it.";
                    }
                    
                    // Generic helpful response for other queries
                    return `I'm analyzing your request: "${message}"\n\nI can help with:\n• Writing code (JavaScript, Python, HTML/CSS)\n• Debugging and fixing errors\n• Building complete applications\n• Explaining concepts\n• Optimizing performance\n\nCould you provide more details about what you'd like me to help with?`;
                }
                
                return "I'm in demo mode. Upgrade to AI Pro for full capabilities! I can help with code templates, explanations, and project suggestions.";
            },
            
            // Real API integration with multi-key support
            async callAPI(message, context) {
                const provider = AlienAI.config.provider;
                
                // Get the correct API key based on provider
                let apiKey = '';
                if (provider === 'openai') {
                    // Smart OpenAI key selection
                    apiKey = AlienAI.getOpenAIKey(context.app || 'alien');
                    if (!apiKey) {
                        return `⚙️ Please configure at least one OpenAI API key in settings.`;
                    }
                    
                    // Auto-detect test keys and route to demo mode
                    if (apiKey.includes('demo-key') || apiKey.includes('TEST_')) {
                        console.log('🧪 Test key detected - using enhanced demo mode for unlimited testing');
                        return await AlienAI.enhancedDemoMode(message, context);
                    }
                } else if (provider === 'claude') {
                    apiKey = localStorage.getItem('claude_api_key') || '';
                } else if (provider === 'gemini') {
                    apiKey = localStorage.getItem('gemini_api_key') || '';
                }
                
                if (!apiKey) {
                    return `⚙️ Please configure your ${provider.toUpperCase()} API key in settings to use this provider.`;
                }
                
                try {
                    if (provider === 'openai') {
                        const result = await AlienAI.callOpenAI(message, apiKey);
                        AlienAI.trackAPICall(apiKey); // Track usage
                        return result;
                    } else if (provider === 'claude') {
                        return await AlienAI.callClaude(message, apiKey);
                    } else if (provider === 'gemini') {
                        return await AlienAI.callGemini(message, apiKey);
                    }
                } catch (error) {
                    // If OpenAI fails and we have multiple keys, try fallback
                    if (provider === 'openai' && error.message.includes('rate') || error.message.includes('429')) {
                        console.log('Rate limit hit, trying fallback key...');
                        const fallbackKey = AlienAI.getFallbackKey(apiKey);
                        if (fallbackKey) {
                            try {
                                const result = await AlienAI.callOpenAI(message, fallbackKey);
                                AlienAI.trackAPICall(fallbackKey);
                                return result;
                            } catch (fallbackError) {
                                return `API Error: All keys exhausted. ${fallbackError.message}`;
                            }
                        }
                    }
                    return `API Error: ${error.message}. Check your API key and try again.`;
                }
            },
            
            // Smart key selection for OpenAI
            getOpenAIKey(appName = 'index.html') {
                // Use PAPI Key Loader for centralized key management
                if (typeof PAPI !== 'undefined') {
                    const key = PAPI.loadKey(appName, 'openai');
                    if (key) return key;
                }
                
                // Fallback to old method if PAPI not available
                const assignment = localStorage.getItem(`assign-${appName}`) || 'auto';
                
                // If specific key assigned, use it
                if (assignment !== 'auto') {
                    const keyNum = assignment.replace('key', '');
                    const key = localStorage.getItem(`openai_api_key${keyNum}`);
                    if (key) return key;
                }
                
                // Auto-rotate: get next available key
                const lastUsed = parseInt(localStorage.getItem('last_openai_key') || '0');
                for (let i = 1; i <= 4; i++) {
                    const keyIndex = ((lastUsed + i - 1) % 4) + 1;
                    const key = localStorage.getItem(`openai_api_key${keyIndex}`);
                    if (key) {
                        localStorage.setItem('last_openai_key', keyIndex.toString());
                        return key;
                    }
                }
                
                return null;
            },
            
            // Get fallback key if primary fails
            getFallbackKey(usedKey) {
                for (let i = 1; i <= 4; i++) {
                    const key = localStorage.getItem(`openai_api_key${i}`);
                    if (key && key !== usedKey) {
                        return key;
                    }
                }
                return null;
            },
            
            // Track API usage
            trackAPICall(apiKey) {
                const totalCalls = parseInt(localStorage.getItem('total_api_calls') || '0');
                localStorage.setItem('total_api_calls', (totalCalls + 1).toString());
                
                // Track per-key usage
                for (let i = 1; i <= 4; i++) {
                    const key = localStorage.getItem(`openai_api_key${i}`);
                    if (key === apiKey) {
                        const keyUsage = parseInt(localStorage.getItem(`key${i}_usage`) || '0');
                        localStorage.setItem(`key${i}_usage`, (keyUsage + 1).toString());
                        break;
                    }
                }
            },
            
            async callOpenAI(message, apiKey) {
                // Detect test keys and use demo mode instead
                if (!apiKey || apiKey.includes('demo-key') || apiKey.includes('TEST_')) {
                    console.log('🧪 Test key detected - using enhanced demo mode');
                    return await AlienAI.enhancedDemoMode(message, {});
                }
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4',
                        messages: [
                            {role: 'system', content: 'You are an expert code generator and programming assistant. Help users build apps, explain concepts, and write clean code.'},
                            ...AlienAI.conversationHistory.slice(-5),
                            {role: 'user', content: message}
                        ],
                        temperature: AlienAI.config.temperature,
                        max_tokens: AlienAI.config.maxTokens
                    })
                });
                
                const data = await response.json();
                
                // Check for errors
                if (!response.ok || data.error) {
                    const errorMsg = data.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid API response format');
                }
                
                return data.choices[0].message.content;
            },
            
            async callClaude(message, apiKey) {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-3-5-sonnet-20241022',
                        max_tokens: AlienAI.config.maxTokens,
                        messages: [
                            ...AlienAI.conversationHistory.slice(-5).map(m => ({role: m.role, content: m.content})),
                            {role: 'user', content: message}
                        ]
                    })
                });
                
                const data = await response.json();
                
                // Check for errors
                if (!response.ok || data.error) {
                    const errorMsg = data.error?.message || `HTTP ${response.status}: ${response.statusText}`;
                    throw new Error(errorMsg);
                }
                
                if (!data.content || !data.content[0] || !data.content[0].text) {
                    throw new Error('Invalid API response format');
                }
                
                return data.content[0].text;
            },
            
            async callGemini(message, apiKey) {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        contents: [{parts: [{text: message}]}]
                    })
                });
                
                const data = await response.json();
                return data.candidates[0].content.parts[0].text;
            },
            
            // Code templates
            templates: {
                todoApp: () => {
                    return "Here's a complete Todo App with HTML, CSS, and JavaScript. Upgrade to AI Pro for the full code!";
                },
                
                calculator: () => {
                    return "Here's a functional Calculator app. Upgrade to AI Pro for the complete code!";
                },
                
                contactForm: () => {
                    return "Here's a Contact Form with validation:\n\n```html\n[Contact form template with email validation]\n```\n\nUpgrade to AI Pro for fully custom forms!";
                },
                
                dashboard: () => {
                    return "Here's a Dashboard template:\n\n```html\n[Dashboard with charts and widgets]\n```\n\nUpgrade to AI Pro for custom dashboards!";
                }
            },
            
            explainConcept: (question) => {
                if (question.includes('javascript')) {
                    return "JavaScript is a programming language that runs in browsers. It makes websites interactive. Key concepts: variables, functions, events, DOM manipulation. Want a specific example?";
                } else if (question.includes('html')) {
                    return "HTML structures web pages using tags like <div>, <p>, <button>. Each tag has a purpose. HTML is the skeleton, CSS is the skin, JavaScript is the brain.";
                } else if (question.includes('css')) {
                    return "CSS styles your HTML. Use selectors to target elements and properties to change appearance. Example: 'button { background: blue; }' makes buttons blue.";
                }
                return "I can explain JavaScript, HTML, CSS, APIs, and more. Ask me about a specific topic!";
            },
            
            recommendProject: () => {
                const projects = AlienAI.userProfile.projects;
                if (projects.length === 0) {
                    return "For beginners, I recommend starting with: 1) Todo List, 2) Calculator, 3) Simple Form. Which interests you?";
                } else {
                    return `Based on your ${projects.length} past projects, try building: a Weather App, a Note-taking system, or a Portfolio website!`;
                }
            },
            
            // Learning system
            learn: (userMsg, aiResponse) => {
                // Track what user builds
                if (userMsg.toLowerCase().includes('build') || userMsg.toLowerCase().includes('create')) {
                    AlienAI.userProfile.projects.push({
                        request: userMsg,
                        timestamp: Date.now()
                    });
                    localStorage.setItem('user_profile', JSON.stringify(AlienAI.userProfile));
                }
            },
            
            saveHistory: () => {
                // Keep last 20 messages
                if (AlienAI.conversationHistory.length > 20) {
                    AlienAI.conversationHistory = AlienAI.conversationHistory.slice(-20);
                }
                localStorage.setItem('ai_history', JSON.stringify(AlienAI.conversationHistory));
            },
            
            clearHistory: () => {
                AlienAI.conversationHistory = [];
                localStorage.removeItem('ai_history');
            },
            
            // Settings UI helper
            showSettings: () => {
                const currentProvider = AlienAI.config.provider;
                const hasKey = AlienAI.config.apiKey ? '✓ Configured' : '✗ Not set';
                
                addChat('ai', `Current AI Mode: ${currentProvider.toUpperCase()}\nAPI Key: ${hasKey}\n\nTo configure, use commands:\n- "set api openai"\n- "set key YOUR_KEY_HERE"\n\nOr upgrade to AI Pro for managed AI!`);
            }
        };

        async function processCommand(cmd) {
            const c = cmd.toLowerCase();
            
            // AI Settings commands
            if (c.startsWith('set api')) {
                const provider = c.split(' ')[2];
                if (['openai', 'claude', 'gemini', 'demo'].includes(provider)) {
                    AlienAI.config.provider = provider;
                    localStorage.setItem('ai_provider', provider);
                    addChat('ai', `AI provider set to: ${provider.toUpperCase()}`);
                } else {
                    addChat('ai', 'Available providers: openai, claude, gemini, demo');
                }
                return;
            }
            
            if (c.startsWith('set key')) {
                const key = cmd.split(' ').slice(2).join(' ');
                AlienAI.config.apiKey = key;
                localStorage.setItem('ai_api_key', key);
                addChat('ai', 'API key configured ✓');
                return;
            }
            
            if (c === 'ai settings' || c === 'settings') {
                AlienAI.showSettings();
                return;
            }
            
            if (c === 'clear history') {
                AlienAI.clearHistory();
                addChat('ai', 'Conversation history cleared.');
                return;
            }
            
            // Check for LEARNING command first
            if (c.startsWith("learn")) {
                const parts = c.split(" as ");
                if (parts.length === 2) {
                    const trigger = parts[0].replace("learn", "").trim();
                    const actionName = parts[1].trim();
                    
                    let mappedAction = null;
                    if (actionName.includes("generate") || actionName.includes("key")) mappedAction = "genKey";
                    else if (actionName.includes("rf") || actionName.includes("scan")) mappedAction = "calcRF";
                    else if (actionName.includes("repair")) mappedAction = "repairCode";
                    else if (actionName.includes("alien")) mappedAction = "navAlien";
                    
                    if (mappedAction) {
                        MemoryModule.indicateLearning(true);
                        MemoryModule.save(trigger, mappedAction);
                        setTimeout(() => {
                            addChat('ai', `Neural pathway established. I will now run '${actionName}' when you say '${trigger}'.`);
                            MemoryModule.indicateLearning(false);
                        }, 1500);
                        return;
                    }
                }
            }

            // Check MEMORY for learned triggers
            const learnedAction = MemoryModule.recall(c);
            if (learnedAction) {
                if (learnedAction === "genKey") { nav('security'); actions.genKey(); addChat('ai', "Executing learned protocol: Key Generated."); return; }
                if (learnedAction === "calcRF") { nav('rf'); actions.calcRF(); addChat('ai', "Executing learned protocol: RF Scanned."); return; }
                if (learnedAction === "repairCode") { nav('dev'); addChat('ai', "Executing learned protocol: Dev Console Ready."); return; }
            }

            // Standard Hardcoded Actions (Quick responses)
            if(c.includes('generate') && c.includes('key')) { 
                nav('security'); 
                const k = actions.genKey(); 
                addChat('ai', `Generated new key ending in ...${k.slice(-4)}`, ['Copy Key', 'Rotate Again']); 
                return;
            }
            else if(c.includes('rf') || (c.includes('scan') && !c.includes('build') && !c.includes('create'))) { 
                nav('rf'); 
                const val = actions.calcRF(); 
                addChat('ai', `RF Analysis: Potential yield is ${val.toFixed(2)} µW.`, ['Increase Distance', 'Max Power']); 
                return;
            }
            else if(c.includes('repair') && c.includes('code')) { 
                nav('dev'); 
                addChat('ai', "Dev Console ready. Paste code to repair.", ['Clear Editor']); 
                return;
            }
            else if(c.includes('home') || c.includes('dashboard')) { 
                nav('home'); 
                addChat('ai', "Welcome back to Overview."); 
                return;
            }
            // Test commands for spaceship animations
            else if(c === 'test purchase' || c === 'test delivery') {
                actions.buyApp();
                return;
            }
            else if(c === 'test takeoff' || c === 'launch ship') {
                SpaceshipController.triggerTakeoff();
                addChat('ai', "🚀 Initiating takeoff sequence...");
                return;
            }
            else if(c === 'show alien' || c === 'alien appear') {
                SpaceshipController.showAlien();
                addChat('ai', "👽 Alien pilot activated.");
                return;
            }
            else if(c === 'hide alien') {
                SpaceshipController.hideAlien();
                addChat('ai', "Alien pilot concealed.");
                return;
            }
            else if(c === 'position alien' || c === 'adjust alien' || c === 'move alien') {
                actions.positionAlien();
                addChat('ai', "🎯 Positioning controls activated. Adjust alien placement.");
                return;
            }
            else if(c === 'customize' || c === 'appearance' || c === 'theme' || c === 'change theme') {
                openAppearancePanel();
                addChat('ai', "🎨 Appearance controls activated! Explore visual customization options and learn CSS properties.");
                return;
            }
            else if(c === 'help' || c === 'commands' || c === 'what can you do') {
                addChat('ai', `🚀 **PAPI Capabilities:**\n\n📦 **Apps & Features:**\n• Type "apps" to browse marketplace\n• "generate key" for security tokens\n• "scan rf" for frequency analysis\n• "repair code" for dev tools\n\n🎨 **Customization:**\n• "customize" - Visual theme controls\n• "position alien" - Adjust pilot placement\n• Learn CSS, animations & graphics!\n\n🎬 **Animations:**\n• "show alien" / "hide alien"\n• "test purchase" - Full delivery sequence\n• "launch ship" - Takeoff animation\n\n💬 Ask me anything about coding, web development, or building apps!`);
                return;
            }
            
            // AI-Powered responses for everything else
            addChat('ai', '🧠 Thinking...');
            
            try {
                // Check trial requests before making AI call (optional)
                if (window.alienTrialManager) {
                    const canProceed = window.alienTrialManager.trackRequest();
                    if (!canProceed) {
                        // Remove "thinking" message
                        const feed = document.getElementById('chat-feed');
                        if (feed.lastChild) feed.removeChild(feed.lastChild);
                        return; // Request blocked by trial system
                    }
                }
                
                const result = await AlienAI.ask(cmd);
                
                // Remove "thinking" message
                const feed = document.getElementById('chat-feed');
                if (feed.lastChild) feed.removeChild(feed.lastChild);
                
                if (result.needsUpgrade) {
                    addChat('ai', result.response, ['Upgrade Now', 'View Pricing']);
                } else {
                    addChat('ai', result.response);
                }
            } catch (error) {
                addChat('ai', `Error: ${error.message}. Try: "Generate Key", "Scan RF", or ask me to build something!`);
            }
        }

        function toggleVoice() {
            state.voiceActive = !state.voiceActive;
            const btn = document.getElementById('voice-toggle');
            const icon = document.getElementById('voice-icon');
            const txt = document.getElementById('voice-text');
            if(state.voiceActive) {
                icon.className = "fa-solid fa-volume-high text-cyan-400";
                txt.innerText = "Voice On";
                txt.className = "hidden md:block text-cyan-400";
            } else {
                icon.className = "fa-solid fa-volume-xmark";
                txt.innerText = "Voice Off";
                txt.className = "hidden md:block";
                window.speechSynthesis.cancel();
            }
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();
            const v = voices.find(v => v.name.includes("Google") || v.name.includes("Samantha"));
            if(v) u.voice = v;
            u.pitch = 1;
            u.rate = 1;
            window.speechSynthesis.speak(u);
        }

        function initSpeech() {
            if ('webkitSpeechRecognition' in window) {
                const SR = window.webkitSpeechRecognition;
                state.recognition = new SR();
                state.recognition.continuous = false;
                state.recognition.interimResults = true; // Show text as you speak
                
                state.recognition.onresult = (e) => {
                    const input = document.getElementById('cmd-input');
                    const transcript = e.results[0][0].transcript;
                    
                    // Show the text in the input box
                    input.value = transcript;
                    
                    // If final result, send the command
                    if (e.results[0].isFinal) {
                        setTimeout(() => {
                            actions.sendCmd();
                            actions.toggleMic();
                        }, 100);
                    }
                };
                
                state.recognition.onend = () => { 
                    document.getElementById('mic-btn').classList.remove('mic-active'); 
                };
                
                state.recognition.onerror = (e) => {
                    console.log('Speech recognition error:', e.error);
                    document.getElementById('mic-btn').classList.remove('mic-active');
                };
            }
        }

        // Setup Carousel Interaction
        // Removed carousel hover listeners - apps now in dropdown menu

        setInterval(() => {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString();
        }, 1000);

        actions.genKey();
        actions.calcRF();
        
        // Initialize Spaceship Controller
        SpaceshipController.init();
        
        // Initialize trial manager for Alien AI (optional - app works without it)
        try {
            if (window.TrialManager) {
                window.alienTrialManager = new TrialManager('alien', false); // false = chat action
                window.alienTrialManager.addRequestCounter();
                
                // After trial counter is added, register it with LayoutController
                setTimeout(() => {
                    if (window.LayoutController && document.getElementById('trial-counter')) {
                        LayoutController.registerElement('trial-counter', 'Trial Counter', {
                            minWidth: 150,
                            minHeight: 80,
                            defaultPos: { top: 20, right: 20, left: 'auto', bottom: 'auto', width: 200, height: 90 }
                        });
                    }
                }, 1000);
            }
        } catch (error) {
            console.log('Trial system not available, running in unlimited mode');
        }
        
        // Initialize Layout Controller
        setTimeout(() => {
            LayoutController.init();
        }, 500);
        
        document.getElementById('cmd-input').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') actions.sendCmd();
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('appsMenu');
            const button = e.target.closest('button[onclick="actions.toggleAppsMenu()"]');
            
            // Don't close if clicking a link inside the menu
            const isMenuLink = e.target.closest('#appsMenu a');
            
            if (!button && !menu.contains(e.target) && !isMenuLink) {
                menu.classList.add('hidden');
            }
        });
        
        // Terms of Service Functions
        function checkTOSAcceptance() {
            const tosAccepted = localStorage.getItem('papi_tos_accepted');
            if (!tosAccepted) {
                showTOSModal();
            }
        }
        
        function showTOSModal() {
            const modal = document.getElementById('tosModal');
            modal.style.display = 'flex';
            
            // Enable accept button when checkbox is checked
            const checkbox = document.getElementById('tosCheckbox');
            const acceptBtn = document.getElementById('acceptButton');
            
            checkbox.addEventListener('change', () => {
                acceptBtn.disabled = !checkbox.checked;
            });
        }
        
        function acceptTOS() {
            const checkbox = document.getElementById('tosCheckbox');
            if (!checkbox.checked) {
                alert('Please check the box to accept the Terms of Service.');
                return;
            }
            
            // Store acceptance with timestamp
            localStorage.setItem('papi_tos_accepted', 'true');
            localStorage.setItem('papi_tos_accepted_date', new Date().toISOString());
            
            // Hide modal
            document.getElementById('tosModal').style.display = 'none';
            
            // Show welcome message
            addChat('ai', '✅ Welcome to PAPI Central! Terms accepted. You now have access to all applications.');
        }
        
        function declineTOS() {
            if (confirm('You must accept the Terms of Service to use PAPI Central. Are you sure you want to decline and exit?')) {
                // Redirect away or show message
                document.body.innerHTML = `
                    <div class="flex items-center justify-center h-screen bg-gray-900 text-white text-center p-8">
                        <div>
                            <i class="fas fa-times-circle text-6xl text-red-400 mb-4"></i>
                            <h1 class="text-3xl font-bold mb-4">Terms Declined</h1>
                            <p class="text-gray-400 mb-6">You must accept the Terms of Service to use PAPI Central.</p>
                            <button onclick="location.reload()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg">
                                Return & Accept
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Check for Stripe payment success on page load
        function checkStripeReturn() {
            const urlParams = new URLSearchParams(window.location.search);
            const success = urlParams.get('success');
            const sessionId = urlParams.get('session_id');
            
            if (success === 'true' && sessionId) {
                // Payment successful! Navigate to Alien AI and trigger delivery
                console.log('Payment successful! Session ID:', sessionId);
                
                // Clean URL (remove query parameters)
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                
                // Navigate to Alien AI view
                nav('alien');
                
                // Wait a moment for view to render, then trigger delivery animation
                setTimeout(() => {
                    actions.buyApp();
                }, 500);
            }
        }

        // Run checks on page load
        window.addEventListener('DOMContentLoaded', () => {
            checkTOSAcceptance();
            checkStripeReturn();
            showWelcomeForNewUsers();
        });
        
        // --- Alien Positioning Functions ---
        function updateAlienPosition() {
            const alien = document.querySelector('.alien-pilot');
            if (!alien) return;
            
            const top = document.getElementById('alien-top').value;
            const scale = document.getElementById('alien-scale').value;
            const rotate = document.getElementById('alien-rotate').value;
            const left = document.getElementById('alien-left').value;
            
            // Update display values
            document.getElementById('alien-top-val').textContent = `${top}px`;
            document.getElementById('alien-scale-val').textContent = scale;
            document.getElementById('alien-rotate-val').textContent = `${rotate}°`;
            document.getElementById('alien-left-val').textContent = `${left}%`;
            
            // Apply transformations
            alien.style.top = `${top}px`;
            alien.style.left = `${left}%`;
            alien.style.transform = `translateX(-50%) translateZ(50px) scale(${scale}) rotate(${rotate}deg)`;
        }
        
        function updateAlienPositionDisplay() {
            const alien = document.querySelector('.alien-pilot');
            if (!alien) return;
            
            // Get current values from alien or use defaults
            const currentTop = parseInt(alien.style.top) || -75;
            const currentLeft = parseInt(alien.style.left) || 50;
            
            // Extract scale and rotation from transform if exists
            let currentScale = 1.0;
            let currentRotate = 0;
            
            const transform = alien.style.transform;
            if (transform) {
                const scaleMatch = transform.match(/scale\(([0-9.]+)\)/);
                const rotateMatch = transform.match(/rotate\((-?[0-9.]+)deg\)/);
                if (scaleMatch) currentScale = parseFloat(scaleMatch[1]);
                if (rotateMatch) currentRotate = parseFloat(rotateMatch[1]);
            }
            
            // Set slider values
            document.getElementById('alien-top').value = currentTop;
            document.getElementById('alien-scale').value = currentScale;
            document.getElementById('alien-rotate').value = currentRotate;
            document.getElementById('alien-left').value = currentLeft;
            
            // Update display
            updateAlienPosition();
        }
        
        function resetAlienPosition() {
            document.getElementById('alien-top').value = -75;
            document.getElementById('alien-scale').value = 1.0;
            document.getElementById('alien-rotate').value = 0;
            document.getElementById('alien-left').value = 50;
            updateAlienPosition();
            addChat('ai', 'Alien position reset to defaults.');
        }
        
        function lockAlienPosition() {
            const top = document.getElementById('alien-top').value;
            const scale = document.getElementById('alien-scale').value;
            const rotate = document.getElementById('alien-rotate').value;
            const left = document.getElementById('alien-left').value;
            
            // Save to localStorage
            localStorage.setItem('alien_position', JSON.stringify({
                top: top,
                scale: scale,
                rotate: rotate,
                left: left
            }));
            
            addChat('ai', `✓ Alien position locked!\nTop: ${top}px | Scale: ${scale} | Rotation: ${rotate}° | Position: ${left}%`);
            
            // Close panel
            document.getElementById('alien-position-controls').classList.add('hidden');
            
            console.log('🔒 Alien position saved:', { top, scale, rotate, left });
        }
        
        // Load saved alien position on page load
        function loadSavedAlienPosition() {
            const saved = localStorage.getItem('alien_position');
            if (saved) {
                const pos = JSON.parse(saved);
                const alien = document.querySelector('.alien-pilot');
                if (alien) {
                    alien.style.top = `${pos.top}px`;
                    alien.style.left = `${pos.left}%`;
                    alien.style.transform = `translateX(-50%) translateZ(50px) scale(${pos.scale}) rotate(${pos.rotate}deg)`;
                    console.log('📍 Loaded saved alien position:', pos);
                }
            }
        }
        
        // Apply saved position after DOM loads
        setTimeout(loadSavedAlienPosition, 100);
        
        // --- Appearance Customization Functions ---
        
        function openAppearancePanel() {
            const panel = document.getElementById('appearance-controls');
            panel.classList.remove('hidden');
            loadSavedAppearance();
        }
        
        function closeAppearancePanel() {
            document.getElementById('appearance-controls').classList.add('hidden');
        }
        
        function changeBackground() {
            const theme = document.getElementById('bg-theme').value;
            const body = document.body;
            
            const backgrounds = {
                space: 'url(https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=2000&auto=format&fit=crop)',
                nebula: 'url(https://images.unsplash.com/photo-1462331940025-496dfbfc7564?q=80&w=2000&auto=format&fit=crop)',
                stars: 'url(https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=80&w=2000&auto=format&fit=crop)',
                earth: 'url(https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2000&auto=format&fit=crop)',
                mars: 'url(https://images.unsplash.com/photo-1614732414444-096e5f1122d5?q=80&w=2000&auto=format&fit=crop)',
                abstract: 'linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 100%)',
                matrix: 'linear-gradient(180deg, #000000 0%, #001a00 100%)',
                solid: 'linear-gradient(180deg, #050a14 0%, #0a1428 100%)'
            };
            
            body.style.backgroundImage = backgrounds[theme] || backgrounds.space;
            localStorage.setItem('bg_theme', theme);
        }
        
        function updateOverlay() {
            const opacity = document.getElementById('overlay-opacity').value;
            document.getElementById('overlay-val').textContent = opacity + '%';
            
            const overlay = document.querySelector('body::before') || document.body;
            document.documentElement.style.setProperty('--overlay-opacity', opacity / 100);
            
            // Update via CSS variable or direct style
            const style = document.createElement('style');
            style.id = 'overlay-style';
            const existing = document.getElementById('overlay-style');
            if (existing) existing.remove();
            
            style.textContent = `body::before { background: rgba(5, 10, 20, ${opacity / 100}) !important; }`;
            document.head.appendChild(style);
            
            localStorage.setItem('overlay_opacity', opacity);
        }
        
        let shootingStarInterval = null;
        
        function toggleShootingStars() {
            const enabled = document.getElementById('shooting-stars').checked;
            
            if (enabled) {
                startShootingStars();
            } else {
                stopShootingStars();
            }
            
            localStorage.setItem('shooting_stars', enabled);
        }
        
        function startShootingStars() {
            stopShootingStars(); // Clear any existing interval
            
            const frequency = parseInt(document.getElementById('star-frequency').value) * 1000; // Convert to ms
            
            // Add shooting star styles if not exists
            if (!document.getElementById('shooting-star-styles')) {
                const style = document.createElement('style');
                style.id = 'shooting-star-styles';
                style.textContent = `
                    .shooting-star {
                        position: fixed;
                        width: var(--star-size, 20px);
                        height: var(--star-size, 20px);
                        pointer-events: none;
                        z-index: 0;
                    }
                    
                    /* Star dot hidden - only trail visible */
                    .shooting-star::before {
                        content: '';
                        display: none;
                        opacity: 0;
                    }
                    
                    /* Glowing trail only */
                    .shooting-star::after {
                        content: '';
                        position: absolute;
                        right: calc(var(--star-size, 14px) * 0.5);
                        top: 50%;
                        transform: translateY(-50%) translateX(50%) rotate(var(--trail-rotation, 0deg));
                        transform-origin: right center;
                        width: 0;
                        height: 3px;
                        background: linear-gradient(to left, var(--trail-color, rgba(100,200,255,0.9)), transparent);
                        box-shadow: 0 0 12px var(--trail-color, rgba(100,200,255,0.7));
                        animation: trail var(--star-speed, 1.0s) ease-out forwards;
                    }
                    
                    @keyframes trail {
                        0% { width: 0; opacity: 1; }
                        50% { width: 120px; opacity: 1; }
                        100% { width: 200px; opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // Function to create a single shooting star
            const createStar = () => {
                const scene = document.querySelector('.scene') || document.body;
                const star = document.createElement('div');
                star.className = 'shooting-star';
                
                // Get user settings
                const speed = parseFloat(document.getElementById('star-speed').value);
                const direction = document.getElementById('star-direction').value;
                const size = parseInt(document.getElementById('star-size').value);
                
                // Direction configurations
                const directions = {
                    'horizontal': { startY: 10 + Math.random() * 70, endX: 1200, endY: 0, trailRotation: 0 },
                    'diagonal-up': { startY: 50 + Math.random() * 40, endX: 1000, endY: -300, trailRotation: -20 },
                    'diagonal-down': { startY: 10 + Math.random() * 40, endX: 1000, endY: 300, trailRotation: 20 },
                    'steep-up': { startY: 60 + Math.random() * 30, endX: 600, endY: -500, trailRotation: -45 },
                    'steep-down': { startY: 10 + Math.random() * 30, endX: 600, endY: 500, trailRotation: 45 }
                };
                
                const dir = directions[direction] || directions['horizontal'];
                
                // Random starting position (left side of screen)
                star.style.left = '-30px';
                star.style.top = `${dir.startY}%`;
                
                // Get user-selected trail color or use default
                const trailColor = localStorage.getItem('trail_color') || 'rgba(100, 200, 255, 0.9)';
                
                star.style.setProperty('--star-speed', `${speed}s`);
                star.style.setProperty('--star-size', `${size}px`);
                star.style.setProperty('--trail-color', trailColor);
                star.style.setProperty('--trail-rotation', `${dir.trailRotation}deg`);
                star.style.animation = `shootStar${direction} ${speed}s ease-out forwards`;
                
                // Create dynamic animation for this direction
                const animName = `shootStar${direction}`;
                if (!document.getElementById(animName)) {
                    const animStyle = document.createElement('style');
                    animStyle.id = animName;
                    animStyle.textContent = `
                        @keyframes ${animName} {
                            0% {
                                opacity: 0;
                                transform: translateX(0) translateY(0);
                            }
                            5% {
                                opacity: 1;
                            }
                            95% {
                                opacity: 1;
                            }
                            100% {
                                opacity: 0;
                                transform: translateX(${dir.endX}px) translateY(${dir.endY}px);
                            }
                        }
                    `;
                    document.head.appendChild(animStyle);
                }
                
                scene.appendChild(star);
                
                // Remove star after animation completes
                setTimeout(() => {
                    star.remove();
                }, speed * 1000);
            };
            
            // Create first star immediately
            createStar();
            
            // Set up interval for subsequent stars
            shootingStarInterval = setInterval(createStar, frequency);
        }
        
        function stopShootingStars() {
            if (shootingStarInterval) {
                clearInterval(shootingStarInterval);
                shootingStarInterval = null;
            }
            
            // Remove all existing stars
            const stars = document.querySelectorAll('.shooting-star');
            stars.forEach(star => star.remove());
        }
        
        function updateStarFrequency() {
            const freq = document.getElementById('star-frequency').value;
            document.getElementById('star-freq-val').textContent = freq + 's';
            
            if (document.getElementById('shooting-stars').checked) {
                startShootingStars(); // Restart with new frequency
            }
            
            localStorage.setItem('star_frequency', freq);
        }
        
        function updateStarSpeed() {
            const speed = document.getElementById('star-speed').value;
            document.getElementById('star-speed-val').textContent = speed + 's';
            
            if (document.getElementById('shooting-stars').checked) {
                startShootingStars(); // Restart with new speed
            }
            
            localStorage.setItem('star_speed', speed);
        }
        
        function updateStarDirection() {
            const direction = document.getElementById('star-direction').value;
            const directionNames = {
                'horizontal': 'Horizontal',
                'diagonal-up': 'Diagonal Up',
                'diagonal-down': 'Diagonal Down',
                'steep-up': 'Steep Up',
                'steep-down': 'Steep Down'
            };
            document.getElementById('star-dir-val').textContent = directionNames[direction];
            
            if (document.getElementById('shooting-stars').checked) {
                startShootingStars(); // Restart with new direction
            }
            
            localStorage.setItem('star_direction', direction);
        }
        
        function updateStarSize() {
            const size = document.getElementById('star-size').value;
            document.getElementById('star-size-val').textContent = size + 'px';
            
            // Size updates will apply to next star spawned
            localStorage.setItem('star_size', size);
        }
        
        function setTrailColor(color) {
            // Convert hex to rgba for gradient
            const hex = color.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            const rgba = `rgba(${r}, ${g}, ${b}, 0.9)`;
            
            localStorage.setItem('trail_color', rgba);
            
            // Restart shooting stars with new color
            if (document.getElementById('shooting-stars').checked) {
                startShootingStars();
            }
            
            // Visual feedback
            playSound('success', 0.3);
        }
        
        function updateShipGlow() {
            const glow = document.getElementById('ship-glow').value;
            document.getElementById('glow-val').textContent = glow + '%';
            
            const intensity = glow / 50; // 0-2 multiplier
            
            const style = document.createElement('style');
            style.id = 'ship-glow-style';
            const existing = document.getElementById('ship-glow-style');
            if (existing) existing.remove();
            
            style.textContent = `
                .saucer-core {
                    box-shadow: 
                        0 0 ${30 * intensity}px rgba(0, 242, 234, ${0.3 * intensity}),
                        0 0 ${60 * intensity}px rgba(0, 128, 255, ${0.2 * intensity}),
                        inset 0 0 ${40 * intensity}px rgba(0, 242, 234, ${0.2 * intensity}) !important;
                }
                .saucer-engine {
                    box-shadow: 
                        0 ${20 * intensity}px ${60 * intensity}px rgba(0, 242, 234, ${0.6 * intensity}),
                        0 0 ${40 * intensity}px rgba(0, 242, 234, ${0.4 * intensity}) !important;
                }
            `;
            document.head.appendChild(style);
            
            localStorage.setItem('ship_glow', glow);
        }
        
        function updateHoverSpeed() {
            const speed = document.getElementById('hover-speed').value;
            document.getElementById('hover-speed-val').textContent = speed + 's';
            
            const style = document.createElement('style');
            style.id = 'hover-speed-style';
            const existing = document.getElementById('hover-speed-style');
            if (existing) existing.remove();
            
            style.textContent = `
                .spaceship-container {
                    animation: hoverShip ${speed}s ease-in-out infinite !important;
                }
            `;
            document.head.appendChild(style);
            
            localStorage.setItem('hover_speed', speed);
        }
        
        function changeAlienStyle() {
            const style = document.getElementById('alien-style').value;
            
            const alienColors = {
                classic: '#a8d5ba',
                blue: '#a8c5e8',
                green: '#8bc34a',
                purple: '#ce93d8',
                orange: '#ffab91'
            };
            
            document.documentElement.style.setProperty('--alien-skin', alienColors[style] || alienColors.classic);
            localStorage.setItem('alien_style', style);
            
            addChat('ai', `🎨 Alien appearance changed to ${style} theme!`);
        }
        
        function updateGlassBlur() {
            const blur = document.getElementById('glass-blur').value;
            document.getElementById('blur-val').textContent = blur + 'px';
            
            const style = document.createElement('style');
            style.id = 'glass-blur-style';
            const existing = document.getElementById('glass-blur-style');
            if (existing) existing.remove();
            
            style.textContent = `
                .glass-panel {
                    backdrop-filter: blur(${blur}px) !important;
                }
            `;
            document.head.appendChild(style);
            
            localStorage.setItem('glass_blur', blur);
        }
        
        function resetAppearance() {
            // Reset all controls to defaults
            document.getElementById('bg-theme').value = 'space';
            document.getElementById('overlay-opacity').value = 65;
            document.getElementById('shooting-stars').checked = true;
            document.getElementById('star-frequency').value = 40;
            document.getElementById('star-speed').value = 1.0;
            document.getElementById('star-direction').value = 'horizontal';
            document.getElementById('star-size').value = 14;
            document.getElementById('ship-glow').value = 50;
            document.getElementById('hover-speed').value = 8;
            document.getElementById('alien-style').value = 'classic';
            document.getElementById('glass-blur').value = 20;
            
            // Apply defaults
            changeBackground();
            updateOverlay();
            toggleShootingStars();
            updateStarFrequency();
            updateStarSpeed();
            updateStarDirection();
            updateStarSize();
            updateShipGlow();
            updateHoverSpeed();
            changeAlienStyle();
            updateGlassBlur();
            
            // Clear localStorage
            ['bg_theme', 'overlay_opacity', 'shooting_stars', 'star_frequency', 'star_speed', 'star_direction', 'star_size', 
             'ship_glow', 'hover_speed', 'alien_style', 'glass_blur'].forEach(key => {
                localStorage.removeItem(key);
            });
            
            addChat('ai', '✨ Appearance reset to defaults!');
        }
        
        function saveAppearance() {
            addChat('ai', '✅ Theme saved! Your customizations will persist across sessions.');
        }
        
        function loadSavedAppearance() {
            // Load saved preferences
            const bgTheme = localStorage.getItem('bg_theme');
            const overlayOpacity = localStorage.getItem('overlay_opacity');
            const shootingStars = localStorage.getItem('shooting_stars');
            const starFreq = localStorage.getItem('star_frequency');
            const starSpeed = localStorage.getItem('star_speed');
            const starDirection = localStorage.getItem('star_direction');
            const starSize = localStorage.getItem('star_size');
            const shipGlow = localStorage.getItem('ship_glow');
            const hoverSpeed = localStorage.getItem('hover_speed');
            const alienStyle = localStorage.getItem('alien_style');
            const glassBlur = localStorage.getItem('glass_blur');
            
            if (bgTheme) {
                document.getElementById('bg-theme').value = bgTheme;
                changeBackground();
            }
            
            if (overlayOpacity) {
                document.getElementById('overlay-opacity').value = overlayOpacity;
                updateOverlay();
            }
            
            if (shootingStars !== null) {
                document.getElementById('shooting-stars').checked = shootingStars === 'true';
                toggleShootingStars();
            }
            
            if (starFreq) {
                document.getElementById('star-frequency').value = starFreq;
                updateStarFrequency();
            }
            
            if (starSpeed) {
                document.getElementById('star-speed').value = starSpeed;
                updateStarSpeed();
            }
            
            if (starDirection) {
                document.getElementById('star-direction').value = starDirection;
                updateStarDirection();
            }
            
            if (starSize) {
                document.getElementById('star-size').value = starSize;
                updateStarSize();
            }
            
            if (shipGlow) {
                document.getElementById('ship-glow').value = shipGlow;
                updateShipGlow();
            }
            
            if (hoverSpeed) {
                document.getElementById('hover-speed').value = hoverSpeed;
                updateHoverSpeed();
            }
            
            if (alienStyle) {
                document.getElementById('alien-style').value = alienStyle;
                changeAlienStyle();
            }
            
            if (glassBlur) {
                document.getElementById('glass-blur').value = glassBlur;
                updateGlassBlur();
            }
        }
        
        // Auto-load appearance on page load
        setTimeout(() => {
            loadSavedAppearance();
            // Initialize shooting stars if enabled
            if (document.getElementById('shooting-stars').checked) {
                startShootingStars();
            }
        }, 200);
        
        // --- Welcome Message for New Users ---
        function showWelcomeForNewUsers() {
            const hasVisited = localStorage.getItem('papi_visited');
            
            if (!hasVisited) {
                // First-time visitor!
                setTimeout(() => {
                    addChat('ai', `👋 **Welcome to PAPI Central!**\n\nI'm your AI assistant. Here's what you can do:\n\n🎨 **Customize Everything:**\n• Type "customize" to change themes, backgrounds, and effects\n• Learn CSS properties like gradients, animations, transforms\n• Position the alien pilot: "position alien"\n\n🚀 **Interactive Features:**\n• "show alien" - Meet your pilot\n• "test purchase" - See full delivery animation\n• "apps" - Browse the marketplace\n\n💡 **Learn While You Play:**\nEvery control teaches you web development:\n• Background images & overlays\n• CSS animations & keyframes\n• Box-shadow & glassmorphism\n• 3D transforms & perspective\n\n📚 **Commands to try:**\n• "help" - Full command list\n• "customize" - Open appearance panel\n• "generate key" - Security tools\n• Ask me anything about coding!\n\nType "customize" to start exploring! 🎨`);
                    
                    localStorage.setItem('papi_visited', 'true');
                    
                    // Show alien briefly as introduction
                    setTimeout(() => {
                        SpaceshipController.showAlien();
                        setTimeout(() => {
                            SpaceshipController.hideAlien();
                        }, 3000);
                    }, 2000);
                }, 1000);
            }
        }
        
        // Add helpful tooltips for new users
        function showFeatureHighlights() {
            const highlights = [
                { selector: '#apps-menu', message: 'Click here to browse apps!' },
                { selector: '#cmd-input', message: 'Type commands like "customize" or "show alien"' },
                { selector: '.spaceship-container', message: 'Drag the spaceship around!' }
            ];
            
            // Could implement tooltip system here
        }
        
        // --- Toggle Chat Feed for Better Customization View ---
        function toggleChatFeed() {
            const chatContainer = document.getElementById('chat-container');
            const toggleBtn = document.getElementById('chat-toggle-btn');
            const btnIcon = toggleBtn.querySelector('i');
            
            if (chatContainer.classList.contains('chat-minimized')) {
                // Expand chat
                chatContainer.classList.remove('chat-minimized');
                btnIcon.className = 'fa-solid fa-minus';
                toggleBtn.title = 'Minimize chat';
                localStorage.setItem('chat_minimized', 'false');
            } else {
                // Minimize chat
                chatContainer.classList.add('chat-minimized');
                btnIcon.className = 'fa-solid fa-plus';
                toggleBtn.title = 'Show chat';
                localStorage.setItem('chat_minimized', 'true');
            }
        }
        
        // Load chat state on page load
        setTimeout(() => {
            const chatMinimized = localStorage.getItem('chat_minimized');
            if (chatMinimized === 'true') {
                const chatContainer = document.getElementById('chat-container');
                const toggleBtn = document.getElementById('chat-toggle-btn');
                const btnIcon = toggleBtn.querySelector('i');
                
                chatContainer.classList.add('chat-minimized');
                btnIcon.className = 'fa-solid fa-plus';
                toggleBtn.title = 'Show chat';
            }
        }, 100);

        // Add Unlock Real AI Button
        function createUnlockAIButton() {
            // Check if real API keys are configured
            const hasRealKeys = localStorage.getItem('openai_api_key1') || 
                               localStorage.getItem('claude_api_key') || 
                               localStorage.getItem('gemini_api_key');
            
            // Only show button if in demo mode
            if (localStorage.getItem('demo_mode') === 'true' && !hasRealKeys) {
                const btn = document.createElement('button');
                btn.className = 'unlock-ai-btn';
                btn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Unlock Real AI';
                btn.onclick = function() {
                    window.open('key-controller.html', '_blank');
                };
                document.body.appendChild(btn);
            }
        }
        
        // Check every 5 seconds if keys were added
        setInterval(() => {
            const hasRealKeys = localStorage.getItem('openai_api_key1') || 
                               localStorage.getItem('claude_api_key') || 
                               localStorage.getItem('gemini_api_key');
            
            const unlockBtn = document.querySelector('.unlock-ai-btn');
            
            if (hasRealKeys && localStorage.getItem('demo_mode') === 'true') {
                localStorage.removeItem('demo_mode');
                if (unlockBtn) unlockBtn.classList.add('hidden');
                console.log('🚀 Real API keys detected! Demo mode disabled. Reload page to activate.');
                
                // Show success message
                if (typeof addChat === 'function') {
                    addChat('ai', '🎉 Real AI keys detected! Reload the page to activate full AI capabilities.');
                }
            }
        }, 5000);
        
        // Create button after page loads
        setTimeout(createUnlockAIButton, 2000);

    </script>
</body>
</html>
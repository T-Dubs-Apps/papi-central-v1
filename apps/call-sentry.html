<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallSentry AI - Intelligent Call Protection</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #121212;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* License Gate */
        .license-gate {
            position: fixed;
            inset: 0;
            background: rgba(18, 18, 18, 0.98);
            backdrop-filter: blur(10px);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .license-gate.hidden {
            display: none;
        }

        .license-prompt {
            background: #1e1e1e;
            border: 2px solid #cf6679;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            text-align: center;
        }

        .lock-icon {
            width: 80px;
            height: 80px;
            background: #cf6679;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: #121212;
        }

        .license-prompt h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #cf6679;
        }

        .license-prompt p {
            color: #b0b0b0;
            margin-bottom: 30px;
        }

        .license-price {
            font-size: 3rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 20px;
        }

        .license-price span {
            font-size: 1rem;
            color: #888;
        }

        .license-btn {
            background: #cf6679;
            color: #fff;
            padding: 15px 40px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
            transition: all 0.3s;
        }

        .license-btn:hover {
            background: #e07788;
            transform: translateY(-2px);
        }

        .back-link {
            display: block;
            color: #888;
            text-decoration: none;
            margin-top: 20px;
        }

        .back-link:hover {
            color: #fff;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .title-section h1 {
            font-size: 2rem;
            color: #03dac6;
            margin-bottom: 5px;
        }

        .title-section p {
            color: #888;
            font-size: 0.9rem;
        }

        .status-badge {
            background: #03dac6;
            color: #121212;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .status-badge i {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .return-btn {
            background: #1e1e1e;
            color: #03dac6;
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: 1px solid #03dac6;
        }

        .return-btn:hover {
            background: #03dac6;
            color: #121212;
        }

        /* Cards */
        .card {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #2a2a2a;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #fff;
        }

        .card-icon {
            font-size: 1.5rem;
            color: #bb86fc;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #03dac6;
        }

        .stat-label {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Analysis Interval */
        .interval-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .interval-btn {
            background: #2a2a2a;
            color: #e0e0e0;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .interval-btn.active {
            background: #03dac6;
            color: #121212;
        }

        .interval-btn:hover {
            background: #03dac6;
            color: #121212;
        }

        /* Test Buttons */
        .test-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .test-btn {
            background: #bb86fc;
            color: #121212;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .test-btn:hover {
            background: #d4a4ff;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: #cf6679;
        }

        .clear-btn:hover {
            background: #e07788;
        }

        /* Call Log */
        .log-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .log-entry {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .log-info {
            flex: 1;
            min-width: 200px;
        }

        .log-number {
            font-weight: 600;
            font-size: 1.1rem;
            color: #fff;
            margin-bottom: 5px;
        }

        .log-type {
            color: #888;
            font-size: 0.85rem;
        }

        .log-action {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .log-action.allowed {
            background: rgba(3, 218, 198, 0.2);
            color: #03dac6;
        }

        .log-action.rejected {
            background: rgba(207, 102, 121, 0.2);
            color: #cf6679;
        }

        .log-time {
            color: #888;
            font-size: 0.85rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* SMS Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: #1e1e1e;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            border: 2px solid #cf6679;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .modal-icon {
            width: 50px;
            height: 50px;
            background: #cf6679;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #121212;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #fff;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .sms-preview {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            color: #e0e0e0;
            font-style: italic;
            margin-top: 15px;
        }

        .modal-close {
            background: #bb86fc;
            color: #121212;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
        }

        .modal-close:hover {
            background: #d4a4ff;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e1e1e;
        }

        ::-webkit-scrollbar-thumb {
            background: #bb86fc;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #d4a4ff;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }

            .title-section h1 {
                font-size: 1.5rem;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
<head>
        <title>Call Sentry</title>
        <link rel="stylesheet" href="../assets/papi-responsive-template.css">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script>
            // Asset preloading
            window.addEventListener('DOMContentLoaded', function() {
                const preloadAssets = [
                    '../assets/alien-font.woff2',
                    '../assets/spaceship.png',
                ];
                preloadAssets.forEach(src => {
                    const link = document.createElement('link');
                    link.rel = 'preload';
                    link.href = src;
                    link.as = src.endsWith('.woff2') ? 'font' : 'image';
                    document.head.appendChild(link);
                });
            });
        </script>
        <style>
            .dark-mode { background: #181a1b; color: #e0e0e0; }
            .light-mode { background: #fff; color: #222; }
            .onboarding-modal { position: fixed; z-index: 1000; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; }
            .onboarding-content { background: #222; color: #fff; padding: 2rem; border-radius: 1rem; max-width: 90vw; max-height: 90vh; overflow: auto; }
            .feedback-modal { position: fixed; z-index: 1001; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; }
            .feedback-content { background: #fff; color: #222; padding: 2rem; border-radius: 1rem; max-width: 90vw; max-height: 90vh; overflow: auto; }
            .ai-feedback { display: flex; align-items: center; gap: 0.5rem; }
            .ai-spinner { width: 1.5em; height: 1.5em; border: 3px solid #ccc; border-top: 3px solid #09f; border-radius: 50%; animation: spin 1s linear infinite; }
            @keyframes spin { 100% { transform: rotate(360deg); } }
        </style>
</head>
        <div class="license-prompt">
            <div class="lock-icon">
                <i class="fa-solid fa-lock"></i>
            </div>
            <h2>CallSentry AI</h2>
            <p>Professional Call Protection & Monitoring System</p>
            <div class="license-price">$14.99<span>/month</span></div>
            <p style="margin-bottom: 20px;">
                âœ“ Automatic Unknown Call Blocking<br>
                âœ“ SMS Auto-Reply System<br>
                âœ“ Real-Time Call Analytics<br>
                âœ“ Complete Call Log History
            </p>
            <a href="PAPI Central.htm" class="license-btn">
                <!-- Universal purchase button: always routes to store for Stripe checkout -->
                <i class="fa-solid fa-shopping-cart"></i> Get License (via Store)
            </a>
            <a href="index.html" class="back-link">
                <i class="fa-solid fa-arrow-left"></i> Return to Ship
            </a>
        </div>
    </div>

    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="title-section">
                <h1><i class="fa-solid fa-shield-halved"></i> CallSentry AI</h1>
                <p>Intelligent Call Protection & Monitoring System</p>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span class="status-badge">
                    <i class="fa-solid fa-circle"></i> ACTIVE
                </span>
                <a href="index.html" class="return-btn">
                    <i class="fa-solid fa-rocket"></i> Return to Ship
                </a>
            </div>
        </div>

        <!-- STATISTICS CARD -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Call Statistics</h2>
                <i class="fa-solid fa-chart-line card-icon"></i>
            </div>
            
            <div class="interval-selector">
                <button class="interval-btn active" onclick="setInterval('daily')">Daily</button>
                <button class="interval-btn" onclick="setInterval('weekly')">Weekly</button>
                <button class="interval-btn" onclick="setInterval('monthly')">Monthly</button>
            </div>

            <div class="stats-grid" style="margin-top: 20px;">
                <div class="stat-box">
                    <div class="stat-value" id="stat-rejected">0</div>
                    <div class="stat-label">Calls Rejected</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-allowed">0</div>
                    <div class="stat-label">Calls Allowed</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-total">0</div>
                    <div class="stat-label">Total Calls</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="stat-sms">0</div>
                    <div class="stat-label">SMS Sent</div>
                </div>
            </div>
        </div>

        <!-- SYSTEM DIAGNOSTICS -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">System Diagnostics</h2>
                <i class="fa-solid fa-wrench card-icon"></i>
            </div>
            
            <div class="test-controls">
                <button class="test-btn" onclick="testKnownContact()">
                    <i class="fa-solid fa-user-check"></i> Test Known Contact
                </button>
                <button class="test-btn" onclick="testUnknownCaller()">
                    <i class="fa-solid fa-user-slash"></i> Test Unknown Caller
                </button>
                <button class="test-btn clear-btn" onclick="clearLogs()">
                    <i class="fa-solid fa-trash"></i> Clear All Logs
                </button>
            </div>
        </div>

        <!-- CALL LOG REGISTRY -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Call Log Registry</h2>
                <i class="fa-solid fa-list card-icon"></i>
            </div>
            
            <div class="log-container" id="logContainer">
                <div class="empty-state">
                    <i class="fa-solid fa-phone"></i>
                    <p>No calls logged yet. Test the system above to see it in action.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- SMS MODAL -->
    <div id="smsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fa-solid fa-comment"></i>
                </div>
                <div>
                    <div class="modal-title">Call Rejected</div>
                    <div style="color: #888; font-size: 0.9rem;">Auto-Reply SMS Sent</div>
                </div>
            </div>
            <div class="modal-body">
                <p style="color: #e0e0e0; margin-bottom: 10px;">
                    <strong>To:</strong> <span id="sms-number"></span>
                </p>
                <div class="sms-preview">
                    "Calls not accepted by unknown callers. Please call from a number that shows your number or Contact info"
                </div>
            </div>
            <button class="modal-close" onclick="closeSMSModal()">Got It</button>
        </div>
    </div>

    <script>
        // --- LICENSE CHECK ---
        function checkLicense() {
            const hasLicense = localStorage.getItem('callsentry_license') === 'active' || 
                             localStorage.getItem('bundle_license') === 'active';
            
            if (!hasLicense) {
                document.getElementById('licenseGate').classList.remove('hidden');
                return false;
            }
            return true;
        }

        window.addEventListener('DOMContentLoaded', () => {
            checkLicense();
            loadLogs();
            updateStats();
        });

        // --- DATA MANAGEMENT ---
        const APP_NAME = "CallSentry_Data";
        let logs = JSON.parse(localStorage.getItem(APP_NAME)) || [];
        let currentInterval = 'daily';

        // Fake "Stored Contacts" for simulation
        const KNOWN_CONTACTS = ["555-0101", "555-0123", "Mom", "Work", "John Doe"];

        function isKnownContact(number) {
            return KNOWN_CONTACTS.some(contact => 
                number.includes(contact) || contact.includes(number)
            );
        }

        // --- CALL PROCESSING ---
        function processCall(number, isKnown) {
            const timestamp = new Date().toLocaleString();
            let action = "";

            if (isKnown) {
                action = "ALLOWED";
                addLog(number, "Known Contact", action, timestamp);
            } else {
                action = "REJECTED";
                showSMSModal(number);
                addLog(number, "Unknown ID", action, timestamp);
            }

            updateStats();
        }

        function addLog(number, type, action, time) {
            const entry = { number, type, action, time, id: Date.now() };
            logs.unshift(entry);
            if(logs.length > 50) logs.pop();
            localStorage.setItem(APP_NAME, JSON.stringify(logs));
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logContainer');
            
            if(logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa-solid fa-phone"></i>
                        <p>No calls logged yet. Test the system above to see it in action.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry">
                    <div class="log-info">
                        <div class="log-number">${log.number}</div>
                        <div class="log-type">${log.type}</div>
                    </div>
                    <span class="log-action ${log.action.toLowerCase()}">${log.action}</span>
                    <div class="log-time">${log.time}</div>
                </div>
            `).join('');
        }

        function updateStats() {
            const getFilteredLogs = () => {
                const now = Date.now();
                const day = 24 * 60 * 60 * 1000;
                
                let cutoff;
                if(currentInterval === 'daily') cutoff = now - day;
                else if(currentInterval === 'weekly') cutoff = now - (7 * day);
                else cutoff = now - (30 * day);

                return logs.filter(log => {
                    const logTime = new Date(log.time).getTime();
                    return logTime >= cutoff;
                });
            };

            const filtered = getFilteredLogs();
            const rejected = filtered.filter(l => l.action === 'REJECTED').length;
            const allowed = filtered.filter(l => l.action === 'ALLOWED').length;
            const total = filtered.length;
            const sms = rejected; // One SMS per rejection

            document.getElementById('stat-rejected').textContent = rejected;
            document.getElementById('stat-allowed').textContent = allowed;
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-sms').textContent = sms;
        }

        // --- INTERVAL SELECTION ---
        function setInterval(interval) {
            currentInterval = interval;
            
            document.querySelectorAll('.interval-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            updateStats();
        }

        // --- TESTING ---
        function testKnownContact() {
            const number = "555-0101"; // Known number
            processCall(number, true);
        }

        function testUnknownCaller() {
            const randomNum = "555-" + Math.floor(Math.random() * 9000 + 1000);
            processCall(randomNum, false);
        }

        function clearLogs() {
            if(confirm('Are you sure you want to clear all logs?')) {
                logs = [];
                localStorage.setItem(APP_NAME, JSON.stringify(logs));
                renderLogs();
                updateStats();
            }
        }

        // --- SMS MODAL ---
        function showSMSModal(number) {
            document.getElementById('sms-number').textContent = number;
            document.getElementById('smsModal').classList.add('show');
        }

        function closeSMSModal() {
            document.getElementById('smsModal').classList.remove('show');
        }

        // Close modal on outside click
        document.getElementById('smsModal').addEventListener('click', (e) => {
            if(e.target.id === 'smsModal') {
                closeSMSModal();
            }
        });

        // --- LOAD ON START ---
        loadLogs();
        function loadLogs() {
            renderLogs();
        }
    </script>
<body>
        <div id="main-app" aria-label="Call Sentry App" tabindex="0">
                <!-- ...existing code... -->
        </div>
        <!-- Onboarding Modal -->
        <div id="onboardingModal" class="onboarding-modal" style="display:none;">
            <div class="onboarding-content" role="dialog" aria-modal="true" aria-labelledby="onboardingTitle">
                <h2 id="onboardingTitle">Welcome to Call Sentry</h2>
                <p>This app helps you manage and secure calls. Use the controls to monitor or block calls. For help, click the help icon or open this guide anytime from the menu.</p>
                <button onclick="closeOnboarding()" aria-label="Close onboarding">Get Started</button>
            </div>
        </div>
        <!-- Feedback Modal -->
        <div id="feedbackModal" class="feedback-modal" style="display:none;">
            <div class="feedback-content" role="dialog" aria-modal="true" aria-labelledby="feedbackTitle">
                <h2 id="feedbackTitle">Send Feedback or Report a Problem</h2>
                <textarea id="feedbackText" rows="5" style="width:100%" aria-label="Feedback"></textarea>
                <button onclick="submitFeedback()">Submit</button>
                <button onclick="closeFeedback()">Cancel</button>
            </div>
        </div>
        <button id="darkModeToggle" aria-label="Toggle dark mode" style="position:fixed;top:1rem;right:1rem;z-index:1100;">ðŸŒ™</button>
        <button id="feedbackBtn" aria-label="Open feedback modal" style="position:fixed;top:1rem;right:4rem;z-index:1100;">ðŸ’¬</button>
        <script>
            // Onboarding
            function showOnboarding() {
                document.getElementById('onboardingModal').style.display = 'flex';
            }
            function closeOnboarding() {
                document.getElementById('onboardingModal').style.display = 'none';
                localStorage.setItem('call_sentry_onboarded', '1');
            }
            if (!localStorage.getItem('call_sentry_onboarded')) showOnboarding();
            // Dark/Light Mode
            const root = document.documentElement;
            function setMode(mode) {
                root.classList.remove('dark-mode', 'light-mode');
                root.classList.add(mode+'-mode');
                localStorage.setItem('call_sentry_mode', mode);
            }
            document.getElementById('darkModeToggle').onclick = function() {
                const mode = root.classList.contains('dark-mode') ? 'light' : 'dark';
                setMode(mode);
            };
            setMode(localStorage.getItem('call_sentry_mode')||'dark');
            // Feedback Modal
            document.getElementById('feedbackBtn').onclick = function() {
                document.getElementById('feedbackModal').style.display = 'flex';
            };
            function closeFeedback() {
                document.getElementById('feedbackModal').style.display = 'none';
            }
            function submitFeedback() {
                const text = document.getElementById('feedbackText').value;
                if (text.length < 5) { alert('Please enter more details.'); return; }
                navigator.clipboard.writeText(text);
                alert('Feedback copied! Please email or paste in support chat.');
                closeFeedback();
            }
            // Accessibility: focus main app
            window.onload = () => { document.getElementById('main-app').focus(); };
        </script>
</body>
